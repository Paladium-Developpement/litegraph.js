var LiteGraph=function(e){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||l(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){if(e){if("string"==typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?h(e,t):void 0}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function u(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=l(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,s=function(){};return{s:s,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,r=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){r=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(r)throw o}}}}var c={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1};function d(){if(performance)return performance.now();if(Date&&Date.now)return Date.now;if(process){var e=process.hrtime();return.001*e[0]+1e-6*e[1]}return(new Date).getTime()}function p(e,t){if(null==e)return null;var n=JSON.parse(JSON.stringify(e));if(!t)return n;for(var i in n)t[i]=n[i];return t}function v(e,t){if(!t.prototype)throw new TypeError("Cannot register a simple object, it must be a class with a prototype");t.type=e,c.debug&&console.log("Node registered: ".concat(e));var n=t.name,i=e.lastIndexOf("/");t.category=e.substr(0,i),t.title||(t.title=n);var s=c.registered_node_types[e];if(s)console.log("replacing node type: ".concat(e));else if(Object.hasOwnProperty.call(t.prototype,"shape")||Object.defineProperty(t.prototype,"shape",{set:function(e){switch(e){case"default":delete this._shape;break;case"box":this._shape=c.BOX_SHAPE;break;case"round":this._shape=c.ROUND_SHAPE;break;case"circle":this._shape=c.CIRCLE_SHAPE;break;case"card":this._shape=c.CARD_SHAPE;break;default:this._shape=e}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(e," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),t.supported_extensions){var o,a=u(t.supported_extensions);try{for(a.s();!(o=a.n()).done;){var r=o.value;r&&r.constructor===String&&(c.node_types_by_file_extension[r.toLowerCase()]=t)}}catch(e){a.e(e)}finally{a.f()}}if(c.registered_node_types[e]=t,t.constructor.name&&(c.Nodes[n]=t),c.onNodeTypeRegistered&&c.onNodeTypeRegistered(e,t),s&&c.onNodeTypeReplaced&&c.onNodeTypeReplaced(e,t,s),t.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(e," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),t.supported_extensions){var l,h=u(t.supported_extensions);try{for(h.s();!(l=h.n()).done;){var d=l.value;d&&d.constructor===String&&(c.node_types_by_file_extension[d.toLowerCase()]=t)}}catch(e){h.e(e)}finally{h.f()}}}function g(e,t){var n=[];for(var i in this.registered_node_types){var s=this.registered_node_types[i];s.filter===t&&(""===e?s.category||n.push(s):s.category===e&&n.push(s))}return this.auto_sort_node_types?n.sort():n}function f(e){var t,n={"":1},i=u(this.registered_node_types);try{for(i.s();!(t=i.n()).done;){var s=t.value;if(s.category&&!s.skip_list){if(s.filter!==e)continue;n[s.category]=1}}}catch(e){i.e(e)}finally{i.f()}var o=[];for(var a in n)o.push(a);return this.auto_sort_node_types?o.sort():o}function _(e){return"".concat(e).replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}function y(e,t){if(!e||!t||e===t||e===c.EVENT&&t===c.ACTION)return!0;if(e=String(e),t=String(t),e=e.toLowerCase(),t=t.toLowerCase(),-1===e.indexOf(",")&&-1===t.indexOf(","))return e===t;for(var n=e.split(","),i=t.split(","),s=0;s<n.length;++s)for(var o=0;o<i.length;++o)if(n[s]===i[o])return!0;return!1}var m=function(){function e(t){n(this,e),a(this,"_pos",new Float32Array(10,10)),this._ctor(t),this.title=t||"Unnamed",this.size=[c.NODE_WIDTH,60],this.graph=null,this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}return o(e,[{key:"pos",get:function(){return this._pos},set:function(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])}},{key:"configure",value:function(e){for(var n in this.graph&&this.graph._version++,e)if("properties"!==n)null!=e[n]&&("object"===t(e[n])?this[n]&&this[n].configure?this[n].configure(e[n]):this[n]=p(e[n],this[n]):this[n]=e[n]);else for(var i in e.properties)this.properties[i]=e.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,e.properties[i]);if(e.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],a=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange(c.INPUT,s,!0,a,o)}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var l=this.outputs[r];if(l.links)for(var h=0;h<l.links.length;++h){var d=this.graph?this.graph.links[l.links[h]]:null;this.onConnectionsChange(c.OUTPUT,r,!0,d,l)}}}if(this.widgets){var v,g=u(this.widgets);try{for(g.s();!(v=g.n()).done;){var f=v.value;f&&(f.options&&f.options.property&&this.properties[f.options.property]&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property]))))}}catch(e){g.e(e)}finally{g.f()}if(e.widgets_values)for(var _=0;_<e.widgets_values.length;++_)this.widgets[_]&&(this.widgets[_].value=e.widgets_values[_])}this.onConfigure&&this.onConfigure(e)}},{key:"serialize",value:function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:p(this.flags),order:this.order,mode:this.mode};if(this.constructor===e&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var n=0;n<this.outputs.length;n++)delete this.outputs[n]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=p(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(var i=0;i<this.widgets.length;++i)this.widgets[i]?t.widgets_values[i]=this.widgets[i].value:t.widgets_values[i]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}},{key:"clone",value:function(){var t=e.createNode(this.type);if(!t)return null;var n=e.cloneObject(this.serialize());if(n.inputs)for(var i=0;i<n.inputs.length;++i)n.inputs[i].link=null;if(n.outputs)for(var s=0;s<n.outputs.length;++s)n.outputs[s].links&&(n.outputs[s].links.length=0);return delete n.id,t.configure(n),t}},{key:"toString",value:function(){return JSON.stringify(this.serialize())}},{key:"getTitle",value:function(){return this.title||this.constructor.title}},{key:"setProperty",value:function(e,t){if(this.properties||(this.properties={}),t!==this.properties[e]){var n=this.properties[e];if(this.properties[e]=t,this.onPropertyChanged&&!1===this.onPropertyChanged(e,t,n)&&(this.properties[e]=n),this.widgets)for(var i=0;i<this.widgets.length;++i){var s=this.widgets[i];if(s&&s.options.property==e){s.value=t;break}}}}},{key:"setOutputData",value:function(e,t){if(this.outputs&&!(-1==e||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n._data=t,this.outputs[e].links))for(var i=0;i<this.outputs[e].links.length;i++){var s=this.outputs[e].links[i],o=this.graph.links[s];o&&(o.data=t)}}}},{key:"setOutputDataType",value:function(e,t){if(this.outputs&&!(-1==e||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n.type=t,this.outputs[e].links))for(var i=0;i<this.outputs[e].links.length;i++){var s=this.outputs[e].links[i];this.graph.links[s].type=t}}}},{key:"getInputData",value:function(e,t){if(this.inputs&&!(e>=this.inputs.length||null==this.inputs[e].link)){var n=this.inputs[e].link,i=this.graph.links[n];if(!i)return null;if(!t)return i.data;var s=this.graph.getNodeById(i.origin_id);return s?(s.updateOutputData?s.updateOutputData(i.origin_slot):s.onExecute&&s.onExecute(),i.data):i.data}}},{key:"getInputDataType",value:function(e){if(!this.inputs)return null;if(e>=this.inputs.length||null==this.inputs[e].link)return null;var t=this.inputs[e].link,n=this.graph.links[t];if(!n)return null;var i=this.graph.getNodeById(n.origin_id);if(!i)return n.type;var s=i.outputs[n.origin_slot];return s?s.type:null}},{key:"getInputDataByName",value:function(e,t){var n=this.findInputSlot(e);return-1==n?null:this.getInputData(n,t)}},{key:"isInputConnected",value:function(e){return!!this.inputs&&(e<this.inputs.length&&null!=this.inputs[e].link)}},{key:"getInputInfo",value:function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null}},{key:"getInputLink",value:function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null}},{key:"getInputNode",value:function(e){if(!this.inputs)return null;if(e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||null===t.link)return null;var n=this.graph.links[t.link];return n?this.graph.getNodeById(n.origin_id):null}},{key:"getInputOrProperty",value:function(e){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[e]:null;for(var t=0,n=this.inputs.length;t<n;++t){var i=this.inputs[t];if(e==i.name&&null!=i.link){var s=this.graph.links[i.link];if(s)return s.data}}return this.properties[e]}},{key:"getOutputData",value:function(e){return this.outputs?e>=this.outputs.length?null:this.outputs[e]._data:null}},{key:"getOutputInfo",value:function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null}},{key:"isOutputConnected",value:function(e){return!!this.outputs&&(e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length)}},{key:"isAnyOutputConnected",value:function(){if(!this.outputs)return!1;for(var e=0;e<this.outputs.length;++e)if(this.outputs[e].links&&this.outputs[e].links.length)return!0;return!1}},{key:"getOutputNodes",value:function(e){if(!this.outputs||0==this.outputs.length)return null;if(e>=this.outputs.length)return null;var t=this.outputs[e];if(!t.links||0==t.links.length)return null;for(var n=[],i=0;i<t.links.length;i++){var s=t.links[i],o=this.graph.links[s];if(o){var a=this.graph.getNodeById(o.target_id);a&&n.push(a)}}return n}},{key:"trigger",value:function(e,t){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=d());for(var n=0;n<this.outputs.length;++n){var i=this.outputs[n];!i||i.type!==c.EVENT||e&&i.name!=e||this.triggerSlot(n,t)}}}},{key:"triggerSlot",value:function(e,t,n){if(this.outputs){var i=this.outputs[e];if(i){var s=i.links;if(s&&s.length){this.graph&&(this.graph._last_trigger_time=d());for(var o=0;o<s.length;++o){var a=s[o];if(null==n||n==a){var r=this.graph.links[s[o]];if(r){r._last_time=d();var l=this.graph.getNodeById(r.target_id);if(l){var h=l.inputs[r.target_slot];l.mode===c.ON_TRIGGER?l.onExecute&&l.onExecute(t):l.onAction&&l.onAction(h.name,t)}}}}}}}}},{key:"clearTriggeredSlot",value:function(e,t){if(this.outputs){var n=this.outputs[e];if(n){var i=n.links;if(i&&i.length)for(var s=0;s<i.length;++s){var o=i[s];if(null==t||t==o){var a=this.graph.links[i[s]];a&&(a._last_time=0)}}}}}},{key:"setSize",value:function(e){this.size=e,this.onResize&&this.onResize(this.size)}},{key:"addProperty",value:function(e,t,n,i){var s={name:e,type:n,default_value:t};if(i)for(var o in i)s[o]=i[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[e]=t,s}},{key:"addOutput",value:function(e,t,n){var i={name:e,type:t,links:null};if(n)for(var s in n)i[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i}},{key:"addOutputs",value:function(e){for(var t=0;t<e.length;++t){var n=e[t],i={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])i[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeOutput",value:function(e){this.disconnectOutput(e),this.outputs.splice(e,1);for(var t=e;t<this.outputs.length;++t)if(this.outputs[t]&&this.outputs[t].links)for(var n=this.outputs[t].links,i=0;i<n.length;++i){var s=this.graph.links[n[i]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(e),this.setDirtyCanvas(!0,!0)}},{key:"addInput",value:function(e,t,n){var i={name:e,type:t=t||0,link:null};if(n)for(var s in n)i[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),this.setDirtyCanvas(!0,!0),i}},{key:"addInputs",value:function(e){for(var t=0;t<e.length;++t){var n=e[t],i={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])i[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeInput",value:function(e){this.disconnectInput(e);for(var t=this.inputs.splice(e,1),n=e;n<this.inputs.length;++n)if(this.inputs[n]){var i=this.graph.links[this.inputs[n].link];i&&(i.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(e,t[0]),this.setDirtyCanvas(!0,!0)}},{key:"addConnection",value:function(e,t,n,i){var s={name:e,type:t,pos:n,direction:i,links:null};return this.connections.push(s),s}},{key:"computeSize",value:function(e){if(this.constructor.size)return this.constructor.size.concat();var t=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=e||new Float32Array([0,0]);t=Math.max(t,1);var i=i=c.NODE_TEXT_SIZE,s=v(this.title),o=0,a=0;if(this.inputs)for(var r=0,l=this.inputs.length;r<l;++r){var h=this.inputs[r];o<(u=v(h.label||h.name||""))&&(o=u)}if(this.outputs)for(r=0,l=this.outputs.length;r<l;++r){var u,d=this.outputs[r];a<(u=v(d.label||d.name||""))&&(a=u)}n[0]=Math.max(o+a+10,s),n[0]=Math.max(n[0],c.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*c.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+t*c.NODE_SLOT_HEIGHT;var p=0;if(this.widgets&&this.widgets.length){for(r=0,l=this.widgets.length;r<l;++r)this.widgets[r].computeSize?p+=this.widgets[r].computeSize(n[0])[1]+4:p+=c.NODE_WIDGET_HEIGHT+4;p+=8}function v(e){return e?i*e.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],p):null!=this.widgets_start_y?n[1]=Math.max(n[1],p+this.widgets_start_y):n[1]+=p,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n}},{key:"getPropertyInfo",value:function(e){var n=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==e){n=this.properties_info[i];break}return this.constructor["@".concat(e)]&&(n=this.constructor["@".concat(e)]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(n=this.constructor.widgets_info[e]),!n&&this.onGetPropertyInfo&&(n=this.onGetPropertyInfo(e)),n||(n={}),n.type||(n.type=t(this.properties[e])),"combo"==n.widget&&(n.type="enum"),n}},{key:"addWidget",value:function(e,t,n,i,s){this.widgets||(this.widgets=[]),!s&&i&&i.constructor===Object&&(s=i,i=null),s&&s.constructor===String&&(s={property:s}),i&&i.constructor===String&&(s||(s={}),s.property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);var o={type:e.toLowerCase(),name:t,value:n,callback:i,options:s||{}};if(void 0!==o.options.y&&(o.y=o.options.y),i||o.options.callback||o.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==e&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o}},{key:"addCustomWidget",value:function(e){return this.widgets||(this.widgets=[]),this.widgets.push(e),e}},{key:"getBounding",value:function(e){return(e=e||new Float32Array(4))[0]=this.pos[0]-4,e[1]=this.pos[1]-c.NODE_TITLE_HEIGHT,e[2]=this.size[0]+4,e[3]=this.size[1]+c.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(e),e}},{key:"isPointInside",value:function(e,t,n,i){n=n||0;var s=this.graph&&this.graph.isLive()?0:c.NODE_TITLE_HEIGHT;if(i&&(s=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(e,t,this.pos[0]-n,this.pos[1]-c.NODE_TITLE_HEIGHT-n,(this._collapsed_width||c.NODE_COLLAPSED_WIDTH)+2*n,c.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<e&&this.pos[0]+this.size[0]+4+n>e&&this.pos[1]-s-n<t&&this.pos[1]+this.size[1]+n>t)return!0;return!1}},{key:"getSlotInPosition",value:function(e,t){var n=new Float32Array(2);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i){var o=this.inputs[i];if(this.getConnectionPos(!0,i,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{input:o,slot:i,link_pos:n}}if(this.outputs)for(i=0,s=this.outputs.length;i<s;++i){var a=this.outputs[i];if(this.getConnectionPos(!1,i,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{output:a,slot:i,link_pos:n}}return null}},{key:"findInputSlot",value:function(e){if(!this.inputs)return-1;for(var t=0,n=this.inputs.length;t<n;++t)if(e==this.inputs[t].name)return t;return-1}},{key:"findOutputSlot",value:function(e){if(!this.outputs)return-1;for(var t=0,n=this.outputs.length;t<n;++t)if(e==this.outputs[t].name)return t;return-1}},{key:"connect",value:function(e,t,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(e.constructor===String){if(-1==(e=this.findOutputSlot(e)))return c.debug&&console.log("Connect: Error, no slot of name ".concat(e)),null}else if(!this.outputs||e>=this.outputs.length)return c.debug&&console.log("Connect: Error, slot number not found"),null;if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"target node is null";if(t==this)return null;if(n.constructor===String){if(-1==(n=t.findInputSlot(n)))return c.debug&&console.log("Connect: Error, no slot of name ".concat(n)),null}else{if(n===c.EVENT)return null;if(!t.inputs||n>=t.inputs.length)return c.debug&&console.log("Connect: Error, slot number not found"),null}var i=!1;null!=t.inputs[n].link&&(this.graph.beforeChange(),t.disconnectInput(n),i=!0);var s=this.outputs[e];if(t.onConnectInput&&!1===t.onConnectInput(n,s.type,s,this,e))return null;var o=t.inputs[n],a=null;return y(s.type,o.type)?(i||this.graph.beforeChange(),a=new LLink(++this.graph.last_link_id,o.type,this.id,e,t.id,n),this.graph.links[a.id]=a,null==s.links&&(s.links=[]),s.links.push(a.id),t.inputs[n].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(c.OUTPUT,e,!0,a,s),t.onConnectionsChange&&t.onConnectionsChange(c.INPUT,n,!0,a,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(c.INPUT,t,n,this,e),this.graph.onNodeConnectionChange(c.OUTPUT,this,e,t,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a):(this.setDirtyCanvas(!1,!0),i&&this.graph.connectionChange(this,a),null)}},{key:"disconnectOutput",value:function(e,t){if(e.constructor===String){if(-1==(e=this.findOutputSlot(e)))return c.debug&&console.log("Connect: Error, no slot of name ".concat(e)),!1}else if(!this.outputs||e>=this.outputs.length)return c.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[e];if(!n||!n.links||0==n.links.length)return!1;if(t){if(t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"Target Node not found";for(var i=0,s=n.links.length;i<s;i++){var o=n.links[i];if((a=this.graph.links[o]).target_id==t.id){n.links.splice(i,1),(r=t.inputs[a.target_slot]).link=null,delete this.graph.links[o],this.graph&&this.graph._version++,t.onConnectionsChange&&t.onConnectionsChange(c.INPUT,a.target_slot,!1,a,r),this.onConnectionsChange&&this.onConnectionsChange(c.OUTPUT,e,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(c.OUTPUT,this,e),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(c.OUTPUT,this,e),this.graph.onNodeConnectionChange(c.INPUT,t,a.target_slot));break}}}else{for(i=0,s=n.links.length;i<s;i++){var a;o=n.links[i];if(a=this.graph.links[o]){t=this.graph.getNodeById(a.target_id);var r=null;this.graph&&this.graph._version++,t&&((r=t.inputs[a.target_slot]).link=null,t.onConnectionsChange&&t.onConnectionsChange(c.INPUT,a.target_slot,!1,a,r),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(c.INPUT,t,a.target_slot)),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(c.OUTPUT,e,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(c.OUTPUT,this,e),this.graph.onNodeConnectionChange(c.INPUT,t,a.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}},{key:"disconnectInput",value:function(e){if(e.constructor===String){if(-1==(e=this.findInputSlot(e)))return c.debug&&console.log("Connect: Error, no slot of name ".concat(e)),!1}else if(!this.inputs||e>=this.inputs.length)return c.debug&&console.log("Connect: Error, slot number not found"),!1;var t=this.inputs[e];if(!t)return!1;var n=this.inputs[e].link;if(null!=n){this.inputs[e].link=null;var i=this.graph.links[n];if(i){var s=this.graph.getNodeById(i.origin_id);if(!s)return!1;var o=s.outputs[i.origin_slot];if(!o||!o.links||0==o.links.length)return!1;for(var a=0,r=o.links.length;a<r;a++)if(o.links[a]==n){o.links.splice(a,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(c.INPUT,e,!1,i,t),s.onConnectionsChange&&s.onConnectionsChange(c.OUTPUT,a,!1,i,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(c.OUTPUT,s,a),this.graph.onNodeConnectionChange(c.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}},{key:"getConnectionPos",value:function(e,t,n){n=n||new Float32Array(2);var i=0;e&&this.inputs&&(i=this.inputs.length),!e&&this.outputs&&(i=this.outputs.length);var s=.5*c.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var o=this._collapsed_width||c.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*o,n[1]=e?this.pos[1]-c.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=e?this.pos[0]:this.pos[0]+o,n[1]=this.pos[1]-.5*c.NODE_TITLE_HEIGHT),n}return e&&-1==t?(n[0]=this.pos[0]+.5*c.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*c.NODE_TITLE_HEIGHT,n):e&&i>t&&this.inputs[t].pos?(n[0]=this.pos[0]+this.inputs[t].pos[0],n[1]=this.pos[1]+this.inputs[t].pos[1],n):!e&&i>t&&this.outputs[t].pos?(n[0]=this.pos[0]+this.outputs[t].pos[0],n[1]=this.pos[1]+this.outputs[t].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(t+.5)*(this.size[0]/i),n[1]=e?this.pos[1]-c.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=e?this.pos[0]+s:this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(t+.7)*c.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)}},{key:"alignToGrid",value:function(){this.pos[0]=c.CANVAS_GRID_SIZE*Math.round(this.pos[0]/c.CANVAS_GRID_SIZE),this.pos[1]=c.CANVAS_GRID_SIZE*Math.round(this.pos[1]/c.CANVAS_GRID_SIZE)}},{key:"trace",value:function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>e.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)}},{key:"setDirtyCanvas",value:function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])}},{key:"loadImage",value:function(e){var t=this,n=new Image;return n.src=c.node_images_path+e,n.ready=!1,n.onload=function(){n.ready=!0,t.setDirtyCanvas(!0)},n}},{key:"captureInput",value:function(e){if(this.graph&&this.graph.list_of_graphcanvas)for(var t=this.graph.list_of_graphcanvas,n=0;n<t.length;++n){var i=t[n];(e||i.node_capturing_input==this)&&(i.node_capturing_input=e?this:null)}}},{key:"collapse",value:function(e){this.graph._version++,(!1!==this.constructor.collapsable||e)&&(this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0))}},{key:"pin",value:function(e){this.graph._version++,this.flags.pinned=void 0===e?!this.flags.pinned:e}},{key:"localToScreen",value:function(e,t,n){return[(e+this.pos[0])*n.scale+n.offset[0],(t+this.pos[1])*n.scale+n.offset[1]]}}],[{key:"createNode",value:function(e,t,n){var i=this.registered_node_types[e];if(!i)return c.debug&&console.log('GraphNode type "'.concat(e,'" not registered.')),null;i.prototype,t=t||i.title||e;var s=null;if(c.catch_exceptions)try{s=new i(t)}catch(e){return console.error(e),null}else s=new i(t);if(s.type=e,!s.title&&t&&(s.title=t),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=c.DEFAULT_POSITION.concat()),s.mode||(s.mode=c.ALWAYS),n)for(var o in n)s[o]=n[o];return s}},{key:"reloadNodes",value:function(e){var t,n=[],s=u(document.getElementsByTagName("script"));try{for(s.s();!(t=s.n()).done;){var o=t.value;n.push(o)}}catch(e){s.e(e)}finally{s.f()}var a=document.getElementsByTagName("head")[0];e=document.location.href+e;for(var r=0,l=n;r<l.length;r++){var h=l[r].src;if(h&&h.substr(0,e.length)===e)try{c.debug&&console.log("Reloading: ".concat(h));var d=document.createElement("script");d.type="text/javascript",d.src=h,a.appendChild(d),a.removeChild(n[i])}catch(e){if(c.throw_errors)throw e;c.debug&&console.log("Error while reloading ".concat(h))}}c.debug&&console.log("Nodes reloaded")}},{key:"addNodeMethod",value:function(t,n){for(var i in e.prototype[t]=n,this.registered_node_types){var s=this.registered_node_types[i];s.prototype[t]&&(s.prototype["_".concat(t)]=s.prototype[t]),s.prototype[t]=n}}}]),e}(),b=function(){function e(t){n(this,e),a(this,"isPointInside",m.prototype.isPointInside),a(this,"setDirtyCanvas",m.prototype.setDirtyCanvas),this._ctor(t)}return o(e,[{key:"_ctor",value:function(e){var t;this.title=e||"Group",this.font_size=24,this.color=null!==(t=LGraphCanvas)&&void 0!==t&&t.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(e){!e||e.length<2||(this._size[0]=Math.max(140,e[0]),this._size[1]=Math.max(80,e[1]))},get:function(){return this._size},enumerable:!0})}},{key:"recomputeInsideNodes",value:function(){this._nodes.length=0;for(var e=this.graph._nodes,t=new Float32Array(4),n=0;n<e.length;++n){var i=e[n];i.getBounding(t),overlapBounding(this._bounding,t)&&this._nodes.push(i)}}},{key:"move",value:function(e,t,n){if(this._pos[0]+=e,this._pos[1]+=t,!n)for(var i=0;i<this._nodes.length;++i){var s=this._nodes[i];s.pos[0]+=e,s.pos[1]+=t}}},{key:"serialize",value:function(){var e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font:this.font}}},{key:"configure",value:function(e){this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,this.font=e.font}}]),e}(),k=function(){function e(t,i){n(this,e),this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,i||this.bindEvents(t))}return o(e,[{key:"bindEvents",value:function(e){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),e.addEventListener("mousedown",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)}},{key:"computeVisibleArea",value:function(){if(this.element){var e=this.element.width,t=this.element.height,n=-this.offset[0],i=-this.offset[1],s=n+e/this.scale,o=i+t/this.scale;this.visible_area[0]=n,this.visible_area[1]=i,this.visible_area[2]=s-n,this.visible_area[3]=o-i}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0}},{key:"onMouse",value:function(e){if(this.enabled){var t=this.element,n=t.getBoundingClientRect(),i=e.clientX-n.left,s=e.clientY-n.top;e.canvasx=i,e.canvasy=s,e.dragging=this.dragging;var o=!1;if(this.onmouse&&(o=this.onmouse(e)),"mousedown"===e.type)this.dragging=!0,t.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"===e.type){if(!o){var a=i-this.last_mouse[0],r=s-this.last_mouse[1];this.dragging&&this.mouseDrag(a,r)}}else"mouseup"===e.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback)):"mousewheel"!==e.type&&"wheel"!==e.type&&"DOMMouseScroll"!==e.type||(e.eventType="mousewheel","wheel"===e.type?e.wheel=-e.deltaY:e.wheel=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,e.wheelDelta?e.delta=e.wheelDelta/40:e.deltaY?e.delta=-e.deltaY/3:e.delta=0,this.changeDeltaScale(1+.05*e.delta));return this.last_mouse[0]=i,this.last_mouse[1]=s,e.preventDefault(),e.stopPropagation(),!1}}},{key:"toCanvasContext",value:function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])}},{key:"convertOffsetToCanvas",value:function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]}},{key:"convertCanvasToOffset",value:function(e,t){return(t=t||[0,0])[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t}},{key:"mouseDrag",value:function(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw&&this.onredraw(this)}},{key:"changeScale",value:function(e,t){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!==this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){t=t||[.5*n.width,.5*n.height];var i=this.convertCanvasToOffset(t);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(t),o=[s[0]-i[0],s[1]-i[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}}},{key:"changeDeltaScale",value:function(e,t){this.changeScale(this.scale*e,t)}},{key:"reset",value:function(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}]),e}();var E=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,e),this.options=i;var s=this;i.parentMenu&&(i.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=null):(this.parentMenu=i.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var o=null;i.event&&(o=i.event.constructor.name),"MouseEvent"!==o&&"CustomEvent"!==o&&"PointerEvent"!==o&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),i.event=null);var a=document.createElement("div");function r(e){var t=parseInt(a.style.top,10);return a.style.top="".concat((t+e.deltaY*i.scroll_speed).toFixed(),"px"),e.preventDefault(),!0}if(a.className="litegraph litecontextmenu litemenubar-panel",i.className&&(a.className+=" ".concat(i.className)),a.style.minWidth=100,a.style.minHeight=100,a.style.pointerEvents="none",setTimeout((function(){a.style.pointerEvents="auto"}),100),a.addEventListener("mouseup",(function(e){return e.preventDefault(),!0}),!0),a.addEventListener("contextmenu",(function(e){return 2!==e.button||e.preventDefault(),!1}),!0),a.addEventListener("mousedown",(function(e){if(2===e.button)return s.close(),e.preventDefault(),!0}),!0),i.scroll_speed||(i.scroll_speed=.1),a.addEventListener("wheel",r,!0),a.addEventListener("mousewheel",r,!0),this.root=a,i.title){var l=document.createElement("div");l.className="litemenu-title",l.innerHTML=i.title,a.appendChild(l)}for(var h=0;h<t.length;h++){var u=t.constructor===Array?t[h]:h;u&&u.constructor!==String&&(u=void 0===u.content?String(u):u.content);var c=t[h];this.addItem(u,c,i)}a.addEventListener("mouseleave",(function(e){s.lock||(a.closing_timer&&clearTimeout(a.closing_timer),a.closing_timer=setTimeout(s.close.bind(s,e),500))})),a.addEventListener("mouseenter",(function(e){a.closing_timer&&clearTimeout(a.closing_timer)}));var d=document;i.event&&(d=i.event.target.ownerDocument),d||(d=document),d.fullscreenElement?d.fullscreenElement.appendChild(a):d.body.appendChild(a);var p=i.left||0,v=i.top||0;if(i.event){if(p=i.event.clientX-10,v=i.event.clientY-10,i.title&&(v-=20),i.parentMenu){var g=i.parentMenu.root.getBoundingClientRect();p=g.left+g.width}var f=document.body.getBoundingClientRect(),_=a.getBoundingClientRect();0===f.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),f.width&&p>f.width-_.width-10&&(p=f.width-_.width-10),f.height&&v>f.height-_.height-10&&(v=f.height-_.height-10)}a.style.left="".concat(p,"px"),a.style.top="".concat(v,"px"),i.scale&&(a.style.transform="scale(".concat(i.scale,")"))}return o(e,[{key:"addItem",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this,s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;function a(e){var t=this.value;t&&t.has_submenu&&r.call(this,e)}function r(e){var t=this.value,s=!0;(i.current_submenu&&i.current_submenu.close(e),n.callback)&&(!0===n.callback.call(this,t,n,e,i,n.node)&&(s=!1));if(t){if(t.callback&&!n.ignore_item_callbacks&&!0!==t.disabled)!0===t.callback.call(this,t,n,e,i,n.extra)&&(s=!1);if(t.submenu){if(!t.submenu.options)throw new Error("ContextMenu submenu needs options");new i.constructor(t.submenu.options,{callback:t.submenu.callback,event:e,parentMenu:i,ignore_item_callbacks:t.submenu.ignore_item_callbacks,title:t.submenu.title,extra:t.submenu.extra,autoopen:n.autoopen}),s=!1}}s&&!i.lock&&i.close()}return null===t?s.classList.add("separator"):(s.innerHTML=t&&t.title?t.title:e,s.value=t,t&&(t.disabled&&(o=!0,s.classList.add("disabled")),(t.submenu||t.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof t?(s.dataset.value=e,s.onclick_callback=t):s.dataset.value=t,t.className&&(s.className+=" ".concat(t.className))),this.root.appendChild(s),o||s.addEventListener("click",r),n.autoopen&&s.addEventListener("mouseenter",a),s}},{key:"close",value:function(t,n){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!n&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!e.isCursorOverElement(t,this.parentMenu.root)&&e.trigger(this.parentMenu.root,"mouseleave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}},{key:"getTopMenu",value:function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}},{key:"getFirstEvent",value:function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}}],[{key:"trigger",value:function(e,t,n,i){var s=document.createEvent("CustomEvent");return s.initCustomEvent(t,!0,!0,n),s.target=i,e.dispatchEvent?e.dispatchEvent(s):e.__events&&e.__events.dispatchEvent(s),s}},{key:"closeAllContextMenus",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window,t=e.document.querySelectorAll(".litecontextmenu");if(t.length){var n,s=[],o=u(t);try{for(o.s();!(n=o.n()).done;){var a=n.value;s.push(a)}}catch(e){o.e(e)}finally{o.f()}for(var r=0,l=s;r<l.length;r++){var h=l[r];h.close?h.close():h.parentNode&&h.parentNode.removeChild(s[i])}}}},{key:"isCursorOverElement",value:function(e,t){var n=e.clientX,i=e.clientY,s=t.getBoundingClientRect();return!!s&&(i>s.top&&i<s.top+s.height&&n>s.left&&n<s.left+s.width)}}]),e}();function T(e,t,n,i,s,o){return n<e&&n+s>e&&i<t&&i+o>t}function C(e,t){var n=e[0]+e[2],i=e[1]+e[3],s=t[0]+t[2],o=t[1]+t[3];return!(e[0]>s||e[1]>o||n<t[0]||i<t[1])}var w=new Float32Array(4),N=new Float32Array(2),O=new Float32Array(4),S=new Float32Array(4),I=new Float32Array(4),A=new Float32Array(2),D=new Float32Array(2),L=function(){function e(t,i){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n(this,e),a(this,"showSearchBox",(function(t){var n=this,i=this,s=e.active_canvas,o=s.canvas,a=o.ownerDocument||document,r=document.createElement("div");r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",r.close=function(){n.search_box=null,a.body.focus(),a.body.style.overflow="",setTimeout((function(){n.canvas.focus()}),20),r.parentNode&&r.parentNode.removeChild(r)};var l=null;this.ds.scale>1&&(r.style.transform="scale(".concat(this.ds.scale,")")),r.addEventListener("mouseenter",(function(){l&&(clearTimeout(l),l=null)})),r.addEventListener("mouseleave",(function(){l=setTimeout((function(){return r.close()}),500)})),this.search_box&&this.search_box.close(),this.search_box=r;var h=r.querySelector(".helper"),d=null,p=null,v=null,g=r.querySelector("input");g&&(g.addEventListener("blur",(function(){return g.focus()})),g.addEventListener("keydown",(function(e){if(38===e.keyCode)k(!1);else if(40===e.keyCode)k(!0);else if(27===e.keyCode)r.close();else{if(13!==e.keyCode)return p&&clearInterval(p),void(p=setTimeout(E,10));v?b(v.innerHTML):d?b(d):r.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0}))),a.fullscreenElement?a.fullscreenElement.appendChild(r):(a.body.appendChild(r),a.body.style.overflow="hidden");var f=o.getBoundingClientRect(),_=(t?t.clientX:f.left+.5*f.width)-80,y=(t?t.clientY:f.top+.5*f.height)-20;function b(e){if(e)if(i.onSearchBoxSelection)i.onSearchBoxSelection(e,t,s);else{var n=c.searchbox_extras[e.toLowerCase()];n&&(e=n.type),s.graph.beforeChange();var o=m.createNode(e);if(o&&(o.pos=s.convertEventToCanvasOffset(t),s.graph.add(o)),n&&n.data){if(n.data.properties)for(var a in n.data.properties)o.addProperty(a,n.data.properties[a]);if(n.data.inputs)for(var l in o.inputs=[],n.data.inputs)o.addOutput(n.data.inputs[l][0],n.data.inputs[l][1]);if(n.data.outputs)for(var h in o.outputs=[],n.data.outputs)o.addOutput(n.data.outputs[h][0],n.data.outputs[h][1]);n.data.title&&(o.title=n.data.title),n.data.json&&o.configure(n.data.json),s.graph.afterChange()}}r.close()}function k(e){var t=v;v&&v.classList.remove("selected"),v?(v=e?v.nextSibling:v.previousSibling)||(v=t):v=e?h.childNodes[0]:h.childNodes[h.childNodes.length],v&&(v.classList.add("selected"),v.scrollIntoView({block:"end",behavior:"smooth"}))}function E(){p=null;var t=g.value;if(d=null,h.innerHTML="",t)if(i.onSearchBox){var n=i.onSearchBox(h,t,s);if(n){var o,a=u(n);try{for(a.s();!(o=a.n()).done;){k(o.value)}}catch(e){a.e(e)}finally{a.f()}}}else{var r=0;t=t.toLowerCase();var l=s.filter||s.graph.filter;for(var v in c.searchbox_extras){var f=c.searchbox_extras[v];if(-1!==f.desc.toLowerCase().indexOf(t)){var _=c.registered_node_types[f.type];if((!_||_.filter===l)&&(k(f.desc,"searchbox_extra"),-1!==e.search_limit&&r++>e.search_limit))break}}var y,m=u(Object.keys(c.registered_node_types).filter((function(e){var n=c.registered_node_types[e];return(!l||n.filter===l)&&-1!==e.toLowerCase().indexOf(t)})));try{for(m.s();!(y=m.n()).done;){if(k(y.value),-1!==e.search_limit&&r++>e.search_limit)break}}catch(e){m.e(e)}finally{m.f()}}function k(e,t){var n=document.createElement("div");d||(d=e),n.innerText=e,n.dataset.type=escape(e),n.className="litegraph lite-search-item",t&&(n.className+=" ".concat(t)),n.addEventListener("click",(function(){b(unescape(n.dataset.type))})),h.appendChild(n)}}return r.style.left="".concat(_,"px"),r.style.top="".concat(y,"px"),t.layerY>f.height-200&&(h.style.maxHeight="".concat(f.height-t.layerY-20,"px")),g.focus(),r})),a(this,"showShowNodePanel",(function(e){window.SELECTED_NODE=e;var t=document.querySelector("#node-panel");t&&t.close();var n=this.getCanvasWindow();(t=this.createPanel(e.title||"",{closable:!0,window:n})).id="node-panel",t.node=e,t.classList.add("settings");var i=this;!function(){for(var n in t.content.innerHTML="",t.addHTML('<span class="node_type">'.concat(e.type,'</span><span class="node_desc">').concat(e.constructor.desc||"",'</span><span class="separator"></span>')),t.addHTML("<h3>Properties</h3>"),e.properties){var s=e.properties[n],o=e.getPropertyInfo(n);e.onAddPropertyToPanel&&e.onAddPropertyToPanel(n,t)||t.addWidget(o.widget||o.type,n,s,o,(function(t,n){i.graph.beforeChange(e),e.setProperty(t,n),i.graph.afterChange(),i.dirty_canvas=!0}))}t.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(t),t.addButton("Delete",(function(){e.block_delete||(e.graph.remove(e),t.close())})).classList.add("delete")}(),this.canvas.parentNode.appendChild(t)})),this.background_image=e.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new k,this.zoom_modify_alpha=!0,this.title_text_font="".concat(c.NODE_TEXT_SIZE,"px Arial"),this.inner_text_font="normal ".concat(c.NODE_SUBTEXT_SIZE,"px Arial"),this.node_title_color=c.NODE_TITLE_COLOR,this.default_link_color=c.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=c.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],i&&i.attachCanvas(this),this.setCanvas(t),this.clear(),s.skip_render||this.startRendering(),this.autoresize=s.autoresize}return o(e,[{key:"clear",value:function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()}},{key:"setGraph",value:function(e,t){this.graph!==e&&(t||this.clear(),e||!this.graph?(e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))}},{key:"getTopGraph",value:function(){return this._graph_stack.length?this._graph_stack[0]:this.graph}},{key:"openSubgraph",value:function(e){if(!e)throw new Error("graph cannot be null");if(this.graph===e)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}},{key:"closeSubgraph",value:function(){if(this._graph_stack&&0!==this._graph_stack.length){var e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e]))}}},{key:"getCurrentGraph",value:function(){return this.graph}},{key:"setCanvas",value:function(e,t){var n;if((null===(n=e)||void 0===n?void 0:n.constructor)===String&&!(e=document.getElementById(e)))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null===e.getContext){if("canvas"!==e.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a ".concat(e.localName));throw new Error("This browser doesn't support Canvas")}this.ctx=e.getContext("2d"),null==this.ctx&&(e.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),t||this.bindEvents()}}},{key:"_doNothing",value:function(e){return e.preventDefault(),!1}},{key:"_doReturnTrue",value:function(e){return e.preventDefault(),!0}},{key:"bindEvents",value:function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var e=this.canvas,t=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),e.addEventListener("mousedown",this._mousedown_callback,!0),e.addEventListener("mousemove",this._mousemove_callback),e.addEventListener("mousewheel",this._mousewheel_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback),e.addEventListener("touchstart",this.touchHandler,!0),e.addEventListener("touchmove",this.touchHandler,!0),e.addEventListener("touchend",this.touchHandler,!0),e.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),e.addEventListener("keydown",this._key_callback,!0),t.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}}},{key:"unbindEvents",value:function(){if(this._events_binded){var e=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),e.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")}},{key:"enableWebGL",value:function(){if(!GL)throw new Error("litegl.js must be included to use a WebGL canvas");if(!enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.ctx=enableWebGLCanvas(this.canvas),this.gl=this.ctx,this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}},{key:"setDirty",value:function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)}},{key:"getCanvasWindow",value:function(){return this.canvas?this.canvas.ownerDocument.defaultView:window}},{key:"startRendering",value:function(){this.is_rendering||(this.is_rendering=!0,this.renderFrame())}},{key:"renderFrame",value:function(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(this.renderFrame)}},{key:"stopRendering",value:function(){this.is_rendering=!1}},{key:"blockClick",value:function(){this.block_click=!0,this.last_mouseclick=0}},{key:"processMouseDown",value:function(t){var n=this;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var i=this.getCanvasWindow();e.active_canvas=this,this.canvas.removeEventListener("mousemove",this._mousemove_callback),i.document.addEventListener("mousemove",this._mousemove_callback,!0),i.document.addEventListener("mouseup",this._mouseup_callback,!0);var s=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),o=!1,a=d()-this.last_mouseclick<300;if(this.mouse[0]=t.localX,this.mouse[1]=t.localY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.canvas.focus(),E.closeAllContextMenus(i),!this.onMouse||!this.onMouse(t)){if(1===t.which){t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,o=!0);var r=!1;if(s&&this.allow_interaction&&!o&&!this.read_only){if(this.live_mode||s.flags.pinned||this.bringToFront(s),!this.connecting_node&&!s.flags.collapsed&&!this.live_mode)if(!o&&!1!==s.resizable&&T(t.canvasX,t.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,1010))this.graph.beforeChange(),this.resizing_node=s,this.canvas.style.cursor="se-resize",o=!0;else{if(s.outputs)for(var l=0,h=s.outputs.length;l<h;l++){var p=s.outputs[l],v=s.getConnectionPos(!1,l);if(T(t.canvasX,t.canvasY,v[0]-15,v[1]-10,30,20)){this.connecting_node=s,this.connecting_output=p,this.connecting_pos=s.getConnectionPos(!1,l),this.connecting_slot=l,t.shiftKey&&s.disconnectOutput(l),a?s.onOutputDblClick&&s.onOutputDblClick(l,t):s.onOutputClick&&s.onOutputClick(l,t),o=!0;break}}if(s.inputs)for(var g=0,f=s.inputs.length;g<f;g++){var _=s.inputs[g],y=s.getConnectionPos(!0,g);if(T(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)&&(a?s.onInputDblClick&&s.onInputDblClick(g,t):s.onInputClick&&s.onInputClick(g,t),null!==_.link)){var m=this.graph.links[_.link];s.disconnectInput(g),(this.allow_reconnect_links||t.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[m.origin_id],this.connecting_slot=m.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,o=!0}}}if(!o){var b=!1,k=[t.canvasX-s.pos[0],t.canvasY-s.pos[1]],C=this.processNodeWidgets(s,this.graph_mouse,t);C&&(b=!0,this.node_widget=[s,C]),a&&this.selected_nodes[s.id]&&(s.onDblClick&&s.onDblClick(t,k,this),this.processNodeDblClicked(s),b=!0),s.onMouseDown&&s.onMouseDown(t,k,this)?b=!0:(s.subgraph&&!s.skip_subgraph_button&&!s.flags.collapsed&&k[0]>s.size[0]-c.NODE_TITLE_HEIGHT&&k[1]<0&&setTimeout((function(){n.openSubgraph(s.subgraph)}),10),this.live_mode&&(r=!0,b=!0)),b||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=s),this.selected_nodes[s.id]||this.processNodeSelected(s,t)),this.dirty_canvas=!0}}else{if(!this.read_only){var w,N=u(this.visible_links);try{for(N.s();!(w=N.n()).done;){var O=w.value,S=O._pos;if(!(!S||t.canvasX<S[0]-4||t.canvasX>S[0]+4||t.canvasY<S[1]-4||t.canvasY>S[1]+4)){this.showLinkMenu(O,t),this.over_link_center=null;break}}}catch(e){N.e(e)}finally{N.f()}}if(this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)t.ctrlKey&&(this.dragging_rectangle=null),distance([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();a&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(t),r=!0}!o&&r&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2===t.which||3===t.which&&(this.read_only||this.processContextMenu(s,t));return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=d(),this.last_mouse_dragging=!0,this.graph.change(),(!i.document.activeElement||"input"!==i.document.activeElement.nodeName.toLowerCase()&&"textarea"!==i.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},{key:"processMouseMove",value:function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){e.active_canvas=this,this.adjustMouseEvent(t);var n=[t.localX,t.localY];this.mouse[0]=n[0],this.mouse[1]=n[1];var i=[n[0]-this.last_mouse[0],n[1]-this.last_mouse[1]];if(this.last_mouse=n,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.block_click)return t.preventDefault(),!1;if(t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var s=i[0]/this.ds.scale,o=i[1]/this.ds.scale;this.selected_group.move(s,o,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);var a,r=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes),l=u(this.graph._nodes);try{for(l.s();!(a=l.n()).done;){var h=a.value;h.mouseOver&&r!==h&&(h.mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0)}}catch(e){l.e(e)}finally{l.f()}if(r){if(r.redraw_on_mouse&&(this.dirty_canvas=!0),r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(t)),r.onMouseMove&&r.onMouseMove(t,[t.canvasX-r.pos[0],t.canvasY-r.pos[1]],this),this.connecting_node){var c=this._highlight_input||[0,0];if(this.isOverNodeBox(r,t.canvasX,t.canvasY));else{var d=this.isOverNodeInput(r,t.canvasX,t.canvasY,c);if(-1!==d&&r.inputs[d]){var p=r.inputs[d].type;y(this.connecting_output.type,p)&&(this._highlight_input=c)}else this._highlight_input=null}}this.canvas&&(T(t.canvasX,t.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var v,g=null,f=u(this.visible_links);try{for(f.s();!(v=f.n()).done;){var _=v.value,m=_._pos;if(!(!m||t.canvasX<m[0]-4||t.canvasX>m[0]+4||t.canvasY<m[1]-4||t.canvasY>m[1]+4)){g=_;break}}}catch(e){f.e(e)}finally{f.f()}g!==this.over_link_center&&(this.over_link_center=g,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!==r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){var b,k=u(this.selected_nodes);try{for(k.s();!(b=k.n()).done;){var E=b.value;E.pos[0]+=i[0]/this.ds.scale,E.pos[1]+=i[1]/this.ds.scale}}catch(e){k.e(e)}finally{k.f()}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var C=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],w=this.resizing_node.computeSize();C[0]=Math.max(w[0],C[0]),C[1]=Math.max(w[1],C[1]),this.resizing_node.setSize(C),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}}},{key:"processMouseUp",value:function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var n=this.getCanvasWindow().document;e.active_canvas=this,n.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),n.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(t);var i=d();if(t.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1===t.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group){var s=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(s,o,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var a=this.graph._nodes,r=new Float32Array(4);this.deselectAllNodes();var l=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),p=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-l:this.dragging_rectangle[0],v=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];this.dragging_rectangle[0]=p,this.dragging_rectangle[1]=v,this.dragging_rectangle[2]=l,this.dragging_rectangle[3]=h;var g,f=[],_=u(a);try{for(_.s();!(g=_.n()).done;){var m=g.value;m.getBounding(r),C(this.dragging_rectangle,r)&&f.push(m)}}catch(e){_.e(e)}finally{_.f()}f.length&&this.selectNodes(f)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var b=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(b)if(this.connecting_output.type===c.EVENT&&this.isOverNodeBox(b,t.canvasX,t.canvasY))this.connecting_node.connect(this.connecting_slot,b,c.EVENT);else{var k=this.isOverNodeInput(b,t.canvasX,t.canvasY);if(-1!==k)this.connecting_node.connect(this.connecting_slot,b,k);else{var E=b.getInputInfo(0);this.connecting_output.type===c.EVENT?this.connecting_node.connect(this.connecting_slot,b,c.EVENT):E&&!E.link&&y(E.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,b,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var w=this.node_dragged;w&&t.click_time<300&&T(t.canvasX,t.canvasY,w.pos[0],w.pos[1]-c.NODE_TITLE_HEIGHT,c.NODE_TITLE_HEIGHT,c.NODE_TITLE_HEIGHT)&&w.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{!this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes)&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else(2===t.which||3===t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}}},{key:"processMouseWheel",value:function(e){var t;if(this.graph&&this.allow_dragcanvas){var n=null!==(t=e.wheelDeltaY)&&void 0!==t?t:-60*e.detail;this.adjustMouseEvent(e);var i=this.ds.scale;return n>0?i*=1.1:n<0&&(i*=1/1.1),this.ds.changeScale(i,[e.localX,e.localY]),this.graph.change(),e.preventDefault(),!1}}},{key:"isOverNodeBox",value:function(e,t,n){var i=c.NODE_TITLE_HEIGHT;return!!T(t,n,e.pos[0]+2,e.pos[1]+2-i,i-4,i-4)}},{key:"isOverNodeInput",value:function(e,t,n,i){if(e.inputs)for(var s=0,o=e.inputs.length;s<o;++s){var a=e.getConnectionPos(!0,s);if(e.horizontal?T(t,n,a[0]-5,a[1]-10,10,20):T(t,n,a[0]-10,a[1]-5,40,10))return i&&(i[0]=a[0],i[1]=a[1]),s}return-1}},{key:"processKey",value:function(e){if(this.graph){var t=!1;if("input"!==e.target.localName){if("keydown"===e.type){if(32===e.keyCode&&(this.dragging_canvas=!0,t=!0),65===e.keyCode&&e.ctrlKey&&(this.selectNodes(),t=!0),"KeyC"!==e.code||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),t=!0),"KeyV"!==e.code||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.pasteFromClipboard(),46!==e.keyCode&&8!==e.keyCode||"input"===e.target.localName||"textarea"===e.target.localName||(this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(e)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(e);return this.graph.change(),t?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}}},{key:"pasteFromClipboard",value:function(){var e=localStorage.getItem("litegrapheditor_clipboard");if(e){this.graph.beforeChange();var t,n=JSON.parse(e),i=[],s=u(n.nodes);try{for(s.s();!(t=s.n()).done;){var o=t.value,a=m.createNode(o.type);a&&(a.configure(o),a.pos[0]+=5,a.pos[1]+=5,this.graph.add(a),i.push(a))}}catch(e){s.e(e)}finally{s.f()}var r,l=u(n.links);try{for(l.s();!(r=l.n()).done;){var h=r.value,c=i[h[0]],d=i[h[2]];c&&d?c.connect(h[1],d,h[3]):console.warn("Warning, nodes missing on pasting")}}catch(e){l.e(e)}finally{l.f()}this.selectNodes(i),this.graph.afterChange()}}},{key:"copyToClipboard",value:function(){var e,t={nodes:[],links:[]},n=0,i=[],s=u(this.selected_nodes);try{for(s.s();!(e=s.n()).done;){e.value;node._relative_id=n,i.push(node),n+=1}}catch(e){s.e(e)}finally{s.f()}for(var o=0,a=i;o<a.length;o++){var r=a[o],l=r.clone();if(l){if(t.nodes.push(l.serialize()),r.inputs&&r.inputs.length)for(var h=0;h<r.inputs.length;++h){var c=r.inputs[h];if(c&&null!=c.link){var d=this.graph.links[c.link];if(d){var p=this.graph.getNodeById(d.origin_id);p&&this.selected_nodes[p.id]&&t.links.push([p._relative_id,d.origin_slot,r._relative_id,d.target_slot])}}}}else console.warn("node type not found: ".concat(r.type))}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))}},{key:"processDrop",value:function(e){e.preventDefault(),this.adjustMouseEvent(e);var t=[e.canvasX,e.canvasY],n=this.graph?this.graph.getNodeOnPos(t[0],t[1]):null;if(!n){var i=null;return this.onDropItem&&(i=this.onDropItem(e)),void(i||this.checkDropItem(e))}if(n.onDropFile||n.onDropData){var s=e.dataTransfer.files;if(s&&s.length){var o,a=u(s);try{var r=function(){var e=o.value,t=e.name;if(n.onDropFile&&n.onDropFile(e),n.onDropData){var i=new FileReader;i.onload=function(i){var s=i.target.result;n.onDropData(s,t,e)};var s=e.type.split("/")[0];"text"===s||""===s?i.readAsText(e):"image"===s?i.readAsDataURL(e):i.readAsArrayBuffer(e)}};for(a.s();!(o=a.n()).done;)r()}catch(e){a.e(e)}finally{a.f()}}}return!(!n.onDropItem||!n.onDropItem(e))||!!this.onDropItem&&this.onDropItem(e)}},{key:"checkDropItem",value:function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],n=function(e){var t=e.indexOf("?");-1!==t&&(e=e.substr(0,t));var n=e.lastIndexOf(".");return-1===n?"":e.substr(n+1).toLowerCase()}(t.name).toLowerCase(),i=c.node_types_by_file_extension[n];if(i){this.graph.beforeChange();var s=m.createNode(i.type);s.pos=[e.canvasX,e.canvasY],this.graph.add(s),s.onDropFile&&s.onDropFile(t),this.graph.afterChange()}}}},{key:"processNodeDblClicked",value:function(e){this.onShowNodePanel?this.onShowNodePanel(e):this.showShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)}},{key:"processNodeSelected",value:function(e,t){this.selectNode(e,t&&t.shiftKey),this.onNodeSelected&&this.onNodeSelected(e)}},{key:"selectNode",value:function(e,t){null==e?this.deselectAllNodes():this.selectNodes([e],t)}},{key:"selectNodes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.graph._nodes,t=arguments.length>1?arguments[1]:void 0;t||this.deselectAllNodes();var n,i=u(e);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(!s.is_selected){if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,this.selected_nodes[s.id]=s,s.inputs){var o,a=u(s.inputs);try{for(a.s();!(o=a.n()).done;){var r=o.value;this.highlighted_links[r.link]=!0}}catch(e){a.e(e)}finally{a.f()}}if(s.outputs){var l,h=u(s.outputs);try{for(h.s();!(l=h.n()).done;){var c=l.value;if(c.links){var d,p=u(c.links);try{for(p.s();!(d=p.n()).done;){var v=d.value;this.highlighted_links[v]=!0}}catch(e){p.e(e)}finally{p.f()}}}}catch(e){h.e(e)}finally{h.f()}}}}}catch(e){i.e(e)}finally{i.f()}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},{key:"deselectNode",value:function(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs){var t,n=u(e.inputs);try{for(n.s();!(t=n.n()).done;){var i=t.value;delete this.highlighted_links[i.link]}}catch(e){n.e(e)}finally{n.f()}}if(e.outputs){var s,o=u(e.outputs);try{for(o.s();!(s=o.n()).done;){var a=s.value;if(a.links){var r,l=u(a.links);try{for(l.s();!(r=l.n()).done;){var h=r.value;delete this.highlighted_links[h]}}catch(e){l.e(e)}finally{l.f()}}}}catch(e){o.e(e)}finally{o.f()}}}}},{key:"deselectAllNodes",value:function(){if(this.graph){var e,t=u(this.graph._nodes);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.is_selected&&(n.onDeselected&&n.onDeselected(),n.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(n))}}catch(e){t.e(e)}finally{t.f()}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}}},{key:"deleteSelectedNodes",value:function(){for(var e in this.graph.beforeChange(),this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&y(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var n=t.graph.links[t.inputs[0].link],i=t.graph.links[t.outputs[0].links[0]],s=t.getInputNode(0),o=t.getOutputNodes(0)[0];s&&o&&s.connect(n.origin_slot,o,i.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}},{key:"centerOnNode",value:function(e){this.ds.offset[0]=-e.pos[0]-.5*e.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-e.pos[1]-.5*e.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}},{key:"adjustMouseEvent",value:function(e){if(this.canvas){var t=this.canvas.getBoundingClientRect();e.localX=e.clientX-t.left,e.localY=e.clientY-t.top}else e.localX=e.clientX,e.localY=e.clientY;e.deltaX=e.localX-this.last_mouse_position[0],e.deltaY=e.localY-this.last_mouse_position[1],this.last_mouse_position[0]=e.localX,this.last_mouse_position[1]=e.localY,e.canvasX=e.localX/this.ds.scale-this.ds.offset[0],e.canvasY=e.localY/this.ds.scale-this.ds.offset[1]}},{key:"setZoom",value:function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}},{key:"convertOffsetToCanvas",value:function(e){return this.ds.convertOffsetToCanvas(e)}},{key:"convertCanvasToOffset",value:function(e,t){return this.ds.convertCanvasToOffset(e,t)}},{key:"convertEventToCanvasOffset",value:function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])}},{key:"bringToFront",value:function(e){var t=this.graph._nodes.indexOf(e);-1!==t&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))}},{key:"sendToBack",value:function(e){var t=this.graph._nodes.indexOf(e);-1!==t&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))}},{key:"computeVisibleNodes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.graph._nodes,t=arguments.length>1?arguments[1]:void 0,n=t||[];n.length=0;var i,s=u(e);try{for(s.s();!(i=s.n()).done;){var o=i.value;console.log(e,this.graph._nodes),(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(C(this.visible_area,o.getBounding(w))&&n.push(o))}}catch(e){s.e(e)}finally{s.f()}return n}},{key:"draw",value:function(e,t){if(this.canvas&&0!==this.canvas.width&&0!==this.canvas.height){var n=d();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}}},{key:"drawFrontCanvas",value:function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){e.start2D&&e.start2D();var t=this.canvas;if(e.restore(),e.setTransform(1,0,0,1,0,0),this.dirty_area&&(e.save(),e.beginPath(),e.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),e.clip()),this.clear_background&&e.clearRect(0,0,t.width,t.height),this.bgcanvas===this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e),this.graph){e.save(),this.ds.toCanvasContext(e);var n,i=u(this.computeVisibleNodes(null,this.visible_nodes));try{for(i.s();!(n=i.n()).done;){var s=n.value;e.save(),e.translate(s.pos[0],s.pos[1]),this.drawNode(s,e),1,e.restore()}}catch(e){i.e(e)}finally{i.f()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&!this.live_mode&&this.drawConnections(e),null!==this.connecting_pos){e.lineWidth=this.connections_width;var o=null;switch(this.connecting_output.type){case c.EVENT:o=c.EVENT_LINK_COLOR;break;default:o=c.CONNECTING_LINK_COLOR}this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,this.connecting_output.dir||(this.connecting_node.horizontal?c.DOWN:c.RIGHT),c.CENTER),e.beginPath(),this.connecting_output.type===c.EVENT||this.connecting_output.shape===c.BOX_SHAPE?e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),e.fill(),e.fillStyle="#ffcc00",this._highlight_input&&(e.beginPath(),e.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),this.dirty_area&&e.restore(),e.finish2D&&e.finish2D()}}},{key:"drawSubgraphPanel",value:function(e){var t=this.graph,n=t._subgraph_node;if(n){var i=n.inputs?n.inputs.length:0,s=300,o=Math.floor(1.6*c.NODE_SLOT_HEIGHT);if(e.fillStyle="#111",e.globalAlpha=.8,e.beginPath(),e.roundRect(10,10,s,(i+1)*o+50,8),e.fill(),e.globalAlpha=1,e.fillStyle="#888",e.font="14px Arial",e.textAlign="left",e.fillText("Graph Inputs",20,34),this.drawButton(280,20,20,20,"X","#151515"))this.closeSubgraph();else{var a=50;if(e.font="20px Arial",n.inputs){var r,l=u(n.inputs);try{for(l.s();!(r=l.n()).done;){var h=r.value;if(!h.not_subgraph_input){if(this.drawButton(20,a+2,280,o-2)){var d=n.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=createNode(d);p?(t.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",h.name),p.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",d)}e.fillStyle="#9C9",e.beginPath(),e.arc(284,a+.5*o,5,0,2*Math.PI),e.fill(),e.fillStyle="#AAA",e.fillText(h.name,50,a+.75*o);var v=e.measureText(h.name);e.fillStyle="#777",e.fillText(h.type,50+v.width+10,a+.75*o),a+=o}}}catch(e){l.e(e)}finally{l.f()}}this.drawButton(20,a+2,280,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(n)}}else console.warn("subgraph without subnode")}},{key:"drawButton",value:function(e,t,n,i,s){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:c.NODE_DEFAULT_COLOR,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"#555",r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:c.NODE_TEXT_COLOR,l=this.ctx,h=this.mouse,u=T(h[0],h[1],e,t,n,i),d=(h=this.last_click_position)&&T(h[0],h[1],e,t,n,i);return l.fillStyle=u?a:o,d&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,n,i,4),l.fill(),null!==s&&s.constructor===String&&(l.fillStyle=r,l.textAlign="center",l.font="".concat(.65*i|0,"px Arial"),l.fillText(s,e+.5*n,t+.75*i),l.textAlign="left"),d&&this.blockClick(),d&&!this.block_click}},{key:"isAreaClicked",value:function(e,t,n,i,s){var o=this.last_click_position,a=o&&T(o[0],o[1],e,t,n,i);return a&&s&&this.blockClick(),a&&!this.block_click}},{key:"renderInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.canvas.height-80;e.save(),e.translate(t,n),e.font="10px Arial",e.fillStyle="#888",this.graph?(e.fillText("T: ".concat(this.graph.globaltime.toFixed(2),"s"),5,13),e.fillText("I: ".concat(this.graph.iteration),5,26),e.fillText("N: ".concat(this.graph._nodes.length," [").concat(this.visible_nodes.length,"]"),5,39),e.fillText("V: ".concat(this.graph._version),5,52),e.fillText("FPS:".concat(this.fps.toFixed(2)),5,65)):e.fillText("No graph selected",5,13),e.restore()}},{key:"drawBackCanvas",value:function(){var e=this,t=this.bgcanvas;t.width===this.canvas.width&&t.height===this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var n=this.bgctx;if(n.start&&n.start(),this.clear_background&&n.clearRect(0,0,t.width,t.height),this._graph_stack&&this._graph_stack.length){n.save();var i=this.graph._subgraph_node;n.strokeStyle=i.bgcolor,n.lineWidth=10,n.strokeRect(1,1,t.width-2,t.height-2),n.lineWidth=1,n.font="40px Arial",n.textAlign="center",n.fillStyle=i.bgcolor||"#AAA";var s,o="",a=u(this._graph_stack);try{for(a.s();!(s=a.n()).done;){var r=s.value;o+="".concat(r._subgraph_node.getTitle()," >> ")}}catch(e){a.e(e)}finally{a.f()}n.fillText(o+i.getTitle(),.5*t.width,40),n.restore()}var l=!1;if(this.onRenderBackground&&(l=this.onRenderBackground(t,n)),n.restore(),n.setTransform(1,0,0,1,0,0),this.visible_links.length=0,this.graph){if(n.save(),this.ds.toCanvasContext(n),this.background_image&&this.ds.scale>.5&&!l){n.globalAlpha=this.zoom_modify_alpha?(1-.5/this.ds.scale)*this.editor_alpha:this.editor_alpha,n.imageSmoothingEnabled=!1,n.mozImageSmoothingEnabled=!1,n.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.id===this.background_image||(this._bg_img=new Image,this._bg_img.id=this.background_image,this._bg_img.src=this.background_image,this._bg_img.onload=function(){return e.draw(!0,!0)});var h=null;null==this._pattern&&this._bg_img.width>0?(h=n.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=h):h=this._pattern,h&&(n.fillStyle=h,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),n.fillStyle="transparent"),n.globalAlpha=1,n.imageSmoothingEnabled=!0,n.mozImageSmoothingEnabled=!0,n.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,n),this.onDrawBackground&&this.onDrawBackground(n,this.visible_area),this.render_canvas_border&&(n.strokeStyle="#235",n.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(n.shadowColor="#000",n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=6):n.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(n),n.shadowColor="rgba(0,0,0,0)",n.restore()}n.finish&&n.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}},{key:"drawNode",value:function(e,t){this.current_node=e;var n=e.color||e.constructor.color||c.NODE_DEFAULT_COLOR,i=e.bgcolor||e.constructor.bgcolor||c.NODE_DEFAULT_BGCOLOR;e.mouseOver;var s=this.ds.scale<.6;if(this.live_mode)e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));else if(t.globalAlpha=this.editor_alpha,this.render_shadows&&!s?(t.shadowColor=c.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!e.flags.collapsed||!e.onDrawCollapsed||1!=e.onDrawCollapsed(t,this)){var o=e._shape||c.BOX_SHAPE,a=N;N.set(e.size);var r=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;var l=e.getTitle?e.getTitle():e.title;null!==l&&(e._collapsed_width=Math.min(e.size[0],t.measureText(l).width+2*c.NODE_TITLE_HEIGHT),a[0]=e._collapsed_width,a[1]=0)}e.clip_area&&(t.save(),t.beginPath(),o===c.BOX_SHAPE?t.rect(0,0,a[0],a[1]):o===c.ROUND_SHAPE?t.roundRect(0,0,a[0],a[1],10):o===c.CIRCLE_SHAPE&&t.arc(.5*a[0],.5*a[1],.5*a[0],0,2*Math.PI),t.clip()),e.has_errors&&(i="red"),this.drawNodeShape(e,t,a,n,i,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=r?"center":"left",t.font=this.inner_text_font;var h=!s,d=this.connecting_output;t.lineWidth=1;var p=0,v=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var g,f=null,_=null;if(e.inputs){var m,b=u(e.inputs);try{for(b.s();!(m=b.n()).done;){var k=m.value;if(null!=k.link){f=k,g=k;break}}}catch(e){b.e(e)}finally{b.f()}}if(e.outputs){var E,T=u(e.outputs);try{for(T.s();!(E=T.n()).done;){var C=E.value;C.links&&C.links.length&&(_=C,g=C)}}catch(e){T.e(e)}finally{T.f()}}if(f){var w=0,O=-.5*c.NODE_TITLE_HEIGHT;r&&(w=.5*e._collapsed_width,O=-c.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),g.type===c.EVENT||g.shape===c.BOX_SHAPE?t.rect(w-7+.5,O-4,14,8):g.shape===c.ARROW_SHAPE?(t.moveTo(w+8,O),t.lineTo(w+-4,O-4),t.lineTo(w+-4,O+4),t.closePath()):t.arc(w,O,4,0,2*Math.PI),t.fill()}if(_){var S=e._collapsed_width,I=-.5*c.NODE_TITLE_HEIGHT;r&&(S=.5*e._collapsed_width,I=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),g.type===c.EVENT||g.shape===c.BOX_SHAPE?t.rect(S-7+.5,I-4,14,8):slot.shape===c.ARROW_SHAPE?(t.moveTo(S+6,I),t.lineTo(S-6,I-4),t.lineTo(S-6,I+4),t.closePath()):t.arc(S,I,4,0,2*Math.PI),t.fill()}}}else{if(e.inputs)for(var A=0;A<e.inputs.length;A++){var D=e.inputs[A];t.globalAlpha=this.editor_alpha,this.connecting_node&&!y(D.type,d.type)&&(t.globalAlpha=.4*this.editor_alpha),t.fillStyle=D.link?D.color_on||this.default_connection_color.input_on:D.color_off||this.default_connection_color.input_off;var L=e.getConnectionPos(!0,A,v);if(L[0]-=e.pos[0],L[1]-=e.pos[1],p<L[1]+.5*c.NODE_SLOT_HEIGHT&&(p=L[1]+.5*c.NODE_SLOT_HEIGHT),t.beginPath(),D.type===c.EVENT||D.shape===c.BOX_SHAPE?r?t.rect(L[0]-5+.5,L[1]-8+.5,10,14):t.rect(L[0]-6+.5,L[1]-5+.5,14,10):D.shape===c.ARROW_SHAPE?(t.moveTo(L[0]+8,L[1]+.5),t.lineTo(L[0]-4,L[1]+6+.5),t.lineTo(L[0]-4,L[1]-6+.5),t.closePath()):s?t.rect(L[0]-4,L[1]-4,8,8):t.arc(L[0],L[1],4,0,2*Math.PI),t.fill(),h){var x=null!==D.label?D.label:D.name;x&&(t.fillStyle=c.NODE_TEXT_COLOR,r||D.dir===c.UP?t.fillText(x,L[0],L[1]-10):t.fillText(x,L[0]+10,L[1]+5))}}if(this.connecting_node&&(t.globalAlpha=.4*this.editor_alpha),t.textAlign=r?"center":"right",t.strokeStyle="black",e.outputs)for(var P=0;P<e.outputs.length;P++){var M=e.outputs[P],R=e.getConnectionPos(!1,P,v);if(R[0]-=e.pos[0],R[1]-=e.pos[1],p<R[1]+.5*c.NODE_SLOT_HEIGHT&&(p=R[1]+.5*c.NODE_SLOT_HEIGHT),t.fillStyle=M.links&&M.links.length?M.color_on||this.default_connection_color.output_on:M.color_off||this.default_connection_color.output_off,t.beginPath(),M.type===c.EVENT||M.shape===c.BOX_SHAPE?r?t.rect(R[0]-5+.5,R[1]-8+.5,10,14):t.rect(R[0]-6+.5,R[1]-5+.5,14,10):M.shape===c.ARROW_SHAPE?(t.moveTo(R[0]+8,R[1]+.5),t.lineTo(R[0]-4,R[1]+6+.5),t.lineTo(R[0]-4,R[1]-6+.5),t.closePath()):s?t.rect(R[0]-4,R[1]-4,8,8):t.arc(R[0],R[1],4,0,2*Math.PI),t.fill(),s||t.stroke(),h){var H=null!=M.label?M.label:M.name;H&&(t.fillStyle=c.NODE_TEXT_COLOR,r||M.dir===c.DOWN?t.fillText(H,R[0],R[1]-8):t.fillText(H,R[0]-10,R[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var G=p;(r||e.widgets_up)&&(G=2),null!==e.widgets_start_y&&(G=e.widgets_start_y),this.drawNodeWidgets(e,G,t,this.node_widget&&this.node_widget[0]===e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}}},{key:"drawLinkTooltip",value:function(e,t){var n=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(n[0],n[1],3,0,2*Math.PI),e.fill(),!(null==t.data||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,t,this))){var i,s=t.data;if(i=s.constructor===Number?s.toFixed(2):s.constructor===String?'"'.concat(s,'"'):s.constructor===Boolean?String(s):s.toToolTip?s.toToolTip():"[".concat(s.constructor.name,"]")){i=i.substr(0,30),e.font="14px Courier New";var o=e.measureText(i).width+20;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(n[0]-.5*o,n[1]-15-24,o,24,3,3),e.moveTo(n[0]-10,n[1]-15),e.lineTo(n[0]+10,n[1]-15),e.lineTo(n[0],n[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(i,n[0],n[1]-15-24*.3)}}}},{key:"drawNodeShape",value:function(t,n,i,s,o,a,r){n.strokeStyle=s,n.fillStyle=o;var l=c.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,u=t._shape||t.constructor.shape||c.ROUND_SHAPE,d=t.constructor.title_mode,p=!0;d===c.TRANSPARENT_TITLE?p=!1:d===c.AUTOHIDE_TITLE&&r&&(p=!0);var v=O;v[0]=0,v[1]=p?-l:0,v[2]=i[0]+1,v[3]=p?i[1]+l:i[1];var g=n.globalAlpha;if(n.beginPath(),u===c.BOX_SHAPE||h?n.fillRect(v[0],v[1],v[2],v[3]):u===c.ROUND_SHAPE||u===c.CARD_SHAPE?n.roundRect(v[0],v[1],v[2],v[3],this.round_radius,u===c.CARD_SHAPE?0:this.round_radius):u===c.CIRCLE_SHAPE&&n.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),n.fill(),t.flags.collapsed||(n.shadowColor="transparent",n.fillStyle="rgba(0,0,0,0.2)",n.fillRect(0,-1,v[2],2)),n.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(n,this,this.canvas,this.graph_mouse),p||d===c.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(n,l,i,this.ds.scale,s);else if(d!==c.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var f=t.constructor.title_color||s;if(t.flags.collapsed&&(n.shadowColor=c.DEFAULT_SHADOW_COLOR),this.use_gradients){var _=e.gradients[f];_||(_=n.createLinearGradient(0,0,400,0),e.gradients[f]=_,_.addColorStop(0,f),_.addColorStop(1,"#000")),n.fillStyle=_}else n.fillStyle=f;n.beginPath(),u===c.BOX_SHAPE||h?n.rect(0,-l,i[0]+1,l):u!==c.ROUND_SHAPE&&u!==c.CARD_SHAPE||n.roundRect(0,-l,i[0]+1,l,this.round_radius,t.flags.collapsed?this.round_radius:0),n.fill(),n.shadowColor="transparent"}var y=10;if(t.onDrawTitleBox?t.onDrawTitleBox(n,l,i,this.ds.scale):[c.ROUND_SHAPE,c.CIRCLE_SHAPE,c.CARD_SHAPE].includes(u)?(h&&(n.fillStyle="black",n.beginPath(),n.arc(.5*l,-.5*l,6,0,2*Math.PI),n.fill()),n.fillStyle=t.boxcolor||c.NODE_DEFAULT_BOXCOLOR,h?n.fillRect(.5*l-5,-.5*l-5,y,y):(n.beginPath(),n.arc(.5*l,-.5*l,5,0,2*Math.PI),n.fill())):(h&&(n.fillStyle="black",n.fillRect(.5*(l-y)-1,-.5*(l+y)-1,12,12)),n.fillStyle=t.boxcolor||c.NODE_DEFAULT_BOXCOLOR,n.fillRect(.5*(l-y),-.5*(l+y),y,y)),n.globalAlpha=g,t.onDrawTitleText&&t.onDrawTitleText(n,l,i,this.ds.scale,this.title_text_font,a),!h){n.font=this.title_text_font;var m=String(t.getTitle());m&&(n.fillStyle=a?c.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(n.textAlign="left",n.measureText(m),n.fillText(m.substr(0,20),l,c.NODE_TITLE_TEXT_Y-l),n.textAlign="left"):(n.textAlign="left",n.fillText(m,l,c.NODE_TITLE_TEXT_Y-l)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var b=c.NODE_TITLE_HEIGHT,k=t.size[0]-b,E=T(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],k+2,2-b,b-4,b-4);n.fillStyle=E?"#888":"#555",u===c.BOX_SHAPE||h?n.fillRect(k+2,2-b,b-4,b-4):(n.beginPath(),n.roundRect(k+2,2-b,b-4,b-4,4),n.fill()),n.fillStyle="#333",n.beginPath(),n.moveTo(k+.2*b,.6*-b),n.lineTo(k+.8*b,.6*-b),n.lineTo(k+.5*b,.3*-b),n.fill()}t.onDrawTitle&&t.onDrawTitle(n)}a&&(t.onBounding&&t.onBounding(v),d===c.TRANSPARENT_TITLE&&(v[1]-=l,v[3]+=l),n.lineWidth=1,n.globalAlpha=.8,n.beginPath(),u===c.BOX_SHAPE?n.rect(-6+v[0],-6+v[1],12+v[2],12+v[3]):u===c.ROUND_SHAPE||u===c.CARD_SHAPE&&t.flags.collapsed?n.roundRect(-6+v[0],-6+v[1],12+v[2],12+v[3],2*this.round_radius):u===c.CARD_SHAPE?n.roundRect(-6+v[0],-6+v[1],12+v[2],12+v[3],2*this.round_radius,2):u===c.CIRCLE_SHAPE&&n.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),n.strokeStyle=c.NODE_BOX_OUTLINE_COLOR,n.stroke(),n.strokeStyle=s,n.globalAlpha=1)}},{key:"drawConnections",value:function(e){var t=d(),n=this.visible_area;S[0]=n[0]-20,S[1]=n[1]-20,S[2]=n[2]+40,S[3]=n[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;var i,s=u(this.graph._nodes);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.inputs&&o.inputs.length)for(var a=0;a<o.inputs.length;++a){var r=o.inputs[a];if(r&&null!=r.link){var l=r.link,h=this.graph.links[l];if(h){var p=this.graph.getNodeById(h.origin_id);if(p){var v=h.origin_slot,g=null;g=-1===v?[p.pos[0]+10,p.pos[1]+10]:p.getConnectionPos(!1,v,A);var f=o.getConnectionPos(!0,a,D);if(I[0]=g[0],I[1]=g[1],I[2]=f[0]-g[0],I[3]=f[1]-g[1],I[2]<0&&(I[0]+=I[2],I[2]=Math.abs(I[2])),I[3]<0&&(I[1]+=I[3],I[3]=Math.abs(I[3])),C(I,S)){var _=p.outputs[v],y=o.inputs[a];if(_&&y){var m=_.dir||(p.horizontal?c.DOWN:c.RIGHT),b=y.dir||(o.horizontal?c.UP:c.LEFT);if(this.renderLink(e,g,f,h,!1,0,null,m,b),h&&h._last_time&&t-h._last_time<1e3){var k=2-.002*(t-h._last_time),E=e.globalAlpha;e.globalAlpha=E*k,this.renderLink(e,g,f,h,!0,k,"white",m,b),e.globalAlpha=E}}}}}}}}}catch(e){s.e(e)}finally{s.f()}e.globalAlpha=1}},{key:"renderLink",value:function(t,n,i,s,o,a,r,l,h,u){s&&this.visible_links.push(s),!r&&s&&(r=s.color||e.link_type_colors[s.type]),r||(r=this.default_link_color),null!=s&&this.highlighted_links[s.id]&&(r="#FFF"),l=l||c.RIGHT,h=h||c.LEFT;var p=distance(n,i);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(u=u||1)>1&&(t.lineWidth=.5),t.beginPath();for(var v=0;v<u;v+=1){var g=5*(v-.5*(u-1));if(this.links_render_mode===c.SPLINE_LINK){t.moveTo(n[0],n[1]+g);var f=0,_=0,y=0,m=0;switch(l){case c.LEFT:f=-.25*p;break;case c.RIGHT:f=.25*p;break;case c.UP:_=-.25*p;break;case c.DOWN:_=.25*p}switch(h){case c.LEFT:y=-.25*p;break;case c.RIGHT:y=.25*p;break;case c.UP:m=-.25*p;break;case c.DOWN:m=.25*p}t.bezierCurveTo(n[0]+f,n[1]+_+g,i[0]+y,i[1]+m+g,i[0],i[1]+g)}else if(this.links_render_mode===c.LINEAR_LINK){t.moveTo(n[0],n[1]+g);var b=0,k=0,E=0,T=0;switch(l){case c.LEFT:b=-1;break;case c.RIGHT:b=1;break;case c.UP:k=-1;break;case c.DOWN:k=1}switch(h){case c.LEFT:E=-1;break;case c.RIGHT:E=1;break;case c.UP:T=-1;break;case c.DOWN:T=1}t.lineTo(n[0]+15*b,n[1]+15*k+g),t.lineTo(i[0]+15*E,i[1]+15*T+g),t.lineTo(i[0],i[1]+g)}else{if(this.links_render_mode!==c.STRAIGHT_LINK)return;t.moveTo(n[0],n[1]);var C=n[0],w=n[1],N=i[0],O=i[1];l===c.RIGHT?C+=10:w+=10,h===c.LEFT?N-=10:O-=10,t.lineTo(C,w),t.lineTo(.5*(C+N),w),t.lineTo(.5*(C+N),O),t.lineTo(N,O),t.lineTo(i[0],i[1])}}this.render_connections_border&&this.ds.scale>.6&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=r,t.strokeStyle=r,t.stroke();var S=this.computeConnectionPoint(n,i,.5,l,h);if(s&&s._pos&&(s._pos[0]=S[0],s._pos[1]=S[1]),this.ds.scale>=.6&&this.highquality_render&&h!==c.CENTER){if(this.render_connection_arrows){var I=this.computeConnectionPoint(n,i,.25,l,h),A=this.computeConnectionPoint(n,i,.26,l,h),D=this.computeConnectionPoint(n,i,.75,l,h),L=this.computeConnectionPoint(n,i,.76,l,h),x=0,P=0;this.render_curved_connections?(x=-Math.atan2(A[0]-I[0],A[1]-I[1]),P=-Math.atan2(L[0]-D[0],L[1]-D[1])):P=x=i[1]>n[1]?0:Math.PI,t.save(),t.translate(I[0],I[1]),t.rotate(x),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(D[0],D[1]),t.rotate(P),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(pos[0],pos[1],5,0,2*Math.PI),t.fill()}if(a){t.fillStyle=r;for(var M=0;M<5;++M){var R=(.001*d()+.2*M)%1,H=this.computeConnectionPoint(n,i,R,l,h);t.beginPath(),t.arc(H[0],H[1],5,0,2*Math.PI),t.fill()}}}},{key:"computeConnectionPoint",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c.RIGHT,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:c.LEFT,o=distance(e,t),a=e,r=[e[0],e[1]],l=[t[0],t[1]],h=t;switch(i){case c.LEFT:r[0]+=-.25*o;break;case c.RIGHT:r[0]+=.25*o;break;case c.UP:r[1]+=-.25*o;break;case c.DOWN:r[1]+=.25*o}switch(s){case c.LEFT:l[0]+=-.25*o;break;case c.RIGHT:l[0]+=.25*o;break;case c.UP:l[1]+=-.25*o;break;case c.DOWN:l[1]+=.25*o}var u=(1-n)*(1-n)*(1-n),d=(1-n)*(1-n)*3*n,p=3*(1-n)*(n*n),v=n*n*n,g=u*a[0]+d*r[0]+p*l[0]+v*h[0],f=u*a[1]+d*r[1]+p*l[1]+v*h[1];return[g,f]}},{key:"drawExecutionOrder",value:function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;var t,n=u(this.visible_nodes);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.fillStyle="black",e.fillRect(i.pos[0]-c.NODE_TITLE_HEIGHT,i.pos[1]-c.NODE_TITLE_HEIGHT,c.NODE_TITLE_HEIGHT,c.NODE_TITLE_HEIGHT),0===i.order&&e.strokeRect(i.pos[0]-c.NODE_TITLE_HEIGHT+.5,i.pos[1]-c.NODE_TITLE_HEIGHT+.5,c.NODE_TITLE_HEIGHT,c.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(i.order,i.pos[0]+-.5*c.NODE_TITLE_HEIGHT,i.pos[1]-6)}}catch(e){n.e(e)}finally{n.f()}e.globalAlpha=1}},{key:"drawNodeWidgets",value:function(e,t,n,i){if(!e.widgets||!e.widgets.length)return 0;var s=e.size[0],o=e.widgets;t+=2;var a=c.NODE_WIDGET_HEIGHT,r=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;var l,h=c.WIDGET_OUTLINE_COLOR,d=c.WIDGET_BGCOLOR,p=c.WIDGET_TEXT_COLOR,v=c.WIDGET_SECONDARY_TEXT_COLOR,g=15,f=u(o);try{for(f.s();!(l=f.n()).done;){var _=l.value,y=t;_.y&&(y=_.y),_.last_y=y,n.strokeStyle=h,n.fillStyle="#222",n.textAlign="left",_.disabled&&(n.globalAlpha*=.5);var m=_.width||s;switch(_.type){case"button":_.clicked&&(n.fillStyle="#AAA",_.clicked=!1,this.dirty_canvas=!0),n.fillRect(g,y,m-30,a),r&&!_.disabled&&n.strokeRect(g,y,m-30,a),r&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.name,.5*m,y+.7*a));break;case"toggle":n.textAlign="left",n.strokeStyle=h,n.fillStyle=d,n.beginPath(),r?n.roundRect(g,t,m-30,a,.5*a):n.rect(g,t,m-30,a),n.fill(),r&&!_.disabled&&n.stroke(),n.fillStyle=_.value?"#89A":"#333",n.beginPath(),n.arc(m-30,y+.5*a,.36*a,0,2*Math.PI),n.fill(),r&&(n.fillStyle=v,_.name&&n.fillText(_.name,30,y+.7*a),n.fillStyle=_.value?p:v,n.textAlign="right",n.fillText(_.value?_.options.on||"true":_.options.off||"false",m-40,y+.7*a));break;case"slider":n.fillStyle=d,n.fillRect(g,y,m-30,a);var b=_.options.max-_.options.min,k=(_.value-_.options.min)/b;if(n.fillStyle=i===_?"#89A":"#678",n.fillRect(g,y,k*(m-30),a),r&&!_.disabled&&n.strokeRect(g,y,m-30,a),_.marker){var E=(_.marker-_.options.min)/b;n.fillStyle="#AA9",n.fillRect(g+E*(m-30),y,2,a)}r&&(n.textAlign="center",n.fillStyle=p,n.fillText("".concat(_.name,"  ").concat(Number(_.value).toFixed(3)),.5*m,y+.7*a));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=h,n.fillStyle=d,n.beginPath(),r?n.roundRect(g,t,m-30,a,.5*a):n.rect(g,t,m-30,a),n.fill(),r)if(_.disabled||n.stroke(),n.fillStyle=p,_.disabled||(n.beginPath(),n.moveTo(31,t+5),n.lineTo(21,t+.5*a),n.lineTo(31,t+a-5),n.fill(),n.beginPath(),n.moveTo(m-g-16,t+5),n.lineTo(m-g-6,t+.5*a),n.lineTo(m-g-16,t+a-5),n.fill()),n.fillStyle=v,n.fillText(_.name,35,y+.7*a),n.fillStyle=p,n.textAlign="right","number"===_.type)n.fillText(Number(_.value).toFixed(void 0!==_.options.precision?_.options.precision:3),m-30-20,y+.7*a);else{var T=_.value;if(_.options.values){var C=_.options.values;C.constructor===Function&&(C=C()),C&&C.constructor!==Array&&(T=C[_.value])}n.fillText(T,m-30-20,y+.7*a)}break;case"string":case"text":n.textAlign="left",n.strokeStyle=h,n.fillStyle=d,n.beginPath(),r?n.roundRect(g,t,m-30,a,.5*a):n.rect(g,t,m-30,a),n.fill(),r&&(_.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(g,t,m-30,a),n.clip(),n.fillStyle=v,_.name&&n.fillText(_.name,30,y+.7*a),n.fillStyle=p,n.textAlign="right",n.fillText(String(_.value).substr(0,30),m-30,y+.7*a),n.restore());break;default:_.draw&&_.draw(n,e,m,y,a)}t+=(_.computeSize?_.computeSize(m)[1]:a)+4,n.globalAlpha=this.editor_alpha}}catch(e){f.e(e)}finally{f.f()}n.restore(),n.textAlign="left"}},{key:"processNodeWidgets",value:function(e,n,i,s){var o=this;if(!e.widgets||!e.widgets.length)return null;var a,r=n[0]-e.pos[0],l=n[1]-e.pos[1],h=e.size[0],d=this.getCanvasWindow(),p=u(e.widgets);try{var v=function(){var t=a.value;if(!t||t.disabled)return"continue";var u=t.computeSize?t.computeSize(h)[1]:c.NODE_WIDGET_HEIGHT,p=t.width||h;if(t!==s&&(r<6||r>p-12||l<t.last_y||l>t.last_y+u))return"continue";var v=t.value;switch(t.type){case"button":if("mousemove"===i.type)break;t.callback&&setTimeout((function(){return t.callback(t,o,e,n,i)}),20),t.clicked=!0,o.dirty_canvas=!0;break;case"slider":t.options.max,t.options.min;var g=Math.clamp((r-15)/(p-30),0,1);t.value=t.options.min+(t.options.max-t.options.min)*g,t.callback&&setTimeout((function(){return _(t,t.value)}),20),o.dirty_canvas=!0;break;case"number":case"combo":var y=t.value;if("mousemove"===i.type&&"number"===t.type)t.value+=.1*i.deltaX*(t.options.step||1),t.options.min&&t.value<t.options.min&&(t.value=t.options.min),t.options.max&&t.value>t.options.max&&(t.value=t.options.max);else if("mousedown"===i.type){var m=t.options.values;m&&m.constructor===Function&&(m=t.options.values(t,e));var b=[];"number"!==t.type&&(b=m.constructor===Array?m:Object.keys(m));var k=r<40?-1:r>p-40?1:0;if("number"===t.type)t.value+=.1*k*(t.options.step||1),null!=t.options.min&&t.value<t.options.min&&(t.value=t.options.min),null!=t.options.max&&t.value>t.options.max&&(t.value=t.options.max);else if(k){var T=-1;o.last_mouseclick=0,(T=m.constructor===Object?b.indexOf(String(t.value))+k:b.indexOf(t.value)+k)>=b.length&&(T=b.length-1),T<0&&(T=0),m.constructor===Array?t.value=m[T]:t.value=T}else{var C=m!==b?Object.values(m):m;new E(C,{scale:Math.max(1,o.ds.scale),event:i,className:"dark",callback:function(e,t,n){return m!=b&&(e=C.indexOf(e)),this.value=e,_(this,e),f.dirty_canvas=!0,!1}.bind(t)},d)}}else if("mouseup"===i.type&&"number"===t.type){var w=r<40?-1:r>p-40?1:0;i.click_time<200&&0==w&&o.prompt("Value",t.value,(function(e){o.value=Number(e),_(o,o.value)}),i)}y!==t.value&&setTimeout((function(){_(o,o.value)}),20),o.dirty_canvas=!0;break;case"toggle":"mousedown"===i.type&&(t.value=!t.value,setTimeout((function(){_(t,t.value)}),20));break;case"string":case"text":"mousedown"===i.type&&o.prompt("Value",t.value,(function(e){o.value=e,_(o,e)}),i,!!t.options&&t.options.multiline);break;default:t.mouse&&(o.dirty_canvas=t.mouse(i,[r,l],e))}return v!==t.value&&(e.onWidgetChanged&&e.onWidgetChanged(t.name,t.value,v,t),e.graph._version++),{v:t}};for(p.s();!(a=p.n()).done;){var g=v();if("continue"!==g&&"object"===t(g))return g.v}}catch(e){p.e(e)}finally{p.f()}var f=this;function _(t,s){t.value=s,t.options&&t.options.property&&void 0!==e.properties[t.options.property]&&e.setProperty(t.options.property,s),t.callback&&t.callback(t.value,f,e,n,i)}return null}},{key:"drawGroups",value:function(e,t){if(this.graph){var n=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;var i,s=u(n);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(C(this.visible_area,o._bounding)){t.fillStyle=o.color||"#335",t.strokeStyle=o.color||"#335";var a=o._pos,r=o._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(a[0]+.5,a[1]+.5,r[0],r[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(a[0]+r[0],a[1]+r[1]),t.lineTo(a[0]+r[0]-10,a[1]+r[1]),t.lineTo(a[0]+r[0],a[1]+r[1]-10),t.fill();var l=o.font_size||c.DEFAULT_GROUP_FONT_SIZE;t.font="".concat(l,"px Arial"),t.fillText(o.title,a[0]+4,a[1]+l)}}}catch(e){s.e(e)}finally{s.f()}t.restore()}}},{key:"adjustNodesSize",value:function(){var e,t=u(this.graph._nodes);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.size=n.computeSize()}}catch(e){t.e(e)}finally{t.f()}this.setDirty(!0,!0)}},{key:"resize",value:function(e,t){if(!e&&!t){var n=this.canvas.parentNode;e=n.offsetWidth,t=n.offsetHeight}this.canvas.width===e&&this.canvas.height===t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}},{key:"switchLiveMode",value:function(e){var t=this;if(!e)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){t.editor_alpha*=n,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,n<1&&t.editor_alpha<.01&&(clearInterval(i),n<1&&(t.live_mode=!0)),n>1&&t.editor_alpha>.99&&(clearInterval(i),t.editor_alpha=1)}),1)}},{key:"onNodeSelectionChange",value:function(e){}},{key:"touchHandler",value:function(e){var t=e.changedTouches[0],n="";switch(e.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=this.getCanvasWindow(),s=i.document.createEvent("MouseEvent");s.initMouseEvent(n,!0,!0,i,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(s),e.preventDefault()}},{key:"showLinkMenu",value:function(t,n){var i=this,s=new E(["Add Node",null,"Delete"],{event:n,title:null!=t.data?t.data.constructor.name:null,callback:function(n,o,a){switch(n){case"Add Node":e.onMenuAdd(null,null,a,s,(function(e){console.log("node autoconnect");var n=i.graph.getNodeById(t.origin_id),s=i.graph.getNodeById(t.target_id);e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&n.outputs[t.origin_slot].type===e.inputs[0].type&&e.outputs[0].type===s.inputs[0].type&&(n.connect(t.origin_slot,e,0),e.connect(0,s,t.target_slot),e.pos[0]-=.5*e.size[0])}));break;case"Delete":i.graph.removeLink(t.id)}}});return!1}},{key:"prompt",value:function(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1?arguments[1]:void 0,s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,r=!1,l=document.createElement("div");l.className="graphdialog rounded",l.innerHTML=a?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",l.close=function(){t.prompt_box=null,l.parentNode&&l.parentNode.removeChild(l)},this.ds.scale>1&&(l.style.transform="scale(".concat(this.ds.scale,")")),l.addEventListener("mouseleave",(function(e){r||l.close()})),this.prompt_box&&this.prompt_box.close(),this.prompt_box=l;var h=l.querySelector(".name");h.innerText=n;var u=l.querySelector(".value");u.value=i;var c=u;c.addEventListener("keydown",(function(e){if(r=!0,27===e.keyCode)l.close();else{if(13!==e.keyCode||"textarea"===e.target.localName)return;s&&s(c.value),l.close()}e.preventDefault(),e.stopPropagation()}));var d=l.querySelector("button");d.addEventListener("click",(function(){s&&s(c.value),t.setDirty(!0),l.close()}));var p=e.active_canvas,v=p.canvas,g=v.getBoundingClientRect(),f=-20,_=-20;return g&&(f-=g.left,_-=g.top),o?(l.style.left="".concat(o.clientX+f,"px"),l.style.top="".concat(o.clientY+_,"px")):(l.style.left="".concat(.5*v.width+f,"px"),l.style.top="".concat(.5*v.height+_,"px")),v.parentNode.appendChild(l),setTimeout((function(){return c.focus()}),10),l}},{key:"showEditPropertyValue",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e&&void 0!==e.properties[t]){var i=e.getPropertyInfo(t),s=i.type,o="";if(["sring","number","array","object"].includes(s))o="<input autofocus type='text' class='value'/>";else if(["enum","combo"].includes(s)&&i.values){for(var a in o="<select autofocus type='text' class='value'>",i.values){var r=a;i.values.constructor===Array&&(r=i.values[a]),o+='<option value="'.concat(r,'" ').concat(r==e.properties[t]?"selected":"",">").concat(i.values[a],"</option>")}o+="</select>"}else{if("boolean"!==s)return void console.warn("unknown type: ".concat(s));o='<input autofocus type="checkbox" class="value" '.concat(e.properties[t]?"checked":"","/>")}var l=this.createDialog('<span class="name">'.concat(i.label?i.label:t,"</span>").concat(o,"<button>OK</button>"),n);if(["enum","combo"].includes(s)&&i.values){var h=l.querySelector("select");h.addEventListener("change",(function(e){v(e.target.value)}))}else if("boolean"===s){var u=l.querySelector("input");u&&u.addEventListener("click",(function(){return v(!!u.checked)}))}else{var c=l.querySelector("input");if(c){c.addEventListener("blur",(function(){c.focus()}));var d=void 0!==e.properties[t]?e.properties[t]:"";"string"!==s&&(d=JSON.stringify(d)),c.value=d,c.addEventListener("keydown",(function(e){13==e.keyCode&&(v(c.value),e.preventDefault(),e.stopPropagation())}))}}var p=l.querySelector("button");return p.addEventListener("click",(function(){return v(input.value)})),l}function v(o){i&&i.values&&i.values.constructor===Object&&void 0!==i.values[o]&&(o=i.values[o]),"number"==typeof e.properties[t]&&(o=Number(o)),["array","object"].includes(s)&&(o=JSON.parse(o)),e.properties[t]=o,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,o),n.onclose&&n.onclose(),l.close(),e.setDirtyCanvas(!0,!0)}}},{key:"createDialog",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=document.createElement("div");i.className="graphdialog",i.innerHTML=e;var s=this.canvas.getBoundingClientRect(),o=-20,a=-20;return s&&(o-=s.left,a-=s.top),n.position?(o+=n.position[0],a+=n.position[1]):n.event?(o+=n.event.clientX,a+=n.event.clientY):(o+=.5*this.canvas.width,a+=.5*this.canvas.height),i.style.left="".concat(o,"px"),i.style.top="".concat(a,"px"),this.canvas.parentNode.appendChild(i),i.close=function(){i.parentNode&&i.parentNode.removeChild(t)},i}},{key:"createPanel",value:function(t){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=i.window||window,o=document.createElement("div");if(o.className="litegraph dialog",o.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div class='dialog-footer'></div>",o.header=o.querySelector(".dialog-header"),i.width&&(o.style.width=i.width+(i.width.constructor===Number?"px":"")),i.height&&(o.style.height=i.height+(i.height.constructor===Number?"px":"")),i.closable){var a=document.createElement("span");a.innerHTML="&#10005;",a.classList.add("close"),a.addEventListener("click",(function(){return o.close()})),o.header.appendChild(a)}return o.title_element=o.querySelector(".dialog-title"),o.title_element.innerText=t,o.content=o.querySelector(".dialog-content"),o.footer=o.querySelector(".dialog-footer"),o.close=function(){return o.parentNode.removeChild(n)},o.clear=function(){return o.content.innerHTML=""},o.addHTML=function(e,t,n){var i=document.createElement("div");return t&&(i.className=t),i.innerHTML=e,n?o.footer.appendChild(i):o.content.appendChild(i),i},o.addButton=function(e,t,n){var i=document.createElement("button");return i.innerText=e,i.options=n,i.classList.add("btn"),i.addEventListener("click",t),o.footer.appendChild(i),i},o.addSeparator=function(){var e=document.createElement("div");e.className="separator",o.content.appendChild(e)},o.addWidget=function(t,i,a){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},l=arguments.length>4?arguments[4]:void 0,h="number"===(t=t.toLowerCase())?a.toFixed(3):a.toString(),u=document.createElement("div");u.className="property",u.innerHTML="<span class='property_name'></span><span class='property_value'></span>",u.querySelector(".property_name").innerText=i;var c=u.querySelector(".property_value");function d(e,t){console.log("change",e,t),r.callback&&r.callback(e,t),l&&l(e,t)}return c.innerText=h,u.dataset.property=i,u.dataset.type=r.type||t,u.options=r,u.value=h,"boolean"===t?(u.classList.add("boolean"),a&&u.classList.add("bool-on"),u.addEventListener("click",(function(){var e=u.dataset.property;n.value=!u.value,n.classList.toggle("bool-on"),n.querySelector(".property_value").innerText=n.value?"true":"false",d(e,n.value)}))):["string","number"].includes(t)?(c.setAttribute("contenteditable",!0),c.addEventListener("keydown",(function(e){"Enter"===e.code&&(e.preventDefault(),c.blur())})),c.addEventListener("blur",(function(){var e=n.innerText,t=c.parentNode.dataset.property;"number"===c.parentNode.dataset.type&&(e=Number(e)),d(t,e)}))):["enum","combo"].includes(t)&&(h=e.getPropertyPrintableValue(a,r.values)),c.innerText=h,c.addEventListener("click",(function(e){var t=r.values||[],i=c.parentNode.dataset.property;new E(t,{event:e,className:"dark",callback:function(e,t,s){return n.innerText=e,d(i,e),!1}},s)})),o.content.appendChild(u),u},o}},{key:"showSubgraphPropertiesDialog",value:function(e){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function s(){if(n.clear(),e.inputs){var t,o=u(e.inputs);try{var a=function(){var o=t.value;if(o.not_subgraph_input)return"continue";var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=o.name,a.dataset.slot=i,a.querySelector(".name").innerText=o.name,a.querySelector(".type").innerText=o.type,a.querySelector("button").addEventListener("click",(function(){e.removeInput(Number(a.parentNode.dataset.slot)),s()}))};for(o.s();!(t=o.n()).done;)a()}catch(e){o.e(e)}finally{o.f()}}}n.node=e,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'/><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(t){var n=this.parentNode,i=n.querySelector(".name").value,o=n.querySelector(".type").value;i&&-1===e.findInputSlot(i)&&(e.addInput(i,o),n.querySelector(".name").value="",n.querySelector(".type").value="",s())})),s(),this.canvas.parentNode.appendChild(n),n}},{key:"checkPanels",value:function(){if(this.canvas){var e,t=u(this.canvas.parentNode.querySelectorAll(".litegraph.dialog"));try{for(t.s();!(e=t.n()).done;){var n=e.value;n.node&&(n.node.graph&&n.graph===this.graph||n.close())}}catch(e){t.e(e)}finally{t.f()}}}},{key:"getCanvasMenuOptions",value:function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:e.onMenuAdd},{content:"Add Group",callback:e.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var n=this.getExtraMenuOptions(this,t);n&&(t=t.concat(n))}return t}},{key:"getNodeMenuOptions",value:function(t){var n=null;if(n=t.getMenuOptions?t.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:e.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:e.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:e.onShowMenuNodeProperties},null,{content:"Title",callback:e.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:e.onMenuNodeMode},{content:"Resize",callback:function(){if(t.resizable)return e.onResizeNode}},{content:"Collapse",callback:e.onMenuNodeCollapse},{content:"Pin",callback:e.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:e.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:e.onMenuNodeShapes},null],t.onGetInputs){var i=t.onGetInputs();i&&i.length&&(n[0].disabled=!1)}if(t.onGetOutputs){var s=t.onGetOutputs();s&&s.length&&(n[1].disabled=!1)}if(t.getExtraMenuOptions){var o=t.getExtraMenuOptions(this,n);o&&(o.push(null),n=o.concat(n))}return!1!==t.clonable&&n.push({content:"Clone",callback:e.onMenuNodeClone}),n.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:e.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(n,t),n}},{key:"getGroupMenuOptions",value:function(){return[{content:"Title",callback:e.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:e.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:e.onShowPropertyEditor},null,{content:"Remove",callback:e.onMenuNodeRemove}]}},{key:"processContextMenu",value:function(t,n){var i=this,s=e.active_canvas.getCanvasWindow(),o=null,a={event:n,callback:function(e,n,s){if(!e)return;if("Remove Slot"===e.content){var o=e.slot;o.input?t.removeInput(o.slot):o.output&&t.removeOutput(o.slot)}else if("Disconnect Links"===e.content){var a=e.slot;a.output?t.disconnectOutput(a.slot):a.input&&t.disconnectInput(a.slot)}else if("Rename Slot"===e.content){var r=e.slot,l=r.input?t.getInputInfo(r.slot):t.getOutputInfo(r.slot),h=i.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",n),u=h.querySelector("input");u&&l&&(u.value=l.label||""),h.querySelector("button").addEventListener("click",(function(){u.value&&(l&&(l.label=u.value),i.setDirty(!0)),h.close()}))}},extra:t};t&&(a.title=t.type);var r=null;if(t&&(r=t.getSlotInPosition(n.canvasX,n.canvasY),e.active_node=t),r){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(r);else{r&&r.output&&r.output.links&&r.output.links.length&&o.push({content:"Disconnect Links",slot:r});var l=r.input||r.output;o.push(l.locked?"Cannot remove":{content:"Remove Slot",slot:r}),o.push(l.nameLocked?"Cannot rename":{content:"Rename Slot",slot:r})}a.title=(r.input?r.input.type:r.output.type)||"*",r.input&&r.input.type===c.ACTION&&(a.title="Action"),r.output&&r.output.type===c.EVENT&&(a.title="Event")}else if(t)o=this.getNodeMenuOptions(t);else{o=this.getCanvasMenuOptions();var h=this.graph.getGroupOnPos(n.canvasX,n.canvasY);h&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:h,options:this.getGroupMenuOptions(h)}})}o&&new E(o,a,s)}}],[{key:"onGroupAdd",value:function(t,n,i){var s=e.active_canvas,o=new b;o.pos=s.convertEventToCanvasOffset(i),s.graph.add(o)}},{key:"onMenuAdd",value:function(t,n,i,s,o){var a=e.active_canvas,r=a.getCanvasWindow(),l=a.graph;if(l)return function e(t,n){var s=f(a.filter||l.filter).filter((function(e){return e.startsWith(t)})),h=[];s.forEach((function(n){if(n){var i=new RegExp("^(".concat(t,")")),s=n.replace(i,"").split("/")[0],o="".concat(""===t?s:t+s,"/"),a=s;-1!=a.indexOf("::")&&(a=a.split("::")[1]),-1===h.findIndex((function(e){return e.value===o}))&&h.push({value:o,content:a,has_submenu:!0,callback:function(t,n,i,s){e(t.value,s)}})}})),g(t.slice(0,-1),a.filter||l.filter).forEach((function(e){if(!e.skip_list){var t={value:e.type,content:e.title,has_submenu:!1,callback:function(e,t,n,i){var s=i.getFirstEvent();a.graph.beforeChange();var r=m.createNode(e.value);r&&(r.pos=a.convertEventToCanvasOffset(s),a.graph.add(r)),o&&o(r),a.graph.afterChange()}};h.push(t)}})),new E(h,{event:i,parentMenu:n},r)}("",s),!1}},{key:"onMenuCollapseAll",value:function(){}},{key:"onMenuNodeEdit",value:function(){}},{key:"showMenuNodeOptionalInputs",value:function(t,n,i,s,o){if(o){var a=this,r=e.active_canvas.getCanvasWindow(),l=o.optional_inputs;o.onGetInputs&&(l=o.onGetInputs());var h=[];if(l){var d,p=u(l);try{for(p.s();!(d=p.n()).done;){var v=d.value;if(v){var g=v[0];v[2]&&v[2].label&&(g=v[2].label);var f={content:g,value:v};v[1]===c.ACTION&&(f.className="event"),h.push(f)}else h.push(null)}}catch(e){p.e(e)}finally{p.f()}}if(this.onMenuNodeInputs&&(h=this.onMenuNodeInputs(h)),h.length)return new E(h,{event:i,callback:function(e,t,n){if(!o)return;e.callback&&e.callback.call(a,o,e,t,n);e.value&&(o.graph.beforeChange(),o.addInput(e.value[0],e.value[1],e.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange())},parentMenu:s,node:o},r),!1;console.log("no input entries")}}},{key:"showMenuNodeOptionalOutputs",value:function(t,n,i,s,o){if(o){var a=this,r=e.active_canvas.getCanvasWindow(),l=o.optional_outputs;o.onGetOutputs&&(l=o.onGetOutputs());var h=[];if(l){var d,p=u(l);try{for(p.s();!(d=p.n()).done;){var v=d.value;if(v){if(!o.flags||!o.flags.skip_repeated_outputs||-1===o.findOutputSlot(v[0])){var g=v[0];v[2]&&v[2].label&&(g=v[2].label);var f={content:g,value:v};v[1]===c.EVENT&&(f.className="event"),h.push(f)}}else h.push(null)}}catch(e){p.e(e)}finally{p.f()}}if(this.onMenuNodeOutputs&&(h=this.onMenuNodeOutputs(h)),h.length)return new E(h,{event:i,callback:function e(t,n,i){if(!o)return;t.callback&&t.callback.call(a,o,t,n,i);if(!t.value)return;var r=t.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var l=[];for(var h in r)l.push({content:h,value:r[h]});return new E(l,{event:n,callback:e,parentMenu:s,node:o}),!1}o.graph.beforeChange(),o.addOutput(t.value[0],t.value[1],t.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange()},parentMenu:s,node:o},r),!1}}},{key:"onShowMenuNodeProperties",value:function(n,i,s,o,a){if(a&&a.properties){var r=e.active_canvas,l=r.getCanvasWindow(),h=[];for(var u in a.properties){var c=void 0!==a.properties[u]?a.properties[u]:" ";"object"===t(c)&&(c=JSON.stringify(c));var d=a.getPropertyInfo(u);"enum"!=d.type&&"combo"!=d.type||(c=e.getPropertyPrintableValue(c,d.values)),c=e.decodeHTML(c),h.push({content:'<span class="property_name">'.concat(d.label?d.label:u,"</span>")+'<span class="property_value">'.concat(c,"</span>"),value:u})}if(h.length)return new E(h,{event:s,callback:function(e){if(!a)return;var t=this.getBoundingClientRect();r.showEditPropertyValue(a,e.value,{position:[t.left,t.top]})},parentMenu:o,allow_html:!0,node:a},l),!1}}},{key:"decodeHTML",value:function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML}},{key:"onResizeNode",value:function(e,t,n,i,s){s&&(s.size=s.computeSize(),s.onResize&&s.onResize(s.size),s.setDirtyCanvas(!0,!0))}},{key:"onShowPropertyEditor",value:function(t,n,i,s,o){var a=t.property||"title",r=o[a],l=document.createElement("div");l.className="graphdialog",l.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",l.querySelector(".name").innerText=a;var h=l.querySelector(".value");h&&(h.value=r,h.addEventListener("blur",(function(e){h.focus()})),h.addEventListener("keydown",(function(e){13!==e.keyCode&&"textarea"!==e.target.localName||(v(h.value),e.preventDefault(),e.stopPropagation())})));var u=e.active_canvas.canvas,c=u.getBoundingClientRect(),d=-20,p=-20;function v(e){"Number"===t.type?e=Number(e):"Boolean"===t.type&&(e=Boolean(e)),o[a]=e,l.parentNode&&l.parentNode.removeChild(l),o.setDirtyCanvas(!0,!0)}c&&(d-=c.left,p-=c.top),i?(l.style.left="".concat(i.clientX+d,"px"),l.style.top="".concat(i.clientY+p,"px")):(l.style.left="".concat(.5*u.width+d,"px"),l.style.top="".concat(.5*u.height+p,"px")),l.querySelector("button").addEventListener("click",(function(){return v(h.value)})),u.parentNode.appendChild(l)}},{key:"getPropertyPrintableValue",value:function(e,t){if(!t)return String(e);if(t.constructor===Array)return String(e);if(t.constructor===Object){var n="";for(var i in t)if(t[i]===e){n=i;break}return"".concat(String(e)," (").concat(n,")")}}},{key:"onMenuNodeCollapse",value:function(e,t,n,i,s){s.graph.beforeChange(s),s.collapse(),s.graph.afterChange(s)}},{key:"onMenuNodePin",value:function(e,t,n,i,s){s.pin()}},{key:"onMenuNodeColors",value:function(t,n,i,s,o){if(!o)throw new Error("no node for color");var a=[];for(var r in a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),e.node_colors){var l=e.node_colors[r];a.push({value:r,content:'<span style="display: block; color: #999; padding-left: 4px; border-left: 8px solid '.concat(l.color,"; background-color:").concat(l.bgcolor,'">').concat(r,"</span>")})}return new E(a,{event:i,callback:function(t){if(o){var n=t.value?e.node_colors[t.value]:null;n?"LGraphGroup"===o.constructor.name?o.color=n.groupcolor:(o.color=n.color,o.bgcolor=n.bgcolor):(delete o.color,delete o.bgcolor),o.setDirtyCanvas(!0,!0)}},parentMenu:s,node:o}),!1}},{key:"onMenuNodeShapes",value:function(e,t,n,i,s){if(!s)throw new Error("no node passed");return new E(c.VALID_SHAPES,{event:n,callback:function(e){s&&(s.graph.beforeChange(s),s.shape=e,s.graph.afterChange(s),s.setDirtyCanvas(!0))}},{parentMenu:i,node:s}),!1}},{key:"onMenuNodeRemove",value:function(e,t,n,i,s){if(!s)throw new Error("no node passed");if(!1!==s.removable){var o=s.graph;o.beforeChange(),o.remove(s),o.afterChange(),s.setDirtyCanvas(!0,!0)}}},{key:"onMenuNodeToSubgraph",value:function(t,n,i,s,o){var a=o.graph,r=e.active_canvas;if(r){var l=Object.values(r.selected_nodes||{});l.length||(l=[o]);var h=m.createNode("graph/subgraph");h.pos=o.pos.concat(),a.add(h),h.buildFromNodes(l),r.deselectAllNodes(),o.setDirtyCanvas(!0,!0)}}},{key:"onMenuNodeClone",value:function(e,t,n,i,s){if(!1!==s.clonable){var o=s.clone();o&&(o.pos=[s.pos[0]+5,s.pos[1]+5],s.graph.beforeChange(),s.graph.add(o),s.graph.afterChange(),s.setDirtyCanvas(!0,!0))}}}]),e}();a(L,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),a(L,"link_type_colors",{"-1":c.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),a(L,"gradients",{}),a(L,"search_limit",-1),a(L,"onMenuNodeMode",(function(e,t,n,i,s){return new E(["Always","On Event","On Trigger","Never"],{event:n,callback:function(e){if(s)switch(e){case"On Event":s.mode=c.ON_EVENT;break;case"On Trigger":s.mode=c.ON_TRIGGER;break;case"Never":s.mode=c.NEVER;break;case"Always":default:s.mode=c.ALWAYS}},parentMenu:i,node:s}),!1})),a(L,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});var x=function(){function e(t){n(this,e),a(this,"STATUS_STOPPED",1),a(this,"STATUS_RUNNING",2),a(this,"supportedTypes",["number","string","boolean"]),c.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}return o(e,[{key:"getSupportedTypes",value:function(){return this.supportedTypes||e.supportedTypes}},{key:"clear",value:function(){if(this.stop(),this.status=e.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes){var t,n=u(this._nodes);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.onRemoved&&i.onRemoved()}}catch(e){n.e(e)}finally{n.f()}}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}},{key:"attachCanvas",value:function(e){if(e.constructor!==L)throw new Error("attachCanvas expects a LGraphCanvas instance");e.graph&&e.graph!==this&&e.graph.detachCanvas(e),e.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(e)}},{key:"detachCanvas",value:function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);-1!==t&&(e.graph=null,this.list_of_graphcanvas.splice(t,1))}}},{key:"start",value:function(t){if(this.status!==e.STATUS_RUNNING){this.status=e.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=d(),this.last_update_time=this.starttime;var n=this;if(0===(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function e(){-1===n.execution_timer_id&&(window.requestAnimationFrame(e),n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep())}()}else this.execution_timer_id=setInterval((function(){n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep()}),t)}}},{key:"stop",value:function(){this.status!==e.STATUS_STOPPED&&(this.status=e.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!==this.execution_timer_id&&(-1!==this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}},{key:"runStep",value:function(e,t,n){e=e||1;var i=d();this.globaltime=.001*(i-this.starttime);var s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(n=n||s.length,t){for(var o=0;o<e;o++){for(var a=0;a<n;a++){var r=s[a];r.mode===c.ALWAYS&&r.onExecute&&r.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var l=0;l<e;l++){for(var h=0;h<n;++h){var u=s[h];u.mode===c.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(e){if(this.errors_in_execution=!0,c.throw_errors)throw e;c.debug&&console.log("Error during execution: ".concat(e)),this.stop()}var p=d(),v=p-i;0===v&&(v=1),this.execution_time=.001*v,this.globaltime+=.001*v,this.iteration+=1,this.elapsed_time=.001*(p-this.last_update_time),this.last_update_time=p}}},{key:"updateExecutionOrder",value:function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];var e,t=u(this._nodes_in_order);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.onExecute&&this._nodes_executable.push(n)}}catch(e){t.e(e)}finally{t.f()}}},{key:"computeExecutionOrder",value:function(e,t){var n,i=[],s=[],o={},a={},r={},l=u(this._nodes);try{for(l.s();!(n=l.n()).done;){var h=n.value;if(!e||h.onExecute){o[h.id]=h;var d=0;if(h.inputs)for(var p=0,v=h.inputs.length;p<v;p++)h.inputs[p]&&null!=h.inputs[p].link&&(d+=1);0===d?(s.push(h),t&&(h._level=1)):(t&&(h._level=0),r[h.id]=d)}}}catch(e){l.e(e)}finally{l.f()}for(;0!==s.length;){var g=s.shift();if(i.push(g),delete o[g.id],g.outputs){var f,_=u(g.outputs);try{for(_.s();!(f=_.n()).done;){var y=f.value;if(null!=y&&null!=y.links&&0!==y.links.length){var m,b=u(y.links);try{for(b.s();!(m=b.n()).done;){var k=m.value,E=this.links[k];if(E&&!a[E.id]){var T=this.getNodeById(E.target_id);null!=T?(t&&(!T._level||T._level<=g._level)&&(T._level=g._level+1),a[E.id]=!0,r[T.id]-=1,0===r[T.id]&&s.push(T)):a[E.id]=!0}}}catch(e){b.e(e)}finally{b.f()}}}}catch(e){_.e(e)}finally{_.f()}}}for(var C in o)i.push(o[C]);i.length!==this._nodes.length&&c.debug&&console.warn("something went wrong, nodes missing");for(var w=i.length,N=0;N<w;N++)i[N].order=N;i=i.sort((function(e,t){var n=e.constructor.priority||e.priority||0,i=t.constructor.priority||t.priority||0;return n===i?e.order-t.order:n-i}));for(var O=0;O<w;++O)i[O].order=O;return i}},{key:"getAncestors",value:function(e){for(var t=[],n=[e],i={};n.length;){var s=n.shift();if(s.inputs){i[s.id]||s===e||(i[s.id]=!0,t.push(s));for(var o=0;o<s.inputs.length;++o){var a=s.getInputNode(o);a&&-1===t.indexOf(a)&&n.push(a)}}}return t.sort((function(e,t){return e.order-t.order})),t}},{key:"arrange",value:function(e){e=e||100;var t,n=[],i=u(this.computeExecutionOrder(!1,!0));try{for(i.s();!(t=i.n()).done;){var s=t.value,o=s._level||1;n[o]||(n[o]=[]),n[o].push(s)}}catch(e){i.e(e)}finally{i.f()}for(var a=e,r=0,l=n;r<l.length;r++){var h=l[r];if(h){var d,p=100,v=e+c.NODE_TITLE_HEIGHT,g=u(h);try{for(g.s();!(d=g.n()).done;){var f=d.value;f.pos[0]=a,f.pos[1]=v,f.size[0]>p&&(p=f.size[0]),v+=f.size[1]+e+c.NODE_TITLE_HEIGHT}}catch(e){g.e(e)}finally{g.f()}a+=p+e}}this.setDirtyCanvas(!0,!0)}},{key:"getTime",value:function(){return this.globaltime}},{key:"getFixedTime",value:function(){return this.fixedtime}},{key:"getElapsedTime",value:function(){return this.elapsed_time}},{key:"sendEventToAllNodes",value:function(e,t,n){n=n||c.ALWAYS;var i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(var s=0,o=i.length;s<o;++s){var a=i[s];"Subgraph"!==a.constructor.name||"onExecute"===e?a[e]&&a.mode===n&&(void 0===t?a[e]():t&&t.constructor===Array?a[e].apply(a,r(t)):a[e](t)):a.mode===n&&a.sendEventToAllNodes(e,t,n)}}},{key:"sendActionToCanvas",value:function(e,t){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var i=this.list_of_graphcanvas[n];i[e]&&i[e].apply(i,r(t))}}},{key:"add",value:function(e,t){if(e){if(e.constructor===b)return this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,void this._version++;if(-1!==e.id&&null!=this._nodes_by_id[e.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),e.id=++this.last_node_id),this._nodes.length>=c.MAX_NUMBER_OF_NODES)throw new Error("LiteGraph: max number of nodes in a graph reached");return null==e.id||-1===e.id?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this._version++,this._nodes.push(e),this._nodes_by_id[e.id]=e,e.onAdded&&e.onAdded(this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(e),this.setDirtyCanvas(!0),this.change(),e}}},{key:"remove",value:function(e){if("LGraphGroup"===e.constructor.name){var t=this._groups.indexOf(e);return-1!==t&&this._groups.splice(t,1),e.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[e.id]&&!e.ignore_remove){if(this.beforeChange(),e.inputs)for(var n=0;n<e.inputs.length;n++){null!=e.inputs[n].link&&e.disconnectInput(n)}if(e.outputs)for(var i=0;i<e.outputs.length;i++){var s=e.inputs[i];null!=s.links&&s.links.length&&e.disconnectOutput(i)}if(e.onRemoved&&e.onRemoved(),e.graph=null,this._version++,this.list_of_graphcanvas){var o,a=u(this.list_of_graphcanvas);try{for(a.s();!(o=a.n()).done;){var r=o.value;r.selected_nodes[e.id]&&delete r.selected_nodes[e.id],r.node_dragged===e&&(r.node_dragged=null)}}catch(e){a.e(e)}finally{a.f()}}var l=this._nodes.indexOf(e);-1!==l&&this._nodes.splice(l,1),delete this._nodes_by_id[e.id],this.onNodeRemoved&&this.onNodeRemoved(e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}}},{key:"getNodeById",value:function(e){return null==e?null:this._nodes_by_id[e]}},{key:"findNodesByClass",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.length=0;var n,i=u(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.constructor===e&&t.push(s)}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"findNodesByType",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e=e.toLowerCase(),(t=t||[]).length=0;var n,i=u(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.type.toLowerCase()===e&&t.push(s)}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"findNodeByTitle",value:function(e){var t,n=u(this._nodes);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.title===e)return i}}catch(e){n.e(e)}finally{n.f()}return null}},{key:"findNodesByTitle",value:function(e){var t,n=[],i=u(this._nodes);try{for(i.s();!(t=i.n()).done;){var s=t.value;s.title===e&&n.push(s)}}catch(e){i.e(e)}finally{i.f()}return n}},{key:"getNodeOnPos",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodes,s=arguments.length>3?arguments[3]:void 0,o=u(i);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(a.isPointInside(e,t,s))return a}}catch(e){o.e(e)}finally{o.f()}return null}},{key:"getGroupOnPos",value:function(e,t){var n,i=u(this._groups);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.isPointInside(e,t,2,!0))return s}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"checkNodeTypes",value:function(){var e,t=u(this._nodes);try{for(t.s();!(e=t.n()).done;){var n=e.value,i=c.registered_node_types[n.type];if(n.constructor!==i){console.log("node being replaced by newer version: ".concat(n.type));var s=m.createNode(n.type);n=s,s.configure(n.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,n.inputs&&(s.inputs=n.inputs.concat()),n.outputs&&(s.outputs=n.outputs.concat())}}}catch(e){t.e(e)}finally{t.f()}this.updateExecutionOrder()}},{key:"onAction",value:function(e,t){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);var n,i=u(this._input_nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.properties.name===e){s.onAction(e,t);break}}}catch(e){i.e(e)}finally{i.f()}}},{key:"trigger",value:function(e,t){this.onTrigger&&this.onTrigger(e,t)}},{key:"addInput",value:function(e,t,n){this.inputs[e]||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange())}},{key:"setInputData",value:function(e,t){var n=this.inputs[e];n&&(n.value=t)}},{key:"getInputData",value:function(e){var t=this.inputs[e];return t?t.value:null}},{key:"renameInput",value:function(e,t){if(t!==e){if(!this.inputs[e])return!1;if(this.inputs[t])return console.error("there is already one input with that newName"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this._version++,this.onInputRenamed&&this.onInputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}}},{key:"changeInputType",value:function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()===String(t).toLowerCase()||(this.inputs[e].type=t,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(e,t))}},{key:"removeInput",value:function(e){return!!this.inputs[e]&&(delete this.inputs[e],this._version++,this.onInputRemoved&&this.onInputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"addOutput",value:function(e,t,n){this.outputs[e]={name:e,type:t,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},{key:"setOutputData",value:function(e,t){var n=this.outputs[e];n&&(n.value=t)}},{key:"getOutputData",value:function(e){var t=this.outputs[e];return t?t.value:null}},{key:"renameOutput",value:function(e,t){return!!this.outputs[e]&&(this.outputs[t]?(console.error("there is already one output with that newName"),!1):(this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.onOutputRenamed&&this.onOutputRenamed(e,t),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))}},{key:"changeOutputType",value:function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()===String(t).toLowerCase()||(this.outputs[e].type=t,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(e,t))}},{key:"removeOutput",value:function(e){return!!this.outputs[e]&&(delete this.outputs[e],this._version++,this.onOutputRemoved&&this.onOutputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"triggerInput",value:function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].onTrigger(t)}},{key:"setCallback",value:function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].setTrigger(t)}},{key:"beforeChange",value:function(e){this.onBeforeChange&&this.onBeforeChange(this,e),this.sendActionToCanvas("onBeforeChange",this)}},{key:"afterChange",value:function(e){this.onAfterChange&&this.onAfterChange(this,e),this.sendActionToCanvas("onAfterChange",this)}},{key:"connectionChange",value:function(e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(e),this._version++,this.sendActionToCanvas("onConnectionChange")}},{key:"isLive",value:function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){if(this.list_of_graphcanvas[e].live_mode)return!0}return!1}},{key:"clearTriggeredSlots",value:function(){for(var e in this.links){var t=this.links[e];t&&(t._last_time&&(t._last_time=0))}}},{key:"change",value:function(){c.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)}},{key:"setDirtyCanvas",value:function(e,t){this.sendActionToCanvas("setDirty",[e,t])}},{key:"removeLink",value:function(e){var t=this.links[e];if(t){var n=this.getNodeById(t.target_id);n&&n.disconnectInput(t.target_slot)}}},{key:"serialize",value:function(){var e,t=[],n=u(this._nodes);try{for(n.s();!(e=n.n()).done;){var i=e.value;t.push(i.serialize())}}catch(e){n.e(e)}finally{n.f()}var s=[];for(var o in this.links){var a=this.links[o];if(!a.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var r=new LLink;for(var l in a)r[l]=a[l];this.links[o]=r,a=r}s.push(a.serialize())}var h,d=[],p=u(this._groups);try{for(p.s();!(h=p.n()).done;){var v=h.value;d.push(v.serialize())}}catch(e){p.e(e)}finally{p.f()}var g={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:s,groups:d,config:this.config,extra:this.extra,version:c.VERSION};return this.onSerialize&&this.onSerialize(g),g}},{key:"configure",value:function(e,t){if(e){t||this.clear();var n=e.nodes;if(e.links&&e.links.constructor===Array){var i,s=[],o=u(e.links);try{for(o.s();!(i=o.n()).done;){var a=i.value;if(a){var r=new LLink;r.configure(a),s[r.id]=r}else console.warn("serialized graph link data contains errors, skipping.")}}catch(e){o.e(e)}finally{o.f()}e.links=s}for(var l in e)"nodes"!==l&&"groups"!==l&&(this[l]=e[l]);var h=!1;if(this._nodes=[],n){var d,p=u(n);try{for(p.s();!(d=p.n()).done;){var v=d.value,g=m.createNode(v.type,v.title);g||(c.debug&&console.log("Node not found or has errors: ".concat(v.type)),(g=new m).last_serialization=v,g.has_errors=!0,h=!0),g.id=v.id,this.add(g,!0)}}catch(e){p.e(e)}finally{p.f()}var f,_=u(n);try{for(_.s();!(f=_.n()).done;){var y=f.value,k=this.getNodeById(y.id);k&&k.configure(y)}}catch(e){_.e(e)}finally{_.f()}}if(this._groups.length=0,e.groups){var E,T=u(e.groups);try{for(T.s();!(E=T.n()).done;){var C=E.value,w=new b;w.configure(C),this.add(w)}}catch(e){T.e(e)}finally{T.f()}}return this.updateExecutionOrder(),this.extra=e.extra||{},this.onConfigure&&this.onConfigure(e),this._version++,this.setDirtyCanvas(!0,!0),h}}},{key:"load",value:function(e,t){var n=this;if(e.constructor===File||e.constructor===Blob){var i=new FileReader;return i.addEventListener("load",(function(e){var i=JSON.parse(e.target.result);n.configure(i),t&&t()})),void i.readAsText(e)}var s=new XMLHttpRequest;s.open("GET",e,!0),s.send(null),s.onload((function(){if(200===s.status){var e=JSON.parse(s.response);n.configure(e),t&&t()}else console.error("Error loading graph:",s.status,s.response)})),s.onerror((function(e){console.error("Error loading graph:",e)}))}},{key:"onNodeTrace",value:function(e,t,n){}}]),e}();a(x,"supportedTypes",["number","string","boolean"]);var P=function(){function e(t,i,s,o,a,r){n(this,e),this.id=t,this.type=i,this.origin_id=s,this.origin_slot=o,this.target_id=a,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}return o(e,[{key:"configure",value:function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)}},{key:"serialize",value:function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}]),e}(),M=function(){function e(t){n(this,e),this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}return o(e,[{key:"sampleCurve",value:function(e,t){if(t){for(var n=0;n<t.length-1;++n){var i=t[n],s=t[n+1];if(!(s[0]<e)){var o=s[0]-i[0];if(Math.abs(o)<1e-5)return i[1];var a=(e-i[0])/o;return i[1]*(1-a)+s[1]*a}}return 0}}},{key:"draw",value:function(e,t,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#666",o=arguments.length>5?arguments[5]:void 0,a=this.points;if(a){this.size=t;var r=t[0]-2*this.margin,l=t[1]-2*this.margin;e.save(),e.translate(this.margin,this.margin),i&&(e.fillStyle="#111",e.fillRect(0,0,r,l),e.fillStyle="#222",e.fillRect(.5*r,0,1,l),e.strokeStyle="#333",e.strokeRect(0,0,r,l)),e.strokeStyle=s,o&&(e.globalAlpha=.5),e.beginPath();var h,c=u(a);try{for(c.s();!(h=c.n()).done;){var d=h.value;e.lineTo(d[0]*r,(1-d[1])*l)}}catch(e){c.e(e)}finally{c.f()}if(e.stroke(),e.globalAlpha=1,!o)for(var p=0;p<a.length;++p){var v=a[p];this.selected===p?e.fillStyle="#FFF":this.nearest===p?e.fillStyle="#DDD":e.fillStyle="#AAA",e.beginPath(),e.arc(v[0]*r,(1-v[1])*l,2,0,2*Math.PI),e.fill()}e.restore()}}},{key:"onMouseDown",value:function(e,t){var n=this.points;if(n&&!(e[1]<0)){var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=e[0]-this.margin,a=e[1]-this.margin,r=[o,a],l=30/t.ds.scale;if(this.selected=this.getCloserPoint(r,l),-1===this.selected){var h=[o/i,1-a/s];n.push(h),n.sort((function(e,t){return e[0]-t[0]})),this.selected=n.indexOf(h),this.must_update=!0}return-1!==this.selected||void 0}}},{key:"onMouseMove",value:function(e,t){var n=this.points;if(n){var i=this.selected;if(!(i<0)){var s=(e[0]-this.margin)/(this.size[0]-2*this.margin),o=(e[1]-this.margin)/(this.size[1]-2*this.margin),a=[e[0]-this.margin,e[1]-this.margin],r=30/t.ds.scale;this._nearest=this.getCloserPoint(a,r);var l=n[i];if(l){var h=0===i||i===n.length-1;if(!h&&(e[0]<-10||e[0]>this.size[0]+10||e[1]<-10||e[1]>this.size[1]+10))return n.splice(i,1),void(this.selected=-1);l[0]=h?0===i?0:1:Math.clamp(s,0,1),l[1]=1-Math.clamp(o,0,1),n.sort((function(e,t){return e[0]-t[0]})),this.selected=n.indexOf(l),this.must_update=!0}}}}},{key:"onMouseUp",value:function(){return this.selected=-1,!1}},{key:"getCloserPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=this.points;if(!n)return-1;for(var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=n.length,a=[0,0],r=1e6,l=-1,h=0;h<o;++h){var u=n[h];a[0]=u[0]*i,a[1]=(1-u[1])*s,a[0],e[0];var c=vec2.distance(e,a);c>r||c>t||(l=h,r=c)}return l}}]),e}(),R=function(){function e(t,i){n(this,e),i=i||{};var s=document.createElement("div");this.root=s,s.className="litegraph litegraph-editor",s.innerHTML="<div class='content'><div class='editor-area'><canvas class='graphcanvas' width='1000' height='500' tabindex=10></canvas></div></div>",this.content=s.querySelector(".content"),this.footer=s.querySelector(".footer");var o=s.querySelector(".graphcanvas"),a=this.graph=new x,r=this.graphcanvas=new L(o,a);r.background_image="imgs/grid.png",a.onAfterExecute=function(){r.draw(!0)},r.onDropItem=this.onDropItem.bind(this),i.miniwindow&&this.addMiniWindow(300,200);var l=document.getElementById(t);l&&l.appendChild(s),r.resize()}return o(e,[{key:"onDropItem",value:function(e){var t,n=this,i=u(e.dataTransfer.files);try{for(i.s();!(t=i.n()).done;){var s=t.value,o=L.getFileExtension(s.name),a=new FileReader;"json"===o&&(a.onload=function(e){n.graph.configure(JSON.parse(e.target.result))},a.readAsText(s))}}catch(e){i.e(e)}finally{i.f()}}},{key:"addMiniWindow",value:function(e,t){var n=document.createElement("div");n.className="litegraph miniwindow",n.innerHTML="<canvas class='graphcanvas' width='".concat(e,"' height='").concat(t,"' tabindex=10></canvas>");var i=n.querySelector("canvas"),s=this,o=new L(i,this.graph);o.show_info=!1,o.background_image="imgs/grid.png",o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1,o.render_shadows=!1,o.max_zoom=.25,this.miniwindow_graphcanvas=o,o.onClear=function(){o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1},o.onRenderBackground=function(e,t){t.strokeStyle="#567";var n=s.graphcanvas.convertOffsetToCanvas([0,0]),i=s.graphcanvas.convertOffsetToCanvas([s.graphcanvas.canvas.width,s.graphcanvas.canvas.height]);n=this.convertCanvasToOffset(n),i=this.convertCanvasToOffset(i),t.lineWidth=1,t.strokeRect(Math.floor(n[0])+.5,Math.floor(n[1])+.5,Math.floor(i[0]-n[0]),Math.floor(i[1]-n[1]))},n.style.position="absolute",n.style.top="4px",n.style.right="4px";var a=document.createElement("div");a.className="corner-button",a.innerHTML="&#10060;",a.addEventListener("click",(function(e){o.setGraph(null),n.parentNode.removeChild(n)})),n.appendChild(a),this.root.querySelector(".content").appendChild(n)}}]),e}();return window&&window.CanvasRenderingContext2D&&(window.CanvasRenderingContext2D.prototype.roundRect=function(e,t,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:5,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:s;this.moveTo(e+s,t),this.lineTo(e+n-s,t),this.quadraticCurveTo(e+n,t,e+n,t+s),this.lineTo(e+n,t+i-o),this.quadraticCurveTo(e+n,t+i,e+n-o,t+i),this.lineTo(e+o,t+i),this.quadraticCurveTo(e,t+i,e,t+i-o),this.lineTo(e,t+s),this.quadraticCurveTo(e,t,e+s,t)}),e.ContextMenu=E,e.CurveEditor=M,e.DragAndScale=k,e.Editor=R,e.LGraph=x,e.LGraphCanvas=L,e.LGraphGroup=b,e.LGraphNode=m,e.LLink=P,e.clearRegisteredTypes=function(){c.registered_node_types={},c.node_types_by_file_extension={},c.Nodes={},c.searchbox_extras={}},e.defaultConfig=c,e.getNodeType=function(e){return this.registered_node_types[e]},e.getNodeTypesCategories=f,e.getNodeTypesInCategory=g,e.getParameterNames=_,e.isValidConnection=y,e.registerNodeType=v,e.registerSearchboxExtra=function(e,t,n){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:n}},e.unregisterNodeType=function(e){var t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw new Error("node type not found: ".concat(e));delete c.registered_node_types[t.type],t.constructor.name&&delete c.Nodes[t.constructor.name]},e.wrapFunctionAsNode=function(e,t,n,i,s){for(var o=Array(t.length),a="",r=_(t),l=0;l<r.length;++l)a+="this.addInput('".concat(r[l],"',").concat(n&&n[l]?"'".concat(n[l],"'"):"0",");\n");a+="this.addOutput('out',".concat(i?"'".concat(i,"'"):0,");\n"),s&&(a+="this.properties = ".concat(JSON.stringify(s),";\n"));var h=Function(a);h.title=e.split("/").pop(),h.desc="Generated from ".concat(t.name),h.prototype.onExecute=function(){for(var e=0;e<o.length;++e)o[e]=this.getInputData(e);var n=t.apply(this,o);this.setOutputData(0,n)},v(e,h)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=litegraph.min.js.map
