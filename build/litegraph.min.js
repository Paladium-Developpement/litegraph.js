var LiteGraph=function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function s(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||r(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function h(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=r(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,l=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){l=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(l)throw o}}}}var u={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,u.debug&&console.log("Node registered: ".concat(t)),t.split("/");var n=e.name,i=t.lastIndexOf("/");if(e.category=t.substr(0,i),e.title||(e.title=n),e.prototype)for(var s in LGraphNode.prototype)e.prototype[s]||(e.prototype[s]=LGraphNode.prototype[s]);var o=this.registered_node_types[t];if(o)console.log("replacing node type: ".concat(t));else if(Object.hasOwnProperty(e.prototype,"shape")||Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=u.BOX_SHAPE;break;case"round":this._shape=u.ROUND_SHAPE;break;case"circle":this._shape=u.CIRCLE_SHAPE;break;case"card":this._shape=u.CARD_SHAPE;break;default:this._shape=t}},get:function(t){return this._shape},enumerable:!0,configurable:!0}),e.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(t," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),e.supported_extensions)for(var s in e.supported_extensions){(a=e.supported_extensions[s])&&a.constructor===String&&(this.node_types_by_file_extension[a.toLowerCase()]=e)}if(this.registered_node_types[t]=e,e.constructor.name&&(this.Nodes[n]=e),u.onNodeTypeRegistered&&u.onNodeTypeRegistered(t,e),o&&u.onNodeTypeReplaced&&u.onNodeTypeReplaced(t,e,o),e.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(t," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),e.supported_extensions)for(s=0;s<e.supported_extensions.length;s++){var a;(a=e.supported_extensions[s])&&a.constructor===String&&(this.node_types_by_file_extension[a.toLowerCase()]=e)}},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: ".concat(t);delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},wrapFunctionAsNode:function(t,e,n,i,s){for(var o=Array(e.length),a="",r=u.getParameterNames(e),l=0;l<r.length;++l)a+="this.addInput('".concat(r[l],"',").concat(n&&n[l]?"'".concat(n[l],"'"):"0",");\n");a+="this.addOutput('out',".concat(i?"'".concat(i,"'"):0,");\n"),s&&(a+="this.properties = ".concat(JSON.stringify(s),";\n"));var h=Function(a);h.title=t.split("/").pop(),h.desc="Generated from ".concat(e.name),h.prototype.onExecute=function(){for(var t=0;t<o.length;++t)o[t]=this.getInputData(t);var n=e.apply(this,o);this.setOutputData(0,n)},this.registerNodeType(t,h)},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var n in LGraphNode.prototype[t]=e,this.registered_node_types){var i=this.registered_node_types[n];i.prototype[t]&&(i.prototype["_".concat(t)]=i.prototype[t]),i.prototype[t]=e}},createNode:function(t,e,n){var i=this.registered_node_types[t];if(!i)return u.debug&&console.log('GraphNode type "'.concat(t,'" not registered.')),null;i.prototype,e=e||i.title||t;var s=null;if(u.catch_exceptions)try{s=new i(e)}catch(t){return console.error(t),null}else s=new i(e);if(s.type=t,!s.title&&e&&(s.title=e),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=u.DEFAULT_POSITION.concat()),s.mode||(s.mode=u.ALWAYS),n)for(var o in n)s[o]=n[o];return s},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var n=[];for(var i in this.registered_node_types){var s=this.registered_node_types[i];s.filter==e&&(""==t?null==s.category&&n.push(s):s.category==t&&n.push(s))}return this.auto_sort_node_types?n.sort():n},getNodeTypesCategories:function(t){var e={"":1};for(var n in this.registered_node_types){var i=this.registered_node_types[n];if(i.category&&!i.skip_list){if(i.filter!=t)continue;e[i.category]=1}}var s=[];for(var n in e)s.push(n);return this.auto_sort_node_types?s.sort():s},reloadNodes:function(t){for(var e=document.getElementsByTagName("script"),n=[],i=0;i<e.length;i++)n.push(e[i]);var s=document.getElementsByTagName("head")[0];t=document.location.href+t;for(i=0;i<n.length;i++){var o=n[i].src;if(o&&o.substr(0,t.length)==t)try{u.debug&&console.log("Reloading: ".concat(o));var a=document.createElement("script");a.type="text/javascript",a.src=o,s.appendChild(a),s.removeChild(n[i])}catch(t){if(u.throw_errors)throw t;u.debug&&console.log("Error while reloading ".concat(o))}}u.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var n=JSON.parse(JSON.stringify(t));if(!e)return n;for(var i in n)e[i]=n[i];return e},isValidConnection:function(t,e){if(!t||!e||t==e||t==u.EVENT&&e==u.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var n=t.split(","),i=e.split(","),s=0;s<n.length;++s)for(var o=0;o<i.length;++o)if(n[s]==i[o])return!0;return!1},registerSearchboxExtra:function(t,e,n){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:n}},fetchFile:function(t,e,n,i){if(!t)return null;if(e=e||"text",t.constructor===String)return"http"==t.substr(0,4)&&u.proxy&&(t=u.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then((function(t){if(!t.ok)throw new Error("File not found");return"arraybuffer"==e?t.arrayBuffer():"text"==e||"string"==e?t.text():"json"==e?t.json():"blob"==e?t.blob():void 0})).then((function(t){n&&n(t)})).catch((function(e){console.error("error fetching file:",t),i&&i(e)}));if(t.constructor===File||t.constructor===Blob){var s=new FileReader;if(s.onload=function(t){var i=t.target.result;"json"==e&&(i=JSON.parse(i)),n&&n(i)},"arraybuffer"==e)return s.readAsArrayBuffer(t);if("text"==e||"json"==e)return s.readAsText(t);if("blob"==e)return s.readAsBinaryString(t)}return null}};function c(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function d(t,e,n){n=n||{},this.background_image=d.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new c,this.zoom_modify_alpha=!0,this.title_text_font="".concat(u.NODE_TEXT_SIZE,"px Arial"),this.inner_text_font="normal ".concat(u.NODE_SUBTEXT_SIZE,"px Arial"),this.node_title_color=u.NODE_TITLE_COLOR,this.default_link_color=u.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=u.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],e&&e.attachCanvas(this),this.setCanvas(t),this.clear(),n.skip_render||this.startRendering(),this.autoresize=n.autoresize}performance?u.getTime=performance.now.bind(performance):Date&&Date.now?u.getTime=Date.now.bind(Date):process?u.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:u.getTime=function(){return(new Date).getTime()},u.DragAndScale=c,c.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),t.addEventListener("mousedown",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},c.prototype.computeVisibleArea=function(){if(this.element){var t=this.element.width,e=this.element.height,n=-this.offset[0],i=-this.offset[1],s=n+t/this.scale,o=i+e/this.scale;this.visible_area[0]=n,this.visible_area[1]=i,this.visible_area[2]=s-n,this.visible_area[3]=o-i}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},c.prototype.onMouse=function(t){if(this.enabled){var e=this.element,n=e.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top;t.canvasx=i,t.canvasy=s,t.dragging=this.dragging;var o=!1;if(this.onmouse&&(o=this.onmouse(t)),"mousedown"==t.type)this.dragging=!0,e.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"==t.type){if(!o){var a=i-this.last_mouse[0],r=s-this.last_mouse[1];this.dragging&&this.mouseDrag(a,r)}}else"mouseup"==t.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback)):"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel","wheel"==t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta));return this.last_mouse[0]=i,this.last_mouse[1]=s,t.preventDefault(),t.stopPropagation(),!1}},c.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},c.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},c.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},c.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},c.prototype.changeScale=function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){e=e||[.5*n.width,.5*n.height];var i=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(e),o=[s[0]-i[0],s[1]-i[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}},c.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},c.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},(d=u.LGraphCanvas=d).DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",d.link_type_colors={"-1":u.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},d.gradients={},d.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},d.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),t||!this.graph?(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},d.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},d.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},d.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t]))}},d.prototype.getCurrentGraph=function(){return this.graph},d.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a ".concat(t.localName);throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e||this.bindEvents()}},d.prototype._doNothing=function(t){return t.preventDefault(),!1},d.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},d.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),t.addEventListener("mousedown",this._mousedown_callback,!0),t.addEventListener("mousemove",this._mousemove_callback),t.addEventListener("mousewheel",this._mousewheel_callback,!1),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),t.addEventListener("touchstart",this.touchHandler,!0),t.addEventListener("touchmove",this.touchHandler,!0),t.addEventListener("touchend",this.touchHandler,!0),t.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},d.prototype.unbindEvents=function(){if(this._events_binded){var t=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")},d.getFileExtension=function(t){var e=t.indexOf("?");-1!=e&&(t=t.substr(0,e));var n=t.lastIndexOf(".");return-1==n?"":t.substr(n+1).toLowerCase()},d.prototype.enableWebGL=function(){if(void 0===("undefined"==typeof GL?"undefined":e(GL)))throw"litegl.js must be included to use a WebGL canvas";if(void 0===("undefined"==typeof enableWebGLCanvas?"undefined":e(enableWebGLCanvas)))throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},d.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},d.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},d.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}.call(this))},d.prototype.stopRendering=function(){this.is_rendering=!1},d.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},d.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow();e.document,d.active_canvas=this;var n=this;this.canvas.removeEventListener("mousemove",this._mousemove_callback),e.document.addEventListener("mousemove",this._mousemove_callback,!0),e.document.addEventListener("mouseup",this._mouseup_callback,!0);var i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),s=!1,o=u.getTime()-this.last_mouseclick<300;if(this.mouse[0]=t.localX,this.mouse[1]=t.localY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.canvas.focus(),u.closeAllContextMenus(e),!this.onMouse||1!=this.onMouse(t)){if(1==t.which){t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,s=!0);var a=!1;if(i&&this.allow_interaction&&!s&&!this.read_only){if(this.live_mode||i.flags.pinned||this.bringToFront(i),!this.connecting_node&&!i.flags.collapsed&&!this.live_mode)if(!s&&!1!==i.resizable&&k(t.canvasX,t.canvasY,i.pos[0]+i.size[0]-5,i.pos[1]+i.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=i,this.canvas.style.cursor="se-resize",s=!0;else{if(i.outputs)for(var r=0,l=i.outputs.length;r<l;++r){var h=i.outputs[r],c=i.getConnectionPos(!1,r);if(k(t.canvasX,t.canvasY,c[0]-15,c[1]-10,30,20)){this.connecting_node=i,this.connecting_output=h,this.connecting_pos=i.getConnectionPos(!1,r),this.connecting_slot=r,t.shiftKey&&i.disconnectOutput(r),o?i.onOutputDblClick&&i.onOutputDblClick(r,t):i.onOutputClick&&i.onOutputClick(r,t),s=!0;break}}if(i.inputs)for(r=0,l=i.inputs.length;r<l;++r){var p=i.inputs[r];c=i.getConnectionPos(!0,r);if(k(t.canvasX,t.canvasY,c[0]-15,c[1]-10,30,20)&&(o?i.onInputDblClick&&i.onInputDblClick(r,t):i.onInputClick&&i.onInputClick(r,t),null!==p.link)){var g=this.graph.links[p.link];i.disconnectInput(r),(this.allow_reconnect_links||t.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[g.origin_id],this.connecting_slot=g.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,s=!0}}}if(!s){var v=!1,_=[t.canvasX-i.pos[0],t.canvasY-i.pos[1]],f=this.processNodeWidgets(i,this.graph_mouse,t);if(f&&(v=!0,this.node_widget=[i,f]),o&&this.selected_nodes[i.id]&&(i.onDblClick&&i.onDblClick(t,_,this),this.processNodeDblClicked(i),v=!0),i.onMouseDown&&i.onMouseDown(t,_,this))v=!0;else{if(i.subgraph&&!i.skip_subgraph_button&&!i.flags.collapsed&&_[0]>i.size[0]-u.NODE_TITLE_HEIGHT&&_[1]<0){n=this;setTimeout((function(){n.openSubgraph(i.subgraph)}),10)}this.live_mode&&(a=!0,v=!0)}v||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=i),this.selected_nodes[i.id]||this.processNodeSelected(i,t)),this.dirty_canvas=!0}}else{if(!this.read_only)for(r=0;r<this.visible_links.length;++r){var y=this.visible_links[r],m=y._pos;if(!(!m||t.canvasX<m[0]-4||t.canvasX>m[0]+4||t.canvasY<m[1]-4||t.canvasY>m[1]+4)){this.showLinkMenu(y,t),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)t.ctrlKey&&(this.dragging_rectangle=null),b([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();o&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(t),a=!0}!s&&a&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==t.which||3==t.which&&(this.read_only||this.processContextMenu(i,t));return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=u.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!e.document.activeElement||"input"!=e.document.activeElement.nodeName.toLowerCase()&&"textarea"!=e.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}},d.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){d.active_canvas=this,this.adjustMouseEvent(t);var e=[t.localX,t.localY];this.mouse[0]=e[0],this.mouse[1]=e[1];var n=[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]];if(this.last_mouse=e,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.block_click)return t.preventDefault(),!1;if(t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var i=n[0]/this.ds.scale,s=n[1]/this.ds.scale;this.selected_group.move(i,s,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes),a=0,r=this.graph._nodes.length;a<r;++a)this.graph._nodes[a].mouseOver&&o!=this.graph._nodes[a]&&(this.graph._nodes[a].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(o){if(o.redraw_on_mouse&&(this.dirty_canvas=!0),o.mouseOver||(o.mouseOver=!0,this.node_over=o,this.dirty_canvas=!0,o.onMouseEnter&&o.onMouseEnter(t)),o.onMouseMove&&o.onMouseMove(t,[t.canvasX-o.pos[0],t.canvasY-o.pos[1]],this),this.connecting_node){var l=this._highlight_input||[0,0];if(this.isOverNodeBox(o,t.canvasX,t.canvasY));else{var h=this.isOverNodeInput(o,t.canvasX,t.canvasY,l);if(-1!=h&&o.inputs[h]){var c=o.inputs[h].type;u.isValidConnection(this.connecting_output.type,c)&&(this._highlight_input=l)}else this._highlight_input=null}}this.canvas&&(k(t.canvasX,t.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var p=null;for(a=0;a<this.visible_links.length;++a){var g=this.visible_links[a],v=g._pos;if(!(!v||t.canvasX<v[0]-4||t.canvasX>v[0]+4||t.canvasY<v[1]-4||t.canvasY>v[1]+4)){p=g;break}}p!=this.over_link_center&&(this.over_link_center=p,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=o&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var a in this.selected_nodes){var _=this.selected_nodes[a];_.pos[0]+=n[0]/this.ds.scale,_.pos[1]+=n[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var f=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],y=this.resizing_node.computeSize();f[0]=Math.max(y[0],f[0]),f[1]=Math.max(y[1],f[1]),this.resizing_node.setSize(f),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},d.prototype.processMouseUp=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var e=this.getCanvasWindow().document;d.active_canvas=this,e.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),e.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(t);var n=u.getTime();if(t.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(console.log("foo"),this.block_click=!1),1==t.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group){var i=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),s=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(i,s,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var o=this.graph._nodes,a=new Float32Array(4);this.deselectAllNodes();var r=Math.abs(this.dragging_rectangle[2]),l=Math.abs(this.dragging_rectangle[3]),h=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-r:this.dragging_rectangle[0],c=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-l:this.dragging_rectangle[1];this.dragging_rectangle[0]=h,this.dragging_rectangle[1]=c,this.dragging_rectangle[2]=r,this.dragging_rectangle[3]=l;for(var p=[],g=0;g<o.length;++g){(f=o[g]).getBounding(a),T(this.dragging_rectangle,a)&&p.push(f)}p.length&&this.selectNodes(p)}this.dragging_rectangle=null}else if(this.connecting_node){if(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,f=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))if(this.connecting_output.type==u.EVENT&&this.isOverNodeBox(f,t.canvasX,t.canvasY))this.connecting_node.connect(this.connecting_slot,f,u.EVENT);else{var v=this.isOverNodeInput(f,t.canvasX,t.canvasY);if(-1!=v)this.connecting_node.connect(this.connecting_slot,f,v);else{var _=f.getInputInfo(0);this.connecting_output.type==u.EVENT?this.connecting_node.connect(this.connecting_slot,f,u.EVENT):_&&!_.link&&u.isValidConnection(_.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,f,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){(f=this.node_dragged)&&t.click_time<300&&k(t.canvasX,t.canvasY,f.pos[0],f.pos[1]-u.NODE_TITLE_HEIGHT,u.NODE_TITLE_HEIGHT,u.NODE_TITLE_HEIGHT)&&f.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var f;!(f=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},d.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail;this.adjustMouseEvent(t);var n=this.ds.scale;return e>0?n*=1.1:e<0&&(n*=1/1.1),this.ds.changeScale(n,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}},d.prototype.isOverNodeBox=function(t,e,n){var i=u.NODE_TITLE_HEIGHT;return!!k(e,n,t.pos[0]+2,t.pos[1]+2-i,i-4,i-4)},d.prototype.isOverNodeInput=function(t,e,n,i){if(t.inputs)for(var s=0,o=t.inputs.length;s<o;++s){t.inputs[s];var a=t.getConnectionPos(!0,s);if(t.horizontal?k(e,n,a[0]-5,a[1]-10,10,20):k(e,n,a[0]-10,a[1]-5,40,10))return i&&(i[0]=a[0],i[1]=a[1]),s}return-1},d.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(this.dragging_canvas=!0,e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),"KeyC"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),"KeyV"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.pasteFromClipboard(),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},d.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,n=[];for(var i in this.selected_nodes){(s=this.selected_nodes[i])._relative_id=e,n.push(s),e+=1}for(i=0;i<n.length;++i){var s,o=(s=n[i]).clone();if(o){if(t.nodes.push(o.serialize()),s.inputs&&s.inputs.length)for(var a=0;a<s.inputs.length;++a){var r=s.inputs[a];if(r&&null!=r.link){var l=this.graph.links[r.link];if(l){var h=this.graph.getNodeById(l.origin_id);h&&this.selected_nodes[h.id]&&t.links.push([h._relative_id,l.origin_slot,s._relative_id,l.target_slot])}}}}else console.warn("node type not found: ".concat(s.type))}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},d.prototype.pasteFromClipboard=function(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var e=JSON.parse(t),n=[],i=0;i<e.nodes.length;++i){var s=e.nodes[i],o=u.createNode(s.type);o&&(o.configure(s),o.pos[0]+=5,o.pos[1]+=5,this.graph.add(o),n.push(o))}for(i=0;i<e.links.length;++i){var a=e.links[i],r=n[a[0]],l=n[a[2]];r&&l?r.connect(a[1],l,a[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(n),this.graph.afterChange()}},d.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=[t.canvasX,t.canvasY],n=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(!n){var i=null;return this.onDropItem&&(i=this.onDropItem(event)),void(i||this.checkDropItem(t))}if(n.onDropFile||n.onDropData){var s=t.dataTransfer.files;if(s&&s.length)for(var o=0;o<s.length;o++){var a=t.dataTransfer.files[0],r=a.name;if(d.getFileExtension(r),n.onDropFile&&n.onDropFile(a),n.onDropData){var l=new FileReader;l.onload=function(t){var e=t.target.result;n.onDropData(e,r,a)};var h=a.type.split("/")[0];"text"==h||""==h?l.readAsText(a):"image"==h?l.readAsDataURL(a):l.readAsArrayBuffer(a)}}}return!(!n.onDropItem||!n.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)},d.prototype.checkDropItem=function(t){if(t.dataTransfer.files.length){var e=t.dataTransfer.files[0],n=d.getFileExtension(e.name).toLowerCase(),i=u.node_types_by_file_extension[n];if(i){this.graph.beforeChange();var s=u.createNode(i.type);s.pos=[t.canvasX,t.canvasY],this.graph.add(s),s.onDropFile&&s.onDropFile(e),this.graph.afterChange()}}},d.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},d.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(t)},d.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},d.prototype.selectNodes=function(t,e){e||this.deselectAllNodes(),t=t||this.graph._nodes;for(var n=0;n<t.length;++n){var i=t[n];if(!i.is_selected){if(!i.is_selected&&i.onSelected&&i.onSelected(),i.is_selected=!0,this.selected_nodes[i.id]=i,i.inputs)for(var s=0;s<i.inputs.length;++s)this.highlighted_links[i.inputs[s].link]=!0;if(i.outputs)for(s=0;s<i.outputs.length;++s){var o=i.outputs[s];if(o.links)for(var a=0;a<o.links.length;++a)this.highlighted_links[o.links[a]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},d.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var n=t.outputs[e];if(n.links)for(var i=0;i<n.links.length;++i)delete this.highlighted_links[n.links[i]]}}},d.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,n=t.length;e<n;++e){var i=t[e];i.is_selected&&(i.onDeselected&&i.onDeselected(),i.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},d.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e=this.selected_nodes[t];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&u.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var n=e.graph.links[e.inputs[0].link],i=e.graph.links[e.outputs[0].links[0]],s=e.getInputNode(0),o=e.getOutputNodes(0)[0];s&&o&&s.connect(n.origin_slot,o,i.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},d.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},d.prototype.adjustMouseEvent=function(t){if(this.canvas){var e=this.canvas.getBoundingClientRect();t.localX=t.clientX-e.left,t.localY=t.clientY-e.top}else t.localX=t.clientX,t.localY=t.clientY;t.deltaX=t.localX-this.last_mouse_position[0],t.deltaY=t.localY-this.last_mouse_position[1],this.last_mouse_position[0]=t.localX,this.last_mouse_position[1]=t.localY,t.canvasX=t.localX/this.ds.scale-this.ds.offset[0],t.canvasY=t.localY/this.ds.scale-this.ds.offset[1]},d.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},d.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},d.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},d.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},d.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},d.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var p=new Float32Array(4);d.prototype.computeVisibleNodes=function(t,e){var n=e||[];n.length=0;for(var i=0,s=(t=t||this.graph._nodes).length;i<s;++i){var o=t[i];(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(T(this.visible_area,o.getBounding(p))&&n.push(o))}return n},d.prototype.draw=function(t,e){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var n=u.getTime();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},d.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){t.start2D&&t.start2D();var e=this.canvas;if(t.restore(),t.setTransform(1,0,0,1,0,0),this.dirty_area&&(t.save(),t.beginPath(),t.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),t.clip()),this.clear_background&&t.clearRect(0,0,e.width,e.height),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t),this.graph){t.save(),this.ds.toCanvasContext(t);for(var n=this.computeVisibleNodes(null,this.visible_nodes),i=0;i<n.length;++i){var s=n[i];t.save(),t.translate(s.pos[0],s.pos[1]),this.drawNode(s,t),t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var o=null;switch(this.connecting_output.type){case u.EVENT:o=u.EVENT_LINK_COLOR;break;default:o=u.CONNECTING_LINK_COLOR}this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,this.connecting_output.dir||(this.connecting_node.horizontal?u.DOWN:u.RIGHT),u.CENTER),t.beginPath(),this.connecting_output.type===u.EVENT||this.connecting_output.shape===u.BOX_SHAPE?t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),this.dirty_area&&t.restore(),t.finish2D&&t.finish2D()}},d.prototype.drawSubgraphPanel=function(t){var e=this.graph,n=e._subgraph_node;if(n){var i=n.inputs?n.inputs.length:0,s=300,o=Math.floor(1.6*u.NODE_SLOT_HEIGHT);if(t.fillStyle="#111",t.globalAlpha=.8,t.beginPath(),t.roundRect(10,10,s,(i+1)*o+50,8),t.fill(),t.globalAlpha=1,t.fillStyle="#888",t.font="14px Arial",t.textAlign="left",t.fillText("Graph Inputs",20,34),this.mouse,this.drawButton(280,20,20,20,"X","#151515"))this.closeSubgraph();else{var a=50;if(t.font="20px Arial",n.inputs)for(var r=0;r<n.inputs.length;++r){var l=n.inputs[r];if(!l.not_subgraph_input){if(this.drawButton(20,a+2,280,o-2)){var h=n.constructor.input_node_type||"graph/input";this.graph.beforeChange();var c=u.createNode(h);c?(e.add(c),this.block_click=!1,this.last_click_position=null,this.selectNodes([c]),this.node_dragged=c,this.dragging_canvas=!1,c.setProperty("name",l.name),c.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",h)}t.fillStyle="#9C9",t.beginPath(),t.arc(284,a+.5*o,5,0,2*Math.PI),t.fill(),t.fillStyle="#AAA",t.fillText(l.name,50,a+.75*o);var d=t.measureText(l.name);t.fillStyle="#777",t.fillText(l.type,50+d.width+10,a+.75*o),a+=o}}this.drawButton(20,a+2,280,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(n)}}else console.warn("subgraph without subnode")},d.prototype.drawButton=function(t,e,n,i,s,o,a,r){var l=this.ctx;o=o||u.NODE_DEFAULT_COLOR,a=a||"#555",r=r||u.NODE_TEXT_COLOR;var h=this.mouse,c=u.isInsideRectangle(h[0],h[1],t,e,n,i),d=(h=this.last_click_position)&&u.isInsideRectangle(h[0],h[1],t,e,n,i);l.fillStyle=c?a:o,d&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(t,e,n,i,4),l.fill(),null!=s&&s.constructor==String&&(l.fillStyle=r,l.textAlign="center",l.font="".concat(.65*i|0,"px Arial"),l.fillText(s,t+.5*n,e+.75*i),l.textAlign="left");var p=d&&!this.block_click;return d&&this.blockClick(),p},d.prototype.isAreaClicked=function(t,e,n,i,s){var o=this.mouse;u.isInsideRectangle(o[0],o[1],t,e,n,i);var a=(o=this.last_click_position)&&u.isInsideRectangle(o[0],o[1],t,e,n,i),r=a&&!this.block_click;return a&&s&&this.blockClick(),r},d.prototype.renderInfo=function(t,e,n){e=e||10,n=n||this.canvas.height-80,t.save(),t.translate(e,n),t.font="10px Arial",t.fillStyle="#888",this.graph?(t.fillText("T: ".concat(this.graph.globaltime.toFixed(2),"s"),5,13),t.fillText("I: ".concat(this.graph.iteration),5,26),t.fillText("N: ".concat(this.graph._nodes.length," [").concat(this.visible_nodes.length,"]"),5,39),t.fillText("V: ".concat(this.graph._version),5,52),t.fillText("FPS:".concat(this.fps.toFixed(2)),5,65)):t.fillText("No graph selected",5,13),t.restore()},d.prototype.drawBackCanvas=function(){var t=this.bgcanvas;t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;if(e.start&&e.start(),this.clear_background&&e.clearRect(0,0,t.width,t.height),this._graph_stack&&this._graph_stack.length){e.save(),this._graph_stack[this._graph_stack.length-1];var n=this.graph._subgraph_node;e.strokeStyle=n.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=n.bgcolor||"#AAA";for(var i="",s=1;s<this._graph_stack.length;++s)i+="".concat(this._graph_stack[s]._subgraph_node.getTitle()," >> ");e.fillText(i+n.getTitle(),.5*t.width,40),e.restore()}var o=!1;if(this.onRenderBackground&&(o=this.onRenderBackground(t,e)),e.restore(),e.setTransform(1,0,0,1,0,0),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.background_image&&this.ds.scale>.5&&!o){if(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var a=this;this._bg_img.onload=function(){a.draw(!0,!0)}}var r=null;null==this._pattern&&this._bg_img.width>0?(r=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=r):r=this._pattern,r&&(e.fillStyle=r,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var g=new Float32Array(2);d.prototype.drawNode=function(t,e){this.current_node=t;var n=t.color||t.constructor.color||u.NODE_DEFAULT_COLOR,i=t.bgcolor||t.constructor.bgcolor||u.NODE_DEFAULT_BGCOLOR;t.mouseOver;var s=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else{var o=this.editor_alpha;if(e.globalAlpha=o,this.render_shadows&&!s?(e.shadowColor=u.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var a=t._shape||u.BOX_SHAPE,r=g;g.set(t.size);var l=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var h=t.getTitle?t.getTitle():t.title;null!=h&&(t._collapsed_width=Math.min(t.size[0],e.measureText(h).width+2*u.NODE_TITLE_HEIGHT),r[0]=t._collapsed_width,r[1]=0)}t.clip_area&&(e.save(),e.beginPath(),a==u.BOX_SHAPE?e.rect(0,0,r[0],r[1]):a==u.ROUND_SHAPE?e.roundRect(0,0,r[0],r[1],10):a==u.CIRCLE_SHAPE&&e.arc(.5*r[0],.5*r[1],.5*r[0],0,2*Math.PI),e.clip()),t.has_errors&&(i="red"),this.drawNodeShape(t,e,r,n,i,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=l?"center":"left",e.font=this.inner_text_font;var c=!s,d=this.connecting_output;e.lineWidth=1;var p=0,v=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var _=null,f=null;if(t.inputs)for(b=0;b<t.inputs.length;b++){if(null!=(k=t.inputs[b]).link){_=k;break}}if(t.outputs)for(b=0;b<t.outputs.length;b++){(k=t.outputs[b]).links&&k.links.length&&(f=k)}if(_){var y=0,m=-.5*u.NODE_TITLE_HEIGHT;l&&(y=.5*t._collapsed_width,m=-u.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),k.type===u.EVENT||k.shape===u.BOX_SHAPE?e.rect(y-7+.5,m-4,14,8):k.shape===u.ARROW_SHAPE?(e.moveTo(y+8,m),e.lineTo(y+-4,m-4),e.lineTo(y+-4,m+4),e.closePath()):e.arc(y,m,4,0,2*Math.PI),e.fill()}if(f){y=t._collapsed_width,m=-.5*u.NODE_TITLE_HEIGHT;l&&(y=.5*t._collapsed_width,m=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),k.type===u.EVENT||k.shape===u.BOX_SHAPE?e.rect(y-7+.5,m-4,14,8):k.shape===u.ARROW_SHAPE?(e.moveTo(y+6,m),e.lineTo(y-6,m-4),e.lineTo(y-6,m+4),e.closePath()):e.arc(y,m,4,0,2*Math.PI),e.fill()}}}else{if(t.inputs)for(var b=0;b<t.inputs.length;b++){var k=t.inputs[b];if(e.globalAlpha=o,this.connecting_node&&!u.isValidConnection(k.type,d.type)&&(e.globalAlpha=.4*o),e.fillStyle=null!=k.link?k.color_on||this.default_connection_color.input_on:k.color_off||this.default_connection_color.input_off,(T=t.getConnectionPos(!0,b,v))[0]-=t.pos[0],T[1]-=t.pos[1],p<T[1]+.5*u.NODE_SLOT_HEIGHT&&(p=T[1]+.5*u.NODE_SLOT_HEIGHT),e.beginPath(),k.type===u.EVENT||k.shape===u.BOX_SHAPE?l?e.rect(T[0]-5+.5,T[1]-8+.5,10,14):e.rect(T[0]-6+.5,T[1]-5+.5,14,10):k.shape===u.ARROW_SHAPE?(e.moveTo(T[0]+8,T[1]+.5),e.lineTo(T[0]-4,T[1]+6+.5),e.lineTo(T[0]-4,T[1]-6+.5),e.closePath()):s?e.rect(T[0]-4,T[1]-4,8,8):e.arc(T[0],T[1],4,0,2*Math.PI),e.fill(),c)(E=null!=k.label?k.label:k.name)&&(e.fillStyle=u.NODE_TEXT_COLOR,l||k.dir==u.UP?e.fillText(E,T[0],T[1]-10):e.fillText(E,T[0]+10,T[1]+5))}if(this.connecting_node&&(e.globalAlpha=.4*o),e.textAlign=l?"center":"right",e.strokeStyle="black",t.outputs)for(var b=0;b<t.outputs.length;b++){var T,E,k=t.outputs[b];if((T=t.getConnectionPos(!1,b,v))[0]-=t.pos[0],T[1]-=t.pos[1],p<T[1]+.5*u.NODE_SLOT_HEIGHT&&(p=T[1]+.5*u.NODE_SLOT_HEIGHT),e.fillStyle=k.links&&k.links.length?k.color_on||this.default_connection_color.output_on:k.color_off||this.default_connection_color.output_off,e.beginPath(),k.type===u.EVENT||k.shape===u.BOX_SHAPE?l?e.rect(T[0]-5+.5,T[1]-8+.5,10,14):e.rect(T[0]-6+.5,T[1]-5+.5,14,10):k.shape===u.ARROW_SHAPE?(e.moveTo(T[0]+8,T[1]+.5),e.lineTo(T[0]-4,T[1]+6+.5),e.lineTo(T[0]-4,T[1]-6+.5),e.closePath()):s?e.rect(T[0]-4,T[1]-4,8,8):e.arc(T[0],T[1],4,0,2*Math.PI),e.fill(),s||e.stroke(),c)(E=null!=k.label?k.label:k.name)&&(e.fillStyle=u.NODE_TEXT_COLOR,l||k.dir==u.DOWN?e.fillText(E,T[0],T[1]-8):e.fillText(E,T[0]-10,T[1]+5))}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var C=p;(l||t.widgets_up)&&(C=2),null!=t.widgets_start_y&&(C=t.widgets_start_y),this.drawNodeWidgets(t,C,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}}},d.prototype.drawLinkTooltip=function(t,e){var n=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(n[0],n[1],3,0,2*Math.PI),t.fill(),null!=e.data&&(!this.onDrawLinkTooltip||1!=this.onDrawLinkTooltip(t,e,this))){var i=e.data,s=null;if(null!=(s=i.constructor===Number?i.toFixed(2):i.constructor===String?'"'.concat(i,'"'):i.constructor===Boolean?String(i):i.toToolTip?i.toToolTip():"[".concat(i.constructor.name,"]"))){s=s.substr(0,30),t.font="14px Courier New";var o=t.measureText(s).width+20;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-.5*o,n[1]-15-24,o,24,3,3),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(s,n[0],n[1]-15-24*.3)}}};var v=new Float32Array(4);d.prototype.drawNodeShape=function(t,e,n,i,s,o,a){e.strokeStyle=i,e.fillStyle=s;var r=u.NODE_TITLE_HEIGHT,l=this.ds.scale<.5,h=t._shape||t.constructor.shape||u.ROUND_SHAPE,c=t.constructor.title_mode,p=!0;c==u.TRANSPARENT_TITLE?p=!1:c==u.AUTOHIDE_TITLE&&a&&(p=!0);var g=v;g[0]=0,g[1]=p?-r:0,g[2]=n[0]+1,g[3]=p?n[1]+r:n[1];var _=e.globalAlpha;if(e.beginPath(),h==u.BOX_SHAPE||l?e.fillRect(g[0],g[1],g[2],g[3]):h==u.ROUND_SHAPE||h==u.CARD_SHAPE?e.roundRect(g[0],g[1],g[2],g[3],this.round_radius,h==u.CARD_SHAPE?0:this.round_radius):h==u.CIRCLE_SHAPE&&e.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),e.fill(),t.flags.collapsed||(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,g[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),p||c==u.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(e,r,n,this.ds.scale,i);else if(c!=u.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var f=t.constructor.title_color||i;if(t.flags.collapsed&&(e.shadowColor=u.DEFAULT_SHADOW_COLOR),this.use_gradients){var y=d.gradients[f];y||((y=d.gradients[f]=e.createLinearGradient(0,0,400,0)).addColorStop(0,f),y.addColorStop(1,"#000")),e.fillStyle=y}else e.fillStyle=f;e.beginPath(),h==u.BOX_SHAPE||l?e.rect(0,-r,n[0]+1,r):h!=u.ROUND_SHAPE&&h!=u.CARD_SHAPE||e.roundRect(0,-r,n[0]+1,r,this.round_radius,t.flags.collapsed?this.round_radius:0),e.fill(),e.shadowColor="transparent"}var m=10;if(t.onDrawTitleBox?t.onDrawTitleBox(e,r,n,this.ds.scale):h==u.ROUND_SHAPE||h==u.CIRCLE_SHAPE||h==u.CARD_SHAPE?(l&&(e.fillStyle="black",e.beginPath(),e.arc(.5*r,-.5*r,6,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||u.NODE_DEFAULT_BOXCOLOR,l?e.fillRect(.5*r-5,-.5*r-5,m,m):(e.beginPath(),e.arc(.5*r,-.5*r,5,0,2*Math.PI),e.fill())):(l&&(e.fillStyle="black",e.fillRect(.5*(r-m)-1,-.5*(r+m)-1,12,12)),e.fillStyle=t.boxcolor||u.NODE_DEFAULT_BOXCOLOR,e.fillRect(.5*(r-m),-.5*(r+m),m,m)),e.globalAlpha=_,t.onDrawTitleText&&t.onDrawTitleText(e,r,n,this.ds.scale,this.title_text_font,o),!l){e.font=this.title_text_font;var b=String(t.getTitle());b&&(e.fillStyle=o?u.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.measureText(b),e.fillText(b.substr(0,20),r,u.NODE_TITLE_TEXT_Y-r),e.textAlign="left"):(e.textAlign="left",e.fillText(b,r,u.NODE_TITLE_TEXT_Y-r)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var k=u.NODE_TITLE_HEIGHT,T=t.size[0]-k,E=u.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],T+2,2-k,k-4,k-4);e.fillStyle=E?"#888":"#555",h==u.BOX_SHAPE||l?e.fillRect(T+2,2-k,k-4,k-4):(e.beginPath(),e.roundRect(T+2,2-k,k-4,k-4,4),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(T+.2*k,.6*-k),e.lineTo(T+.8*k,.6*-k),e.lineTo(T+.5*k,.3*-k),e.fill()}t.onDrawTitle&&t.onDrawTitle(e)}o&&(t.onBounding&&t.onBounding(g),c==u.TRANSPARENT_TITLE&&(g[1]-=r,g[3]+=r),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),h==u.BOX_SHAPE?e.rect(-6+g[0],-6+g[1],12+g[2],12+g[3]):h==u.ROUND_SHAPE||h==u.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius):h==u.CARD_SHAPE?e.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius,2):h==u.CIRCLE_SHAPE&&e.arc(.5*n[0],.5*n[1],.5*n[0]+6,0,2*Math.PI),e.strokeStyle=u.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=i,e.globalAlpha=1)};var _=new Float32Array(4),f=new Float32Array(4),y=new Float32Array(2),m=new Float32Array(2);function b(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function k(t,e,n,i,s,o){return n<t&&n+s>t&&i<e&&i+o>e}function T(t,e){var n=t[0]+t[2],i=t[1]+t[3],s=e[0]+e[2],o=e[1]+e[3];return!(t[0]>s||t[1]>o||n<e[0]||i<e[1])}function E(t,e){e=e||{},this.options=e;var n=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var i=null;e.event&&(i=e.event.constructor.name),"MouseEvent"!==i&&"CustomEvent"!==i&&"PointerEvent"!==i&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),e.event=null);var s=document.createElement("div");function o(t){var n=parseInt(s.style.top);return s.style.top="".concat((n+t.deltaY*e.scroll_speed).toFixed(),"px"),t.preventDefault(),!0}if(s.className="litegraph litecontextmenu litemenubar-panel",e.className&&(s.className+=" ".concat(e.className)),s.style.minWidth=100,s.style.minHeight=100,s.style.pointerEvents="none",setTimeout((function(){s.style.pointerEvents="auto"}),100),s.addEventListener("mouseup",(function(t){return t.preventDefault(),!0}),!0),s.addEventListener("contextmenu",(function(t){return 2!=t.button||t.preventDefault(),!1}),!0),s.addEventListener("mousedown",(function(t){if(2==t.button)return n.close(),t.preventDefault(),!0}),!0),e.scroll_speed||(e.scroll_speed=.1),s.addEventListener("wheel",o,!0),s.addEventListener("mousewheel",o,!0),this.root=s,e.title){var a=document.createElement("div");a.className="litemenu-title",a.innerHTML=e.title,s.appendChild(a)}for(var r=0;r<t.length;r++){var l=t.constructor==Array?t[r]:r;null!=l&&l.constructor!==String&&(l=void 0===l.content?String(l):l.content);var h=t[r];this.addItem(l,h,e)}s.addEventListener("mouseleave",(function(t){n.lock||(s.closing_timer&&clearTimeout(s.closing_timer),s.closing_timer=setTimeout(n.close.bind(n,t),500))})),s.addEventListener("mouseenter",(function(t){s.closing_timer&&clearTimeout(s.closing_timer)}));var u=document;e.event&&(u=e.event.target.ownerDocument),u||(u=document),u.fullscreenElement?u.fullscreenElement.appendChild(s):u.body.appendChild(s);var c=e.left||0,d=e.top||0;if(e.event){if(c=e.event.clientX-10,d=e.event.clientY-10,e.title&&(d-=20),e.parentMenu){var p=e.parentMenu.root.getBoundingClientRect();c=p.left+p.width}var g=document.body.getBoundingClientRect(),v=s.getBoundingClientRect();0==g.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),g.width&&c>g.width-v.width-10&&(c=g.width-v.width-10),g.height&&d>g.height-v.height-10&&(d=g.height-v.height-10)}s.style.left="".concat(c,"px"),s.style.top="".concat(d,"px"),e.scale&&(s.style.transform="scale(".concat(e.scale,")"))}function C(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}d.prototype.drawConnections=function(t){var e=u.getTime(),n=this.visible_area;_[0]=n[0]-20,_[1]=n[1]-20,_[2]=n[2]+40,_[3]=n[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var i=this.graph._nodes,s=0,o=i.length;s<o;++s){var a=i[s];if(a.inputs&&a.inputs.length)for(var r=0;r<a.inputs.length;++r){var l=a.inputs[r];if(l&&null!=l.link){var h=l.link,c=this.graph.links[h];if(c){var d=this.graph.getNodeById(c.origin_id);if(null!=d){var p=c.origin_slot,g=null;g=-1==p?[d.pos[0]+10,d.pos[1]+10]:d.getConnectionPos(!1,p,y);var v=a.getConnectionPos(!0,r,m);if(f[0]=g[0],f[1]=g[1],f[2]=v[0]-g[0],f[3]=v[1]-g[1],f[2]<0&&(f[0]+=f[2],f[2]=Math.abs(f[2])),f[3]<0&&(f[1]+=f[3],f[3]=Math.abs(f[3])),T(f,_)){var b=d.outputs[p],k=a.inputs[r];if(b&&k){var E=b.dir||(d.horizontal?u.DOWN:u.RIGHT),C=k.dir||(a.horizontal?u.UP:u.LEFT);if(this.renderLink(t,g,v,c,!1,0,null,E,C),c&&c._last_time&&e-c._last_time<1e3){var w=2-.002*(e-c._last_time),N=t.globalAlpha;t.globalAlpha=N*w,this.renderLink(t,g,v,c,!0,w,"white",E,C),t.globalAlpha=N}}}}}}}}t.globalAlpha=1},d.prototype.renderLink=function(t,e,n,i,s,o,a,r,l,h){i&&this.visible_links.push(i),!a&&i&&(a=i.color||d.link_type_colors[i.type]),a||(a=this.default_link_color),null!=i&&this.highlighted_links[i.id]&&(a="#FFF"),r=r||u.RIGHT,l=l||u.LEFT;var c=b(e,n);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(h=h||1)>1&&(t.lineWidth=.5),t.beginPath();for(var p=0;p<h;p+=1){var g=5*(p-.5*(h-1));if(this.links_render_mode==u.SPLINE_LINK){t.moveTo(e[0],e[1]+g);var v=0,_=0,f=0,y=0;switch(r){case u.LEFT:v=-.25*c;break;case u.RIGHT:v=.25*c;break;case u.UP:_=-.25*c;break;case u.DOWN:_=.25*c}switch(l){case u.LEFT:f=-.25*c;break;case u.RIGHT:f=.25*c;break;case u.UP:y=-.25*c;break;case u.DOWN:y=.25*c}t.bezierCurveTo(e[0]+v,e[1]+_+g,n[0]+f,n[1]+y+g,n[0],n[1]+g)}else if(this.links_render_mode==u.LINEAR_LINK){t.moveTo(e[0],e[1]+g);v=0,_=0,f=0,y=0;switch(r){case u.LEFT:v=-1;break;case u.RIGHT:v=1;break;case u.UP:_=-1;break;case u.DOWN:_=1}switch(l){case u.LEFT:f=-1;break;case u.RIGHT:f=1;break;case u.UP:y=-1;break;case u.DOWN:y=1}t.lineTo(e[0]+15*v,e[1]+15*_+g),t.lineTo(n[0]+15*f,n[1]+15*y+g),t.lineTo(n[0],n[1]+g)}else{if(this.links_render_mode!=u.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);var m=e[0],k=e[1],T=n[0],E=n[1];r==u.RIGHT?m+=10:k+=10,l==u.LEFT?T-=10:E-=10,t.lineTo(m,k),t.lineTo(.5*(m+T),k),t.lineTo(.5*(m+T),E),t.lineTo(T,E),t.lineTo(n[0],n[1])}}this.render_connections_border&&this.ds.scale>.6&&!s&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var C=this.computeConnectionPoint(e,n,.5,r,l);if(i&&i._pos&&(i._pos[0]=C[0],i._pos[1]=C[1]),this.ds.scale>=.6&&this.highquality_render&&l!=u.CENTER){if(this.render_connection_arrows){var w=this.computeConnectionPoint(e,n,.25,r,l),N=this.computeConnectionPoint(e,n,.26,r,l),O=this.computeConnectionPoint(e,n,.75,r,l),S=this.computeConnectionPoint(e,n,.76,r,l),A=0,I=0;this.render_curved_connections?(A=-Math.atan2(N[0]-w[0],N[1]-w[1]),I=-Math.atan2(S[0]-O[0],S[1]-O[1])):I=A=n[1]>e[1]?0:Math.PI,t.save(),t.translate(w[0],w[1]),t.rotate(A),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(O[0],O[1]),t.rotate(I),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}if(o){t.fillStyle=a;for(p=0;p<5;++p){var L=(.001*u.getTime()+.2*p)%1;C=this.computeConnectionPoint(e,n,L,r,l);t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}}},d.prototype.computeConnectionPoint=function(t,e,n,i,s){i=i||u.RIGHT,s=s||u.LEFT;var o=b(t,e),a=t,r=[t[0],t[1]],l=[e[0],e[1]],h=e;switch(i){case u.LEFT:r[0]+=-.25*o;break;case u.RIGHT:r[0]+=.25*o;break;case u.UP:r[1]+=-.25*o;break;case u.DOWN:r[1]+=.25*o}switch(s){case u.LEFT:l[0]+=-.25*o;break;case u.RIGHT:l[0]+=.25*o;break;case u.UP:l[1]+=-.25*o;break;case u.DOWN:l[1]+=.25*o}var c=(1-n)*(1-n)*(1-n),d=(1-n)*(1-n)*3*n,p=3*(1-n)*(n*n),g=n*n*n;return[c*a[0]+d*r[0]+p*l[0]+g*h[0],c*a[1]+d*r[1]+p*l[1]+g*h[1]]},d.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,n=0;n<e.length;++n){var i=e[n];t.fillStyle="black",t.fillRect(i.pos[0]-u.NODE_TITLE_HEIGHT,i.pos[1]-u.NODE_TITLE_HEIGHT,u.NODE_TITLE_HEIGHT,u.NODE_TITLE_HEIGHT),0==i.order&&t.strokeRect(i.pos[0]-u.NODE_TITLE_HEIGHT+.5,i.pos[1]-u.NODE_TITLE_HEIGHT+.5,u.NODE_TITLE_HEIGHT,u.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(i.order,i.pos[0]+-.5*u.NODE_TITLE_HEIGHT,i.pos[1]-6)}t.globalAlpha=1},d.prototype.drawNodeWidgets=function(t,e,n,i){if(!t.widgets||!t.widgets.length)return 0;var s=t.size[0],o=t.widgets;e+=2;var a=u.NODE_WIDGET_HEIGHT,r=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;for(var l=u.WIDGET_OUTLINE_COLOR,h=u.WIDGET_BGCOLOR,c=u.WIDGET_TEXT_COLOR,d=u.WIDGET_SECONDARY_TEXT_COLOR,p=15,g=0;g<o.length;++g){var v=o[g],_=e;v.y&&(_=v.y),v.last_y=_,n.strokeStyle=l,n.fillStyle="#222",n.textAlign="left",v.disabled&&(n.globalAlpha*=.5);var f=v.width||s;switch(v.type){case"button":v.clicked&&(n.fillStyle="#AAA",v.clicked=!1,this.dirty_canvas=!0),n.fillRect(p,_,f-30,a),r&&!v.disabled&&n.strokeRect(p,_,f-30,a),r&&(n.textAlign="center",n.fillStyle=c,n.fillText(v.name,.5*f,_+.7*a));break;case"toggle":n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),r?n.roundRect(p,e,f-30,a,.5*a):n.rect(p,e,f-30,a),n.fill(),r&&!v.disabled&&n.stroke(),n.fillStyle=v.value?"#89A":"#333",n.beginPath(),n.arc(f-30,_+.5*a,.36*a,0,2*Math.PI),n.fill(),r&&(n.fillStyle=d,null!=v.name&&n.fillText(v.name,30,_+.7*a),n.fillStyle=v.value?c:d,n.textAlign="right",n.fillText(v.value?v.options.on||"true":v.options.off||"false",f-40,_+.7*a));break;case"slider":n.fillStyle=h,n.fillRect(p,_,f-30,a);var y=v.options.max-v.options.min,m=(v.value-v.options.min)/y;if(n.fillStyle=i==v?"#89A":"#678",n.fillRect(p,_,m*(f-30),a),r&&!v.disabled&&n.strokeRect(p,_,f-30,a),v.marker){var b=(v.marker-v.options.min)/y;n.fillStyle="#AA9",n.fillRect(p+b*(f-30),_,2,a)}r&&(n.textAlign="center",n.fillStyle=c,n.fillText("".concat(v.name,"  ").concat(Number(v.value).toFixed(3)),.5*f,_+.7*a));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),r?n.roundRect(p,e,f-30,a,.5*a):n.rect(p,e,f-30,a),n.fill(),r)if(v.disabled||n.stroke(),n.fillStyle=c,v.disabled||(n.beginPath(),n.moveTo(31,e+5),n.lineTo(21,e+.5*a),n.lineTo(31,e+a-5),n.fill(),n.beginPath(),n.moveTo(f-p-16,e+5),n.lineTo(f-p-6,e+.5*a),n.lineTo(f-p-16,e+a-5),n.fill()),n.fillStyle=d,n.fillText(v.name,35,_+.7*a),n.fillStyle=c,n.textAlign="right","number"==v.type)n.fillText(Number(v.value).toFixed(void 0!==v.options.precision?v.options.precision:3),f-30-20,_+.7*a);else{var k=v.value;if(v.options.values){var T=v.options.values;T.constructor===Function&&(T=T()),T&&T.constructor!==Array&&(k=T[v.value])}n.fillText(k,f-30-20,_+.7*a)}break;case"string":case"text":n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),r?n.roundRect(p,e,f-30,a,.5*a):n.rect(p,e,f-30,a),n.fill(),r&&(v.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(p,e,f-30,a),n.clip(),n.fillStyle=d,null!=v.name&&n.fillText(v.name,30,_+.7*a),n.fillStyle=c,n.textAlign="right",n.fillText(String(v.value).substr(0,30),f-30,_+.7*a),n.restore());break;default:v.draw&&v.draw(n,t,f,_,a)}e+=(v.computeSize?v.computeSize(f)[1]:a)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"},d.prototype.processNodeWidgets=function(t,e,n,i){if(!t.widgets||!t.widgets.length)return null;for(var s=e[0]-t.pos[0],o=e[1]-t.pos[1],a=t.size[0],r=this,l=this.getCanvasWindow(),h=0;h<t.widgets.length;++h){var c=t.widgets[h];if(c&&!c.disabled){var d=c.computeSize?c.computeSize(a)[1]:u.NODE_WIDGET_HEIGHT,p=c.width||a;if(c==i||!(s<6||s>p-12||o<c.last_y||o>c.last_y+d)){var g=c.value;switch(c.type){case"button":if("mousemove"===n.type)break;c.callback&&setTimeout((function(){c.callback(c,r,t,e,n)}),20),c.clicked=!0,this.dirty_canvas=!0;break;case"slider":c.options.max,c.options.min;var v=Math.clamp((s-15)/(p-30),0,1);c.value=c.options.min+(c.options.max-c.options.min)*v,c.callback&&setTimeout((function(){k(c,c.value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":g=c.value;if("mousemove"==n.type&&"number"==c.type)c.value+=.1*n.deltaX*(c.options.step||1),null!=c.options.min&&c.value<c.options.min&&(c.value=c.options.min),null!=c.options.max&&c.value>c.options.max&&(c.value=c.options.max);else if("mousedown"==n.type){var _=c.options.values;_&&_.constructor===Function&&(_=c.options.values(c,t));var f=null;"number"!=c.type&&(f=_.constructor===Array?_:Object.keys(_));var y=s<40?-1:s>p-40?1:0;if("number"==c.type)c.value+=.1*y*(c.options.step||1),null!=c.options.min&&c.value<c.options.min&&(c.value=c.options.min),null!=c.options.max&&c.value>c.options.max&&(c.value=c.options.max);else if(y){var m=-1;this.last_mouseclick=0,(m=_.constructor===Object?f.indexOf(String(c.value))+y:f.indexOf(c.value)+y)>=f.length&&(m=f.length-1),m<0&&(m=0),_.constructor===Array?c.value=_[m]:c.value=m}else{var b=_!=f?Object.values(_):_;new u.ContextMenu(b,{scale:Math.max(1,this.ds.scale),event:n,className:"dark",callback:function(t,e,n){return _!=f&&(t=b.indexOf(t)),this.value=t,k(this,t),r.dirty_canvas=!0,!1}.bind(c)},l)}}else if("mouseup"==n.type&&"number"==c.type){y=s<40?-1:s>p-40?1:0;n.click_time<200&&0==y&&this.prompt("Value",c.value,function(t){this.value=Number(t),k(this,this.value)}.bind(c),n)}g!=c.value&&setTimeout(function(){k(this,this.value)}.bind(c),20),this.dirty_canvas=!0;break;case"toggle":"mousedown"==n.type&&(c.value=!c.value,setTimeout((function(){k(c,c.value)}),20));break;case"string":case"text":"mousedown"==n.type&&this.prompt("Value",c.value,function(t){this.value=t,k(this,t)}.bind(c),n,!!c.options&&c.options.multiline);break;default:c.mouse&&(this.dirty_canvas=c.mouse(n,[s,o],t))}return g!=c.value&&(t.onWidgetChanged&&t.onWidgetChanged(c.name,c.value,g,c),t.graph._version++),c}}}function k(i,s){i.value=s,i.options&&i.options.property&&void 0!==t.properties[i.options.property]&&t.setProperty(i.options.property,s),i.callback&&i.callback(i.value,r,t,e,n)}return null},d.prototype.drawGroups=function(t,e){if(this.graph){var n=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var i=0;i<n.length;++i){var s=n[i];if(T(this.visible_area,s._bounding)){e.fillStyle=s.color||"#335",e.strokeStyle=s.color||"#335";var o=s._pos,a=s._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(o[0]+.5,o[1]+.5,a[0],a[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(o[0]+a[0],o[1]+a[1]),e.lineTo(o[0]+a[0]-10,o[1]+a[1]),e.lineTo(o[0]+a[0],o[1]+a[1]-10),e.fill();var r=s.font_size||u.DEFAULT_GROUP_FONT_SIZE;e.font="".concat(r,"px Arial"),e.fillText(s.title,o[0]+4,o[1]+r)}}e.restore()}},d.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},d.prototype.resize=function(t,e){if(!t&&!e){var n=this.canvas.parentNode;t=n.offsetWidth,e=n.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},d.prototype.switchLiveMode=function(t){if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var e=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){e.editor_alpha*=n,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,n<1&&e.editor_alpha<.01&&(clearInterval(i),n<1&&(e.live_mode=!0)),n>1&&e.editor_alpha>.99&&(clearInterval(i),e.editor_alpha=1)}),1)},d.prototype.onNodeSelectionChange=function(t){},d.prototype.touchHandler=function(t){var e=t.changedTouches[0],n="";switch(t.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=this.getCanvasWindow(),s=i.document.createEvent("MouseEvent");s.initMouseEvent(n,!0,!0,i,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(s),t.preventDefault()},d.onGroupAdd=function(t,e,n){var i=d.active_canvas;i.getCanvasWindow();var s=new u.LGraphGroup;s.pos=i.convertEventToCanvasOffset(n),i.graph.add(s)},d.onMenuAdd=function(t,e,n,i,s){var o=d.active_canvas,a=o.getCanvasWindow(),r=o.graph;if(r)return function t(e,i){var l=u.getNodeTypesCategories(o.filter||r.filter).filter((function(t){return t.startsWith(e)})),h=[];l.map((function(n){if(n){var i=new RegExp("^(".concat(e,")")),s=n.replace(i,"").split("/")[0],o="".concat(""===e?s:e+s,"/"),a=s;-1!=a.indexOf("::")&&(a=a.split("::")[1]),-1===h.findIndex((function(t){return t.value===o}))&&h.push({value:o,content:a,has_submenu:!0,callback:function(e,n,i,s){t(e.value,s)}})}})),u.getNodeTypesInCategory(e.slice(0,-1),o.filter||r.filter).map((function(t){if(!t.skip_list){var e={value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,n,i){var a=i.getFirstEvent();o.graph.beforeChange();var r=u.createNode(t.value);r&&(r.pos=o.convertEventToCanvasOffset(a),o.graph.add(r)),s&&s(r),o.graph.afterChange()}};h.push(e)}})),new u.ContextMenu(h,{event:n,parentMenu:i},a)}("",i),!1},d.onMenuCollapseAll=function(){},d.onMenuNodeEdit=function(){},d.showMenuNodeOptionalInputs=function(t,e,n,i,s){if(s){var o=this,a=d.active_canvas.getCanvasWindow();e=s.optional_inputs;s.onGetInputs&&(e=s.onGetInputs());var r=[];if(e)for(var l=0;l<e.length;l++){var h=e[l];if(h){var c=h[0];h[2]&&h[2].label&&(c=h[2].label);var p={content:c,value:h};h[1]==u.ACTION&&(p.className="event"),r.push(p)}else r.push(null)}if(this.onMenuNodeInputs&&(r=this.onMenuNodeInputs(r)),r.length)return new u.ContextMenu(r,{event:n,callback:function(t,e,n){if(!s)return;t.callback&&t.callback.call(o,s,t,e,n);t.value&&(s.graph.beforeChange(),s.addInput(t.value[0],t.value[1],t.value[2]),s.setDirtyCanvas(!0,!0),s.graph.afterChange())},parentMenu:i,node:s},a),!1;console.log("no input entries")}},d.showMenuNodeOptionalOutputs=function(t,e,n,i,s){if(s){var o=this,a=d.active_canvas.getCanvasWindow();e=s.optional_outputs;s.onGetOutputs&&(e=s.onGetOutputs());var r=[];if(e)for(var l=0;l<e.length;l++){var h=e[l];if(h){if(!s.flags||!s.flags.skip_repeated_outputs||-1==s.findOutputSlot(h[0])){var c=h[0];h[2]&&h[2].label&&(c=h[2].label);var p={content:c,value:h};h[1]==u.EVENT&&(p.className="event"),r.push(p)}}else r.push(null)}if(this.onMenuNodeOutputs&&(r=this.onMenuNodeOutputs(r)),r.length)return new u.ContextMenu(r,{event:n,callback:function t(e,n,a){if(!s)return;e.callback&&e.callback.call(o,s,e,n,a);if(!e.value)return;var r=e.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var l=[];for(var h in r)l.push({content:h,value:r[h]});return new u.ContextMenu(l,{event:n,callback:t,parentMenu:i,node:s}),!1}s.graph.beforeChange(),s.addOutput(e.value[0],e.value[1],e.value[2]),s.setDirtyCanvas(!0,!0),s.graph.afterChange()},parentMenu:i,node:s},a),!1}},d.onShowMenuNodeProperties=function(t,n,i,s,o){if(o&&o.properties){var a=d.active_canvas,r=a.getCanvasWindow(),l=[];for(var h in o.properties){"object"===e(t=void 0!==o.properties[h]?o.properties[h]:" ")&&(t=JSON.stringify(t));var c=o.getPropertyInfo(h);"enum"!=c.type&&"combo"!=c.type||(t=d.getPropertyPrintableValue(t,c.values)),t=d.decodeHTML(t),l.push({content:'<span class="property_name">'.concat(c.label?c.label:h,"</span>")+'<span class="property_value">'.concat(t,"</span>"),value:h})}if(l.length)return new u.ContextMenu(l,{event:i,callback:function(t,e,n,i){if(!o)return;var s=this.getBoundingClientRect();a.showEditPropertyValue(o,t.value,{position:[s.left,s.top]})},parentMenu:s,allow_html:!0,node:o},r),!1}},d.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},d.onResizeNode=function(t,e,n,i,s){s&&(s.size=s.computeSize(),s.onResize&&s.onResize(s.size),s.setDirtyCanvas(!0,!0))},d.prototype.showLinkMenu=function(t,e){var n=this;console.log(t);var i=new u.ContextMenu(["Add Node",null,"Delete"],{event:e,title:null!=t.data?t.data.constructor.name:null,callback:function(e,s,o){switch(e){case"Add Node":d.onMenuAdd(null,null,o,i,(function(e){console.log("node autoconnect");var i=n.graph.getNodeById(t.origin_id),s=n.graph.getNodeById(t.target_id);e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&i.outputs[t.origin_slot].type==e.inputs[0].type&&e.outputs[0].type==s.inputs[0].type&&(i.connect(t.origin_slot,e,0),e.connect(0,s,t.target_slot),e.pos[0]-=.5*e.size[0])}));break;case"Delete":n.graph.removeLink(t.id)}}});return!1},d.onShowPropertyEditor=function(t,e,n,i,s){var o=t.property||"title",a=s[o],r=document.createElement("div");r.className="graphdialog",r.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",r.querySelector(".name").innerText=o;var l=r.querySelector(".value");l&&(l.value=a,l.addEventListener("blur",(function(t){this.focus()})),l.addEventListener("keydown",(function(t){13!=t.keyCode&&"textarea"!=t.target.localName||(g(),t.preventDefault(),t.stopPropagation())})));var h=d.active_canvas.canvas,u=h.getBoundingClientRect(),c=-20,p=-20;function g(){!function(e){"Number"==t.type?e=Number(e):"Boolean"==t.type&&(e=Boolean(e));s[o]=e,r.parentNode&&r.parentNode.removeChild(r);s.setDirtyCanvas(!0,!0)}(l.value)}u&&(c-=u.left,p-=u.top),event?(r.style.left="".concat(event.clientX+c,"px"),r.style.top="".concat(event.clientY+p,"px")):(r.style.left="".concat(.5*h.width+c,"px"),r.style.top="".concat(.5*h.height+p,"px")),r.querySelector("button").addEventListener("click",g),h.parentNode.appendChild(r)},d.prototype.prompt=function(t,e,n,i,s){var o=this;t=t||"";var a=!1,r=document.createElement("div");r.className="graphdialog rounded",r.innerHTML=s?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",r.close=function(){o.prompt_box=null,r.parentNode&&r.parentNode.removeChild(r)},this.ds.scale>1&&(r.style.transform="scale(".concat(this.ds.scale,")")),r.addEventListener("mouseleave",(function(t){a||r.close()})),o.prompt_box&&o.prompt_box.close(),o.prompt_box=r,r.querySelector(".name").innerText=t;var l=r.querySelector(".value");l.value=e;var h=l;h.addEventListener("keydown",(function(t){if(a=!0,27==t.keyCode)r.close();else{if(13!=t.keyCode||"textarea"==t.target.localName)return;n&&n(this.value),r.close()}t.preventDefault(),t.stopPropagation()})),r.querySelector("button").addEventListener("click",(function(t){n&&n(h.value),o.setDirty(!0),r.close()}));var u=d.active_canvas.canvas,c=u.getBoundingClientRect(),p=-20,g=-20;return c&&(p-=c.left,g-=c.top),i?(r.style.left="".concat(i.clientX+p,"px"),r.style.top="".concat(i.clientY+g,"px")):(r.style.left="".concat(.5*u.width+p,"px"),r.style.top="".concat(.5*u.height+g,"px")),u.parentNode.appendChild(r),setTimeout((function(){h.focus()}),10),r},d.search_limit=-1,d.prototype.showSearchBox=function(t){var e=this,n=d.active_canvas,i=n.canvas,s=i.ownerDocument||document,o=document.createElement("div");o.className="litegraph litesearchbox graphdialog rounded",o.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",o.close=function(){e.search_box=null,s.body.focus(),s.body.style.overflow="",setTimeout((function(){e.canvas.focus()}),20),o.parentNode&&o.parentNode.removeChild(o)};var a=null;this.ds.scale>1&&(o.style.transform="scale(".concat(this.ds.scale,")")),o.addEventListener("mouseenter",(function(t){a&&(clearTimeout(a),a=null)})),o.addEventListener("mouseleave",(function(t){a=setTimeout((function(){o.close()}),500)})),e.search_box&&e.search_box.close(),e.search_box=o;var r=o.querySelector(".helper"),l=null,h=null,c=null,p=o.querySelector("input");p&&(p.addEventListener("blur",(function(t){this.focus()})),p.addEventListener("keydown",(function(t){if(38==t.keyCode)y(!1);else if(40==t.keyCode)y(!0);else if(27==t.keyCode)o.close();else{if(13!=t.keyCode)return h&&clearInterval(h),void(h=setTimeout(m,10));c?f(c.innerHTML):l?f(l):o.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0}))),s.fullscreenElement?s.fullscreenElement.appendChild(o):(s.body.appendChild(o),s.body.style.overflow="hidden");var g=i.getBoundingClientRect(),v=(t?t.clientX:g.left+.5*g.width)-80,_=(t?t.clientY:g.top+.5*g.height)-20;function f(i){if(i)if(e.onSearchBoxSelection)e.onSearchBoxSelection(i,t,n);else{var s=u.searchbox_extras[i.toLowerCase()];s&&(i=s.type),n.graph.beforeChange();var a=u.createNode(i);if(a&&(a.pos=n.convertEventToCanvasOffset(t),n.graph.add(a)),s&&s.data){if(s.data.properties)for(var r in s.data.properties)a.addProperty(r,s.data.properties[r]);if(s.data.inputs)for(var r in a.inputs=[],s.data.inputs)a.addOutput(s.data.inputs[r][0],s.data.inputs[r][1]);if(s.data.outputs)for(var r in a.outputs=[],s.data.outputs)a.addOutput(s.data.outputs[r][0],s.data.outputs[r][1]);s.data.title&&(a.title=s.data.title),s.data.json&&a.configure(s.data.json),n.graph.afterChange()}}o.close()}function y(t){var e=c;c&&c.classList.remove("selected"),c?(c=t?c.nextSibling:c.previousSibling)||(c=e):c=t?r.childNodes[0]:r.childNodes[r.childNodes.length],c&&(c.classList.add("selected"),c.scrollIntoView({block:"end",behavior:"smooth"}))}function m(){h=null;var t=p.value;if(l=null,r.innerHTML="",t)if(e.onSearchBox){var i=e.onSearchBox(r,t,n);if(i)for(var s=0;s<i.length;++s)y(i[s])}else{var o=function(e){var n=u.registered_node_types[e];return(!c||n.filter==c)&&-1!==e.toLowerCase().indexOf(t)},a=0;t=t.toLowerCase();var c=n.filter||n.graph.filter;for(var s in u.searchbox_extras){var g=u.searchbox_extras[s];if(-1!==g.desc.toLowerCase().indexOf(t)){var v=u.registered_node_types[g.type];if((!v||v.filter==c)&&(y(g.desc,"searchbox_extra"),-1!==d.search_limit&&a++>d.search_limit))break}}var _=null;if(Array.prototype.filter)_=Object.keys(u.registered_node_types).filter(o);else for(var s in _=[],u.registered_node_types)o(s)&&_.push(s);for(s=0;s<_.length&&(y(_[s]),!(-1!==d.search_limit&&a++>d.search_limit));s++);}function y(t,e){var n=document.createElement("div");l||(l=t),n.innerText=t,n.dataset.type=escape(t),n.className="litegraph lite-search-item",e&&(n.className+=" ".concat(e)),n.addEventListener("click",(function(t){f(unescape(this.dataset.type))})),r.appendChild(n)}}return o.style.left="".concat(v,"px"),o.style.top="".concat(_,"px"),t.layerY>g.height-200&&(r.style.maxHeight="".concat(g.height-t.layerY-20,"px")),p.focus(),o},d.prototype.showEditPropertyValue=function(t,e,n){if(t&&void 0!==t.properties[e]){n=n||{};var i=t.getPropertyInfo(e),s=i.type,o="";if("string"==s||"number"==s||"array"==s||"object"==s)o="<input autofocus type='text' class='value'/>";else if("enum"!=s&&"combo"!=s||!i.values){if("boolean"!=s)return void console.warn("unknown type: ".concat(s));o='<input autofocus type="checkbox" class="value" '.concat(t.properties[e]?"checked":"","/>")}else{for(var a in o="<select autofocus type='text' class='value'>",i.values){var r=a;i.values.constructor===Array&&(r=i.values[a]),o+='<option value="'.concat(r,'" ').concat(r==t.properties[e]?"selected":"",">").concat(i.values[a],"</option>")}o+="</select>"}var l=this.createDialog('<span class="name">'.concat(i.label?i.label:e,"</span>").concat(o,"<button>OK</button>"),n);if("enum"!=s&&"combo"!=s||!i.values)if("boolean"==s){(h=l.querySelector("input"))&&h.addEventListener("click",(function(t){c(!!h.checked)}))}else{var h;if(h=l.querySelector("input")){h.addEventListener("blur",(function(t){this.focus()}));r=void 0!==t.properties[e]?t.properties[e]:"";"string"!==s&&(r=JSON.stringify(r)),h.value=r,h.addEventListener("keydown",(function(t){13==t.keyCode&&(u(),t.preventDefault(),t.stopPropagation())}))}}else(h=l.querySelector("select")).addEventListener("change",(function(t){c(t.target.value)}));return l.querySelector("button").addEventListener("click",u),l}function u(){c(h.value)}function c(o){i&&i.values&&i.values.constructor===Object&&null!=i.values[o]&&(o=i.values[o]),"number"==typeof t.properties[e]&&(o=Number(o)),"array"!=s&&"object"!=s||(o=JSON.parse(o)),t.properties[e]=o,t.graph&&t.graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,o),n.onclose&&n.onclose(),l.close(),t.setDirtyCanvas(!0,!0)}},d.prototype.createDialog=function(t,e){e=e||{};var n=document.createElement("div");n.className="graphdialog",n.innerHTML=t;var i=this.canvas.getBoundingClientRect(),s=-20,o=-20;return i&&(s-=i.left,o-=i.top),e.position?(s+=e.position[0],o+=e.position[1]):e.event?(s+=e.event.clientX,o+=e.event.clientY):(s+=.5*this.canvas.width,o+=.5*this.canvas.height),n.style.left="".concat(s,"px"),n.style.top="".concat(o,"px"),this.canvas.parentNode.appendChild(n),n.close=function(){this.parentNode&&this.parentNode.removeChild(this)},n},d.prototype.createPanel=function(t,e){var n=(e=e||{}).window||window,i=document.createElement("div");if(i.className="litegraph dialog",i.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div class='dialog-footer'></div>",i.header=i.querySelector(".dialog-header"),e.width&&(i.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(i.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable){var s=document.createElement("span");s.innerHTML="&#10005;",s.classList.add("close"),s.addEventListener("click",(function(){i.close()})),i.header.appendChild(s)}return i.title_element=i.querySelector(".dialog-title"),i.title_element.innerText=t,i.content=i.querySelector(".dialog-content"),i.footer=i.querySelector(".dialog-footer"),i.close=function(){this.parentNode.removeChild(this)},i.clear=function(){this.content.innerHTML=""},i.addHTML=function(t,e,n){var s=document.createElement("div");return e&&(s.className=e),s.innerHTML=t,n?i.footer.appendChild(s):i.content.appendChild(s),s},i.addButton=function(t,e,n){var s=document.createElement("button");return s.innerText=t,s.options=n,s.classList.add("btn"),s.addEventListener("click",e),i.footer.appendChild(s),s},i.addSeparator=function(){var t=document.createElement("div");t.className="separator",i.content.appendChild(t)},i.addWidget=function(t,e,s,o,a){o=o||{};var r=String(s);"number"==(t=t.toLowerCase())&&(r=s.toFixed(3));var l=document.createElement("div");l.className="property",l.innerHTML="<span class='property_name'></span><span class='property_value'></span>",l.querySelector(".property_name").innerText=e;var h=l.querySelector(".property_value");if(h.innerText=r,l.dataset.property=e,l.dataset.type=o.type||t,l.options=o,l.value=s,"boolean"==t)l.classList.add("boolean"),s&&l.classList.add("bool-on"),l.addEventListener("click",(function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",c(t,this.value)}));else if("string"==t||"number"==t)h.setAttribute("contenteditable",!0),h.addEventListener("keydown",(function(t){"Enter"==t.code&&(t.preventDefault(),this.blur())})),h.addEventListener("blur",(function(){var t=this.innerText,e=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(t=Number(t)),c(e,t)}));else if("enum"==t||"combo"==t)r=d.getPropertyPrintableValue(s,o.values);function c(t,e){console.log("change",t,e),o.callback&&o.callback(t,e),a&&a(t,e)}return h.innerText=r,h.addEventListener("click",(function(t){var e=o.values||[],i=this.parentNode.dataset.property,s=this;new u.ContextMenu(e,{event:t,className:"dark",callback:function(t,e,n){return s.innerText=t,c(i,t),!1}},n)})),i.content.appendChild(l),l},i},d.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var n="";for(var i in e)if(e[i]==t){n=i;break}return"".concat(String(t)," (").concat(n,")")}},d.prototype.showShowNodePanel=function(t){window.SELECTED_NODE=t;var e=document.querySelector("#node-panel");e&&e.close();var n=this.getCanvasWindow();(e=this.createPanel(t.title||"",{closable:!0,window:n})).id="node-panel",e.node=t,e.classList.add("settings");var i=this;!function(){for(var n in e.content.innerHTML="",e.addHTML('<span class="node_type">'.concat(t.type,'</span><span class="node_desc">').concat(t.constructor.desc||"",'</span><span class="separator"></span>')),e.addHTML("<h3>Properties</h3>"),t.properties){var s=t.properties[n],o=t.getPropertyInfo(n);o.type,t.onAddPropertyToPanel&&t.onAddPropertyToPanel(n,e)||e.addWidget(o.widget||o.type,n,s,o,(function(e,n){i.graph.beforeChange(t),t.setProperty(e,n),i.graph.afterChange(),i.dirty_canvas=!0}))}e.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(e),e.addButton("Delete",(function(){t.block_delete||(t.graph.remove(t),e.close())})).classList.add("delete")}(),this.canvas.parentNode.appendChild(e)},d.prototype.showSubgraphPropertiesDialog=function(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function i(){if(n.clear(),t.inputs)for(var e=0;e<t.inputs.length;++e){var s=t.inputs[e];if(!s.not_subgraph_input){var o=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");o.dataset.name=s.name,o.dataset.slot=e,o.querySelector(".name").innerText=s.name,o.querySelector(".type").innerText=s.type,o.querySelector("button").addEventListener("click",(function(e){t.removeInput(Number(this.parentNode.dataset.slot)),i()}))}}}n.node=t,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(e){var n=this.parentNode,s=n.querySelector(".name").value,o=n.querySelector(".type").value;s&&-1==t.findInputSlot(s)&&(t.addInput(s,o),n.querySelector(".name").value="",n.querySelector(".type").value="",i())})),i(),this.canvas.parentNode.appendChild(n),n},d.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var n=t[e];n.node&&(n.node.graph&&n.graph==this.graph||n.close())}},d.onMenuNodeCollapse=function(t,e,n,i,s){s.graph.beforeChange(s),s.collapse(),s.graph.afterChange(s)},d.onMenuNodePin=function(t,e,n,i,s){s.pin()},d.onMenuNodeMode=function(t,e,n,i,s){return new u.ContextMenu(["Always","On Event","On Trigger","Never"],{event:n,callback:function(t){if(!s)return;switch(t){case"On Event":s.mode=u.ON_EVENT;break;case"On Trigger":s.mode=u.ON_TRIGGER;break;case"Never":s.mode=u.NEVER;break;case"Always":default:s.mode=u.ALWAYS}},parentMenu:i,node:s}),!1},d.onMenuNodeColors=function(t,e,n,i,s){if(!s)throw"no node for color";var o=[];for(var a in o.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),d.node_colors){var r=d.node_colors[a];t={value:a,content:'<span style="display: block; color: #999; padding-left: 4px; border-left: 8px solid '.concat(r.color,"; background-color:").concat(r.bgcolor,'">').concat(a,"</span>")};o.push(t)}return new u.ContextMenu(o,{event:n,callback:function(t){if(!s)return;var e=t.value?d.node_colors[t.value]:null;e?s.constructor===u.LGraphGroup?s.color=e.groupcolor:(s.color=e.color,s.bgcolor=e.bgcolor):(delete s.color,delete s.bgcolor);s.setDirtyCanvas(!0,!0)},parentMenu:i,node:s}),!1},d.onMenuNodeShapes=function(t,e,n,i,s){if(!s)throw"no node passed";return new u.ContextMenu(u.VALID_SHAPES,{event:n,callback:function(t){if(!s)return;s.graph.beforeChange(s),s.shape=t,s.graph.afterChange(s),s.setDirtyCanvas(!0)},parentMenu:i,node:s}),!1},d.onMenuNodeRemove=function(t,e,n,i,s){if(!s)throw"no node passed";if(!1!==s.removable){var o=s.graph;o.beforeChange(),o.remove(s),o.afterChange(),s.setDirtyCanvas(!0,!0)}},d.onMenuNodeToSubgraph=function(t,e,n,i,s){var o=s.graph,a=d.active_canvas;if(a){var r=Object.values(a.selected_nodes||{});r.length||(r=[s]);var l=u.createNode("graph/subgraph");l.pos=s.pos.concat(),o.add(l),l.buildFromNodes(r),a.deselectAllNodes(),s.setDirtyCanvas(!0,!0)}},d.onMenuNodeClone=function(t,e,n,i,s){if(0!=s.clonable){var o=s.clone();o&&(o.pos=[s.pos[0]+5,s.pos[1]+5],s.graph.beforeChange(),s.graph.add(o),s.graph.afterChange(),s.setDirtyCanvas(!0,!0))}},d.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},d.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:d.onMenuAdd},{content:"Add Group",callback:d.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t},d.prototype.getNodeMenuOptions=function(t){var e=null;if(e=t.getMenuOptions?t.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:d.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:d.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:d.onShowMenuNodeProperties},null,{content:"Title",callback:d.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:d.onMenuNodeMode},{content:"Resize",callback:function(){if(t.resizable)return d.onResizeNode}},{content:"Collapse",callback:d.onMenuNodeCollapse},{content:"Pin",callback:d.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:d.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:d.onMenuNodeShapes},null],t.onGetInputs){var n=t.onGetInputs();n&&n.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var i=t.onGetOutputs();i&&i.length&&(e[1].disabled=!1)}if(t.getExtraMenuOptions){var s=t.getExtraMenuOptions(this,e);s&&(s.push(null),e=s.concat(e))}return!1!==t.clonable&&e.push({content:"Clone",callback:d.onMenuNodeClone}),e.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:d.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(e,t),e},d.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:d.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:d.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:d.onShowPropertyEditor},null,{content:"Remove",callback:d.onMenuNodeRemove}]},d.prototype.processContextMenu=function(t,e){var n=this,i=d.active_canvas.getCanvasWindow(),s=null,o={event:e,callback:function(e,i,s){if(!e)return;if("Remove Slot"==e.content){(o=e.slot).input?t.removeInput(o.slot):o.output&&t.removeOutput(o.slot)}else if("Disconnect Links"==e.content){(o=e.slot).output?t.disconnectOutput(o.slot):o.input&&t.disconnectInput(o.slot)}else if("Rename Slot"==e.content){var o,a=(o=e.slot).input?t.getInputInfo(o.slot):t.getOutputInfo(o.slot),r=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",i),l=r.querySelector("input");l&&a&&(l.value=a.label||""),r.querySelector("button").addEventListener("click",(function(t){l.value&&(a&&(a.label=l.value),n.setDirty(!0)),r.close()}))}},extra:t};t&&(o.title=t.type);var a=null;if(t&&(a=t.getSlotInPosition(e.canvasX,e.canvasY),d.active_node=t),a){if(s=[],t.getSlotMenuOptions)s=t.getSlotMenuOptions(a);else{a&&a.output&&a.output.links&&a.output.links.length&&s.push({content:"Disconnect Links",slot:a});var r=a.input||a.output;s.push(r.locked?"Cannot remove":{content:"Remove Slot",slot:a}),s.push(r.nameLocked?"Cannot rename":{content:"Rename Slot",slot:a})}o.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==u.ACTION&&(o.title="Action"),a.output&&a.output.type==u.EVENT&&(o.title="Event")}else if(t)s=this.getNodeMenuOptions(t);else{s=this.getCanvasMenuOptions();var l=this.graph.getGroupOnPos(e.canvasX,e.canvasY);l&&s.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:l,options:this.getGroupMenuOptions(l)}})}s&&new u.ContextMenu(s,o,i)},"undefined"!=typeof window&&window.CanvasRenderingContext2D&&(window.CanvasRenderingContext2D.prototype.roundRect=function(t,e,n,i,s,o){void 0===s&&(s=5),void 0===o&&(o=s),this.moveTo(t+s,e),this.lineTo(t+n-s,e),this.quadraticCurveTo(t+n,e,t+n,e+s),this.lineTo(t+n,e+i-o),this.quadraticCurveTo(t+n,e+i,t+n-o,e+i),this.lineTo(t+o,e+i),this.quadraticCurveTo(t,e+i,t,e+i-o),this.lineTo(t,e+s),this.quadraticCurveTo(t,e,t+s,e)}),u.compareObjects=function(t,e){for(var n in t)if(t[n]!=e[n])return!1;return!0},u.distance=b,u.colorToString=function(t){return"rgba(".concat(Math.round(255*t[0]).toFixed(),",").concat(Math.round(255*t[1]).toFixed(),",").concat(Math.round(255*t[2]).toFixed(),",").concat(4==t.length?t[3].toFixed(2):"1.0",")")},u.isInsideRectangle=k,u.growBounding=function(t,e,n){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),n<t[1]?t[1]=n:n>t[3]&&(t[3]=n)},u.isInsideBounding=function(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])},u.overlapBounding=T,u.hex2num=function(t){"#"==t.charAt(0)&&(t=t.slice(1)),t=t.toUpperCase();for(var e,n,i="0123456789ABCDEF",s=new Array(3),o=0,a=0;a<6;a+=2)e=i.indexOf(t.charAt(a)),n=i.indexOf(t.charAt(a+1)),s[o]=16*e+n,o++;return s},u.num2hex=function(t){for(var e,n,i="0123456789ABCDEF",s="#",o=0;o<3;o++)e=t[o]/16,n=t[o]%16,s+=i.charAt(e)+i.charAt(n);return s},E.prototype.addItem=function(t,e,n){var i=this;n=n||{};var s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;function a(t){var e=this.value,s=!0;(i.current_submenu&&i.current_submenu.close(t),n.callback)&&(!0===n.callback.call(this,e,n,t,i,n.node)&&(s=!1));if(e){if(e.callback&&!n.ignore_item_callbacks&&!0!==e.disabled)!0===e.callback.call(this,e,n,t,i,n.extra)&&(s=!1);if(e.submenu){if(!e.submenu.options)throw"ContextMenu submenu needs options";new i.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:i,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:n.autoopen}),s=!1}}s&&!i.lock&&i.close()}return null===e?s.classList.add("separator"):(s.innerHTML=e&&e.title?e.title:t,s.value=e,e&&(e.disabled&&(o=!0,s.classList.add("disabled")),(e.submenu||e.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof e?(s.dataset.value=t,s.onclick_callback=e):s.dataset.value=e,e.className&&(s.className+=" ".concat(e.className))),this.root.appendChild(s),o||s.addEventListener("click",a),n.autoopen&&s.addEventListener("mouseenter",(function(t){var e=this.value;if(!e||!e.has_submenu)return;a.call(this,t)})),s},E.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!E.isCursorOverElement(t,this.parentMenu.root)&&E.trigger(this.parentMenu.root,"mouseleave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},E.trigger=function(t,e,n,i){var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,!0,!0,n),s.srcElement=i,t.dispatchEvent?t.dispatchEvent(s):t.__events&&t.__events.dispatchEvent(s),s},E.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},E.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},E.isCursorOverElement=function(t,e){var n=t.clientX,i=t.clientY,s=e.getBoundingClientRect();return!!s&&(i>s.top&&i<s.top+s.height&&n>s.left&&n<s.left+s.width)},u.ContextMenu=E,u.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var n=[],i=0;i<e.length;i++)n.push(e[i]);for(i=0;i<n.length;i++)n[i].close?n[i].close():n[i].parentNode&&n[i].parentNode.removeChild(n[i])}},u.extendClass=function(t,e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);if(e.prototype)for(var n in e.prototype)e.prototype.hasOwnProperty(n)&&(t.prototype.hasOwnProperty(n)||(e.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,e.prototype.__lookupGetter__(n)):t.prototype[n]=e.prototype[n],e.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,e.prototype.__lookupSetter__(n))))},C.sampleCurve=function(t,e){if(e){for(var n=0;n<e.length-1;++n){var i=e[n],s=e[n+1];if(!(s[0]<t)){var o=s[0]-i[0];if(Math.abs(o)<1e-5)return i[1];var a=(t-i[0])/o;return i[1]*(1-a)+s[1]*a}}return 0}},C.prototype.draw=function(t,e,n,i,s,o){var a=this.points;if(a){this.size=e;var r=e[0]-2*this.margin,l=e[1]-2*this.margin;s=s||"#666",t.save(),t.translate(this.margin,this.margin),i&&(t.fillStyle="#111",t.fillRect(0,0,r,l),t.fillStyle="#222",t.fillRect(.5*r,0,1,l),t.strokeStyle="#333",t.strokeRect(0,0,r,l)),t.strokeStyle=s,o&&(t.globalAlpha=.5),t.beginPath();for(var h=0;h<a.length;++h){var u=a[h];t.lineTo(u[0]*r,(1-u[1])*l)}if(t.stroke(),t.globalAlpha=1,!o)for(h=0;h<a.length;++h){u=a[h];t.fillStyle=this.selected==h?"#FFF":this.nearest==h?"#DDD":"#AAA",t.beginPath(),t.arc(u[0]*r,(1-u[1])*l,2,0,2*Math.PI),t.fill()}t.restore()}},C.prototype.onMouseDown=function(t,e){var n=this.points;if(n&&!(t[1]<0)){var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=t[0]-this.margin,a=t[1]-this.margin,r=[o,a],l=30/e.ds.scale;if(this.selected=this.getCloserPoint(r,l),-1==this.selected){var h=[o/i,1-a/s];n.push(h),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(h),this.must_update=!0}return-1!=this.selected||void 0}},C.prototype.onMouseMove=function(t,e){var n=this.points;if(n){var i=this.selected;if(!(i<0)){var s=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),a=[t[0]-this.margin,t[1]-this.margin],r=30/e.ds.scale;this._nearest=this.getCloserPoint(a,r);var l=n[i];if(l){var h=0==i||i==n.length-1;if(!h&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10))return n.splice(i,1),void(this.selected=-1);l[0]=h?0==i?0:1:Math.clamp(s,0,1),l[1]=1-Math.clamp(o,0,1),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(l),this.must_update=!0}}}},C.prototype.onMouseUp=function(t,e){return this.selected=-1,!1},C.prototype.getCloserPoint=function(t,e){var n=this.points;if(!n)return-1;e=e||30;for(var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=n.length,a=[0,0],r=1e6,l=-1,h=0;h<o;++h){var u=n[h];a[0]=u[0]*i,a[1]=(1-u[1])*s,a[0],t[0];var c=vec2.distance(t,a);c>r||c>e||(l=h,r=c)}return l},u.CurveEditor=C,u.getParameterNames=function(t){return"".concat(t).replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},Math.clamp=function(t,e,n){return e>t?e:n<t?n:t},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)});var w=function(){function t(e){n(this,t),o(this,"STATUS_STOPPED",1),o(this,"STATUS_RUNNING",2),o(this,"supportedTypes",["number","string","boolean"]),u.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}return s(t,[{key:"getSupportedTypes",value:function(){return this.supportedTypes||t.supportedTypes}},{key:"clear",value:function(){if(this.stop(),this.status=t.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes){var e,n=h(this._nodes);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.onRemoved&&i.onRemoved()}}catch(t){n.e(t)}finally{n.f()}}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}},{key:"attachCanvas",value:function(t){if(t.constructor!==LGraphCanvas)throw new Error("attachCanvas expects a LGraphCanvas instance");t.graph&&t.graph!==this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}},{key:"detachCanvas",value:function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!==e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}}},{key:"start",value:function(e){if(this.status!==t.STATUS_RUNNING){this.status=t.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=u.getTime(),this.last_update_time=this.starttime;var n=this;if(0===(e=e||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function t(){-1===n.execution_timer_id&&(window.requestAnimationFrame(t),n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep())}()}else this.execution_timer_id=setInterval((function(){n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep()}),e)}}},{key:"stop",value:function(){this.status!==t.STATUS_STOPPED&&(this.status=t.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!==this.execution_timer_id&&(-1!==this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}},{key:"runStep",value:function(t,e,n){t=t||1;var i=u.getTime();this.globaltime=.001*(i-this.starttime);var s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(n=n||s.length,e){for(var o=0;o<t;o++){for(var a=0;a<n;a++){var r=s[a];r.mode===u.ALWAYS&&r.onExecute&&r.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var l=0;l<t;l++){for(var h=0;h<n;++h){var c=s[h];c.mode===u.ALWAYS&&c.onExecute&&c.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,u.throw_errors)throw t;u.debug&&console.log("Error during execution: ".concat(t)),this.stop()}var d=u.getTime(),p=d-i;0===p&&(p=1),this.execution_time=.001*p,this.globaltime+=.001*p,this.iteration+=1,this.elapsed_time=.001*(d-this.last_update_time),this.last_update_time=d}}},{key:"updateExecutionOrder",value:function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];var t,e=h(this._nodes_in_order);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.onExecute&&this._nodes_executable.push(n)}}catch(t){e.e(t)}finally{e.f()}}},{key:"computeExecutionOrder",value:function(t,e){var n,i=[],s=[],o={},a={},r={},l=h(this._nodes);try{for(l.s();!(n=l.n()).done;){var c=n.value;if(!t||c.onExecute){o[c.id]=c;var d=0;if(c.inputs)for(var p=0,g=c.inputs.length;p<g;p++)c.inputs[p]&&null!=c.inputs[p].link&&(d+=1);0===d?(s.push(c),e&&(c._level=1)):(e&&(c._level=0),r[c.id]=d)}}}catch(t){l.e(t)}finally{l.f()}for(;0!==s.length;){var v=s.shift();if(i.push(v),delete o[v.id],v.outputs){var _,f=h(v.outputs);try{for(f.s();!(_=f.n()).done;){var y=_.value;if(null!=y&&null!=y.links&&0!==y.links.length){var m,b=h(y.links);try{for(b.s();!(m=b.n()).done;){var k=m.value,T=this.links[k];if(T&&!a[T.id]){var E=this.getNodeById(T.target_id);null!=E?(e&&(!E._level||E._level<=v._level)&&(E._level=v._level+1),a[T.id]=!0,r[E.id]-=1,0===r[E.id]&&s.push(E)):a[T.id]=!0}}}catch(t){b.e(t)}finally{b.f()}}}}catch(t){f.e(t)}finally{f.f()}}}for(var C in o)i.push(o[C]);i.length!==this._nodes.length&&u.debug&&console.warn("something went wrong, nodes missing");for(var w=i.length,N=0;N<w;N++)i[N].order=N;i=i.sort((function(t,e){var n=t.constructor.priority||t.priority||0,i=e.constructor.priority||e.priority||0;return n===i?t.order-e.order:n-i}));for(var O=0;O<w;++O)i[O].order=O;return i}},{key:"getAncestors",value:function(t){for(var e=[],n=[t],i={};n.length;){var s=n.shift();if(s.inputs){i[s.id]||s===t||(i[s.id]=!0,e.push(s));for(var o=0;o<s.inputs.length;++o){var a=s.getInputNode(o);a&&-1===e.indexOf(a)&&n.push(a)}}}return e.sort((function(t,e){return t.order-e.order})),e}},{key:"arrange",value:function(t){t=t||100;var e,n=[],i=h(this.computeExecutionOrder(!1,!0));try{for(i.s();!(e=i.n()).done;){var s=e.value,o=s._level||1;n[o]||(n[o]=[]),n[o].push(s)}}catch(t){i.e(t)}finally{i.f()}for(var a=t,r=0,l=n;r<l.length;r++){var c=l[r];if(c){var d,p=100,g=t+u.NODE_TITLE_HEIGHT,v=h(c);try{for(v.s();!(d=v.n()).done;){var _=d.value;_.pos[0]=a,_.pos[1]=g,_.size[0]>p&&(p=_.size[0]),g+=_.size[1]+t+u.NODE_TITLE_HEIGHT}}catch(t){v.e(t)}finally{v.f()}a+=p+t}}this.setDirtyCanvas(!0,!0)}},{key:"getTime",value:function(){return this.globaltime}},{key:"getFixedTime",value:function(){return this.fixedtime}},{key:"getElapsedTime",value:function(){return this.elapsed_time}},{key:"sendEventToAllNodes",value:function(t,e,n){n=n||u.ALWAYS;var i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(var s=0,o=i.length;s<o;++s){var r=i[s];r.constructor!==u.Subgraph||"onExecute"===t?r[t]&&r.mode===n&&(void 0===e?r[t]():e&&e.constructor===Array?r[t].apply(r,a(e)):r[t](e)):r.mode===n&&r.sendEventToAllNodes(t,e,n)}}},{key:"sendActionToCanvas",value:function(t,e){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var i=this.list_of_graphcanvas[n];i[t]&&i[t].apply(i,a(e))}}},{key:"add",value:function(t,e){if(t){if(t.constructor===LGraphGroup)return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,void this._version++;if(-1!==t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=u.MAX_NUMBER_OF_NODES)throw new Error("LiteGraph: max number of nodes in a graph reached");return null==t.id||-1===t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}}},{key:"remove",value:function(t){if(t.constructor===u.LGraphGroup){var e=this._groups.indexOf(t);return-1!==e&&this._groups.splice(e,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var n=0;n<t.inputs.length;n++){null!=t.inputs[n].link&&t.disconnectInput(n)}if(t.outputs)for(var i=0;i<t.outputs.length;i++){var s=t.inputs[i];null!=s.links&&s.links.length&&t.disconnectOutput(i)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas){var o,a=h(this.list_of_graphcanvas);try{for(a.s();!(o=a.n()).done;){var r=o.value;r.selected_nodes[t.id]&&delete r.selected_nodes[t.id],r.node_dragged===t&&(r.node_dragged=null)}}catch(t){a.e(t)}finally{a.f()}}var l=this._nodes.indexOf(t);-1!==l&&this._nodes.splice(l,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}}},{key:"getNodeById",value:function(t){return null==t?null:this._nodes_by_id[t]}},{key:"findNodesByClass",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.length=0;var n,i=h(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.constructor===t&&e.push(s)}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"findNodesByType",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t=t.toLowerCase(),(e=e||[]).length=0;var n,i=h(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.type.toLowerCase()===t&&e.push(s)}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"findNodeByTitle",value:function(t){var e,n=h(this._nodes);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(i.title===t)return i}}catch(t){n.e(t)}finally{n.f()}return null}},{key:"findNodesByTitle",value:function(t){var e,n=[],i=h(this._nodes);try{for(i.s();!(e=i.n()).done;){var s=e.value;s.title===t&&n.push(s)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"getNodeOnPos",value:function(t,e){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodes,s=arguments.length>3?arguments[3]:void 0,o=h(i);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(a.isPointInside(t,e,s))return a}}catch(t){o.e(t)}finally{o.f()}return null}},{key:"getGroupOnPos",value:function(t,e){var n,i=h(this._groups);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.isPointInside(t,e,2,!0))return s}}catch(t){i.e(t)}finally{i.f()}return null}},{key:"checkNodeTypes",value:function(){var t,e=h(this._nodes);try{for(e.s();!(t=e.n()).done;){var n=t.value,i=u.registered_node_types[n.type];if(n.constructor!==i){console.log("node being replaced by newer version: ".concat(n.type));var s=u.createNode(n.type);n=s,s.configure(n.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,n.inputs&&(s.inputs=n.inputs.concat()),n.outputs&&(s.outputs=n.outputs.concat())}}}catch(t){e.e(t)}finally{e.f()}this.updateExecutionOrder()}},{key:"onAction",value:function(t,e){this._input_nodes=this.findNodesByClass(u.GraphInput,this._input_nodes);var n,i=h(this._input_nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.properties.name===t){s.onAction(t,e);break}}}catch(t){i.e(t)}finally{i.f()}}},{key:"trigger",value:function(t,e){this.onTrigger&&this.onTrigger(t,e)}},{key:"addInput",value:function(t,e,n){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())}},{key:"setInputData",value:function(t,e){var n=this.inputs[t];n&&(n.value=e)}},{key:"getInputData",value:function(t){var e=this.inputs[t];return e?e.value:null}},{key:"renameInput",value:function(t,e){if(e!==t){if(!this.inputs[t])return!1;if(this.inputs[e])return console.error("there is already one input with that newName"),!1;this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}}},{key:"changeInputType",value:function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()===String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))}},{key:"removeInput",value:function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"addOutput",value:function(t,e,n){this.outputs[t]={name:t,type:e,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},{key:"setOutputData",value:function(t,e){var n=this.outputs[t];n&&(n.value=e)}},{key:"getOutputData",value:function(t){var e=this.outputs[t];return e?e.value:null}},{key:"renameOutput",value:function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that newName"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))}},{key:"changeOutputType",value:function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()===String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))}},{key:"removeOutput",value:function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"triggerInput",value:function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].onTrigger(e)}},{key:"setCallback",value:function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].setTrigger(e)}},{key:"beforeChange",value:function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)}},{key:"afterChange",value:function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)}},{key:"connectionChange",value:function(t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")}},{key:"isLive",value:function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){if(this.list_of_graphcanvas[t].live_mode)return!0}return!1}},{key:"clearTriggeredSlots",value:function(){for(var t in this.links){var e=this.links[t];e&&(e._last_time&&(e._last_time=0))}}},{key:"change",value:function(){u.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)}},{key:"setDirtyCanvas",value:function(t,e){this.sendActionToCanvas("setDirty",[t,e])}},{key:"removeLink",value:function(t){var e=this.links[t];if(e){var n=this.getNodeById(e.target_id);n&&n.disconnectInput(e.target_slot)}}},{key:"serialize",value:function(){var t,e=[],n=h(this._nodes);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.push(i.serialize())}}catch(t){n.e(t)}finally{n.f()}var s=[];for(var o in this.links){var a=this.links[o];if(!a.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var r=new LLink;for(var l in a)r[l]=a[l];this.links[o]=r,a=r}s.push(a.serialize())}var c,d=[],p=h(this._groups);try{for(p.s();!(c=p.n()).done;){var g=c.value;d.push(g.serialize())}}catch(t){p.e(t)}finally{p.f()}var v={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:s,groups:d,config:this.config,extra:this.extra,version:u.VERSION};return this.onSerialize&&this.onSerialize(v),v}},{key:"configure",value:function(t,e){if(t){e||this.clear();var n=t.nodes;if(t.links&&t.links.constructor===Array){var i,s=[],o=h(t.links);try{for(o.s();!(i=o.n()).done;){var a=i.value;if(a){var r=new LLink;r.configure(a),s[r.id]=r}else console.warn("serialized graph link data contains errors, skipping.")}}catch(t){o.e(t)}finally{o.f()}t.links=s}for(var l in t)"nodes"!==l&&"groups"!==l&&(this[l]=t[l]);var c=!1;if(this._nodes=[],n){var d,p=h(n);try{for(p.s();!(d=p.n()).done;){var g=d.value,v=u.createNode(g.type,g.title);v||(u.debug&&console.log("Node not found or has errors: ".concat(g.type)),(v=new LGraphNode).last_serialization=g,v.has_errors=!0,c=!0),v.id=g.id,this.add(v,!0)}}catch(t){p.e(t)}finally{p.f()}var _,f=h(n);try{for(f.s();!(_=f.n()).done;){var y=_.value,m=this.getNodeById(y.id);m&&m.configure(y)}}catch(t){f.e(t)}finally{f.f()}}if(this._groups.length=0,t.groups){var b,k=h(t.groups);try{for(k.s();!(b=k.n()).done;){var T=b.value,E=new u.LGraphGroup;E.configure(T),this.add(E)}}catch(t){k.e(t)}finally{k.f()}}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),c}}},{key:"load",value:function(t,e){var n=this;if(t.constructor===File||t.constructor===Blob){var i=new FileReader;return i.addEventListener("load",(function(t){var i=JSON.parse(t.target.result);n.configure(i),e&&e()})),void i.readAsText(t)}var s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.onload((function(){if(200===s.status){var t=JSON.parse(s.response);n.configure(t),e&&e()}else console.error("Error loading graph:",s.status,s.response)})),s.onerror((function(t){console.error("Error loading graph:",t)}))}},{key:"onNodeTrace",value:function(t,e,n){}}]),t}();o(w,"supportedTypes",["number","string","boolean"]);var N=function(){function t(e,i,s,o,a,r){n(this,t),this.id=e,this.type=i,this.origin_id=s,this.origin_slot=o,this.target_id=a,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}return s(t,[{key:"configure",value:function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)}},{key:"serialize",value:function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}]),t}(),O=function(){function t(e){n(this,t),o(this,"_pos",new Float32Array(10,10)),this._ctor(e),this.title=e||"Unnamed",this.size=[u.NODE_WIDTH,60],this.graph=null,this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}return s(t,[{key:"pos",get:function(){return this._pos},set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}},{key:"configure",value:function(t){for(var n in this.graph&&this.graph._version++,t)if("properties"!==n)null!=t[n]&&("object"===e(t[n])?this[n]&&this[n].configure?this[n].configure(t[n]):this[n]=u.cloneObject(t[n],this[n]):this[n]=t[n]);else for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);if(t.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],a=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange(u.INPUT,s,!0,a,o)}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var l=this.outputs[r];if(l.links)for(var c=0;c<l.links.length;++c){var d=this.graph?this.graph.links[l.links[c]]:null;this.onConnectionsChange(u.OUTPUT,r,!0,d,l)}}}if(this.widgets){var p,g=h(this.widgets);try{for(g.s();!(p=g.n()).done;){var v=p.value;v&&(v.options&&v.options.property&&this.properties[v.options.property]&&(v.value=JSON.parse(JSON.stringify(this.properties[v.options.property]))))}}catch(t){g.e(t)}finally{g.f()}if(t.widgets_values)for(var _=0;_<t.widgets_values.length;++_)this.widgets[_]&&(this.widgets[_].value=t.widgets_values[_])}this.onConfigure&&this.onConfigure(t)}},{key:"serialize",value:function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:u.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===t&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var n=0;n<this.outputs.length;n++)delete this.outputs[n]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=u.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(var i=0;i<this.widgets.length;++i)this.widgets[i]?e.widgets_values[i]=this.widgets[i].value:e.widgets_values[i]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e}},{key:"clone",value:function(){var t=u.createNode(this.type);if(!t)return null;var e=u.cloneObject(this.serialize());if(e.inputs)for(var n=0;n<e.inputs.length;++n)e.inputs[n].link=null;if(e.outputs)for(var i=0;i<e.outputs.length;++i)e.outputs[i].links&&(e.outputs[i].links.length=0);return delete e.id,t.configure(e),t}},{key:"toString",value:function(){return JSON.stringify(this.serialize())}},{key:"getTitle",value:function(){return this.title||this.constructor.title}},{key:"setProperty",value:function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var n=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,n)&&(this.properties[t]=n),this.widgets)for(var i=0;i<this.widgets.length;++i){var s=this.widgets[i];if(s&&s.options.property==t){s.value=e;break}}}}},{key:"setOutputData",value:function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n._data=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i],o=this.graph.links[s];o&&(o.data=e)}}}},{key:"setOutputDataType",value:function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n.type=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i];this.graph.links[s].type=e}}}},{key:"getInputData",value:function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)){var n=this.inputs[t].link,i=this.graph.links[n];if(!i)return null;if(!e)return i.data;var s=this.graph.getNodeById(i.origin_id);return s?(s.updateOutputData?s.updateOutputData(i.origin_slot):s.onExecute&&s.onExecute(),i.data):i.data}}},{key:"getInputDataType",value:function(t){if(!this.inputs)return null;if(t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,n=this.graph.links[e];if(!n)return null;var i=this.graph.getNodeById(n.origin_id);if(!i)return n.type;var s=i.outputs[n.origin_slot];return s?s.type:null}},{key:"getInputDataByName",value:function(t,e){var n=this.findInputSlot(t);return-1==n?null:this.getInputData(n,e)}},{key:"isInputConnected",value:function(t){return!!this.inputs&&(t<this.inputs.length&&null!=this.inputs[t].link)}},{key:"getInputInfo",value:function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}},{key:"getInputLink",value:function(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null}},{key:"getInputNode",value:function(t){if(!this.inputs)return null;if(t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var n=this.graph.links[e.link];return n?this.graph.getNodeById(n.origin_id):null}},{key:"getInputOrProperty",value:function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,n=this.inputs.length;e<n;++e){var i=this.inputs[e];if(t==i.name&&null!=i.link){var s=this.graph.links[i.link];if(s)return s.data}}return this.properties[t]}},{key:"getOutputData",value:function(t){return this.outputs?t>=this.outputs.length?null:this.outputs[t]._data:null}},{key:"getOutputInfo",value:function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}},{key:"isOutputConnected",value:function(t){return!!this.outputs&&(t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length)}},{key:"isAnyOutputConnected",value:function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1}},{key:"getOutputNodes",value:function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var n=[],i=0;i<e.links.length;i++){var s=e.links[i],o=this.graph.links[s];if(o){var a=this.graph.getNodeById(o.target_id);a&&n.push(a)}}return n}},{key:"trigger",value:function(t,e){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=u.getTime());for(var n=0;n<this.outputs.length;++n){var i=this.outputs[n];!i||i.type!==u.EVENT||t&&i.name!=t||this.triggerSlot(n,e)}}}},{key:"triggerSlot",value:function(t,e,n){if(this.outputs){var i=this.outputs[t];if(i){var s=i.links;if(s&&s.length){this.graph&&(this.graph._last_trigger_time=u.getTime());for(var o=0;o<s.length;++o){var a=s[o];if(null==n||n==a){var r=this.graph.links[s[o]];if(r){r._last_time=u.getTime();var l=this.graph.getNodeById(r.target_id);if(l){var h=l.inputs[r.target_slot];l.mode===u.ON_TRIGGER?l.onExecute&&l.onExecute(e):l.onAction&&l.onAction(h.name,e)}}}}}}}}},{key:"clearTriggeredSlot",value:function(t,e){if(this.outputs){var n=this.outputs[t];if(n){var i=n.links;if(i&&i.length)for(var s=0;s<i.length;++s){var o=i[s];if(null==e||e==o){var a=this.graph.links[i[s]];a&&(a._last_time=0)}}}}}},{key:"setSize",value:function(t){this.size=t,this.onResize&&this.onResize(this.size)}},{key:"addProperty",value:function(t,e,n,i){var s={name:t,type:n,default_value:e};if(i)for(var o in i)s[o]=i[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s}},{key:"addOutput",value:function(t,e,n){var i={name:t,type:e,links:null};if(n)for(var s in n)i[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i}},{key:"addOutputs",value:function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeOutput",value:function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var n=this.outputs[e].links,i=0;i<n.length;++i){var s=this.graph.links[n[i]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)}},{key:"addInput",value:function(t,e,n){var i={name:t,type:e=e||0,link:null};if(n)for(var s in n)i[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),this.setDirtyCanvas(!0,!0),i}},{key:"addInputs",value:function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeInput",value:function(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),n=t;n<this.inputs.length;++n)if(this.inputs[n]){var i=this.graph.links[this.inputs[n].link];i&&(i.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)}},{key:"addConnection",value:function(t,e,n,i){var s={name:t,type:e,pos:n,direction:i,links:null};return this.connections.push(s),s}},{key:"computeSize",value:function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=t||new Float32Array([0,0]);e=Math.max(e,1);var i=i=u.NODE_TEXT_SIZE,s=g(this.title),o=0,a=0;if(this.inputs)for(var r=0,l=this.inputs.length;r<l;++r){var h=this.inputs[r];o<(c=g(h.label||h.name||""))&&(o=c)}if(this.outputs)for(r=0,l=this.outputs.length;r<l;++r){var c,d=this.outputs[r];a<(c=g(d.label||d.name||""))&&(a=c)}n[0]=Math.max(o+a+10,s),n[0]=Math.max(n[0],u.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*u.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+e*u.NODE_SLOT_HEIGHT;var p=0;if(this.widgets&&this.widgets.length){for(r=0,l=this.widgets.length;r<l;++r)this.widgets[r].computeSize?p+=this.widgets[r].computeSize(n[0])[1]+4:p+=u.NODE_WIDGET_HEIGHT+4;p+=8}function g(t){return t?i*t.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],p):null!=this.widgets_start_y?n[1]=Math.max(n[1],p+this.widgets_start_y):n[1]+=p,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n}},{key:"getPropertyInfo",value:function(t){var n=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){n=this.properties_info[i];break}return this.constructor["@".concat(t)]&&(n=this.constructor["@".concat(t)]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(n=this.constructor.widgets_info[t]),!n&&this.onGetPropertyInfo&&(n=this.onGetPropertyInfo(t)),n||(n={}),n.type||(n.type=e(this.properties[t])),"combo"==n.widget&&(n.type="enum"),n}},{key:"addWidget",value:function(t,e,n,i,s){this.widgets||(this.widgets=[]),!s&&i&&i.constructor===Object&&(s=i,i=null),s&&s.constructor===String&&(s={property:s}),i&&i.constructor===String&&(s||(s={}),s.property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);var o={type:t.toLowerCase(),name:e,value:n,callback:i,options:s||{}};if(void 0!==o.options.y&&(o.y=o.options.y),i||o.options.callback||o.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o}},{key:"addCustomWidget",value:function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t}},{key:"getBounding",value:function(t){return(t=t||new Float32Array(4))[0]=this.pos[0]-4,t[1]=this.pos[1]-u.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.size[1]+u.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t}},{key:"isPointInside",value:function(t,e,n,i){n=n||0;var s=this.graph&&this.graph.isLive()?0:u.NODE_TITLE_HEIGHT;if(i&&(s=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(t,e,this.pos[0]-n,this.pos[1]-u.NODE_TITLE_HEIGHT-n,(this._collapsed_width||u.NODE_COLLAPSED_WIDTH)+2*n,u.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<t&&this.pos[0]+this.size[0]+4+n>t&&this.pos[1]-s-n<e&&this.pos[1]+this.size[1]+n>e)return!0;return!1}},{key:"getSlotInPosition",value:function(t,e){var n=new Float32Array(2);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i){var o=this.inputs[i];if(this.getConnectionPos(!0,i,n),isInsideRectangle(t,e,n[0]-10,n[1]-5,20,10))return{input:o,slot:i,link_pos:n}}if(this.outputs)for(i=0,s=this.outputs.length;i<s;++i){var a=this.outputs[i];if(this.getConnectionPos(!1,i,n),isInsideRectangle(t,e,n[0]-10,n[1]-5,20,10))return{output:a,slot:i,link_pos:n}}return null}},{key:"findInputSlot",value:function(t){if(!this.inputs)return-1;for(var e=0,n=this.inputs.length;e<n;++e)if(t==this.inputs[e].name)return e;return-1}},{key:"findOutputSlot",value:function(t){if(!this.outputs)return-1;for(var e=0,n=this.outputs.length;e<n;++e)if(t==this.outputs[e].name)return e;return-1}},{key:"connect",value:function(t,e,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return u.debug&&console.log("Connect: Error, no slot of name ".concat(t)),null}else if(!this.outputs||t>=this.outputs.length)return u.debug&&console.log("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return null;if(n.constructor===String){if(-1==(n=e.findInputSlot(n)))return u.debug&&console.log("Connect: Error, no slot of name ".concat(n)),null}else{if(n===u.EVENT)return null;if(!e.inputs||n>=e.inputs.length)return u.debug&&console.log("Connect: Error, slot number not found"),null}var i=!1;null!=e.inputs[n].link&&(this.graph.beforeChange(),e.disconnectInput(n),i=!0);var s=this.outputs[t];if(e.onConnectInput&&!1===e.onConnectInput(n,s.type,s,this,t))return null;var o=e.inputs[n],a=null;return u.isValidConnection(s.type,o.type)?(i||this.graph.beforeChange(),a=new LLink(++this.graph.last_link_id,o.type,this.id,t,e.id,n),this.graph.links[a.id]=a,null==s.links&&(s.links=[]),s.links.push(a.id),e.inputs[n].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(u.OUTPUT,t,!0,a,s),e.onConnectionsChange&&e.onConnectionsChange(u.INPUT,n,!0,a,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(u.INPUT,e,n,this,t),this.graph.onNodeConnectionChange(u.OUTPUT,this,t,e,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a):(this.setDirtyCanvas(!1,!0),i&&this.graph.connectionChange(this,a),null)}},{key:"disconnectOutput",value:function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return u.debug&&console.log("Connect: Error, no slot of name ".concat(t)),!1}else if(!this.outputs||t>=this.outputs.length)return u.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[t];if(!n||!n.links||0==n.links.length)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var i=0,s=n.links.length;i<s;i++){var o=n.links[i];if((a=this.graph.links[o]).target_id==e.id){n.links.splice(i,1),(r=e.inputs[a.target_slot]).link=null,delete this.graph.links[o],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(u.INPUT,a.target_slot,!1,a,r),this.onConnectionsChange&&this.onConnectionsChange(u.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(u.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(u.OUTPUT,this,t),this.graph.onNodeConnectionChange(u.INPUT,e,a.target_slot));break}}}else{for(i=0,s=n.links.length;i<s;i++){var a;o=n.links[i];if(a=this.graph.links[o]){e=this.graph.getNodeById(a.target_id);var r=null;this.graph&&this.graph._version++,e&&((r=e.inputs[a.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(u.INPUT,a.target_slot,!1,a,r),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(u.INPUT,e,a.target_slot)),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(u.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(u.OUTPUT,this,t),this.graph.onNodeConnectionChange(u.INPUT,e,a.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}},{key:"disconnectInput",value:function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return u.debug&&console.log("Connect: Error, no slot of name ".concat(t)),!1}else if(!this.inputs||t>=this.inputs.length)return u.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var n=this.inputs[t].link;if(null!=n){this.inputs[t].link=null;var i=this.graph.links[n];if(i){var s=this.graph.getNodeById(i.origin_id);if(!s)return!1;var o=s.outputs[i.origin_slot];if(!o||!o.links||0==o.links.length)return!1;for(var a=0,r=o.links.length;a<r;a++)if(o.links[a]==n){o.links.splice(a,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(u.INPUT,t,!1,i,e),s.onConnectionsChange&&s.onConnectionsChange(u.OUTPUT,a,!1,i,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(u.OUTPUT,s,a),this.graph.onNodeConnectionChange(u.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}},{key:"getConnectionPos",value:function(t,e,n){n=n||new Float32Array(2);var i=0;t&&this.inputs&&(i=this.inputs.length),!t&&this.outputs&&(i=this.outputs.length);var s=.5*u.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var o=this._collapsed_width||u.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*o,n[1]=t?this.pos[1]-u.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=t?this.pos[0]:this.pos[0]+o,n[1]=this.pos[1]-.5*u.NODE_TITLE_HEIGHT),n}return t&&-1==e?(n[0]=this.pos[0]+.5*u.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*u.NODE_TITLE_HEIGHT,n):t&&i>e&&this.inputs[e].pos?(n[0]=this.pos[0]+this.inputs[e].pos[0],n[1]=this.pos[1]+this.inputs[e].pos[1],n):!t&&i>e&&this.outputs[e].pos?(n[0]=this.pos[0]+this.outputs[e].pos[0],n[1]=this.pos[1]+this.outputs[e].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(e+.5)*(this.size[0]/i),n[1]=t?this.pos[1]-u.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=t?this.pos[0]+s:this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(e+.7)*u.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)}},{key:"alignToGrid",value:function(){this.pos[0]=u.CANVAS_GRID_SIZE*Math.round(this.pos[0]/u.CANVAS_GRID_SIZE),this.pos[1]=u.CANVAS_GRID_SIZE*Math.round(this.pos[1]/u.CANVAS_GRID_SIZE)}},{key:"trace",value:function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>t.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)}},{key:"setDirtyCanvas",value:function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])}},{key:"loadImage",value:function(t){var e=this,n=new Image;return n.src=u.node_images_path+t,n.ready=!1,n.onload=function(){n.ready=!0,e.setDirtyCanvas(!0)},n}},{key:"captureInput",value:function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,n=0;n<e.length;++n){var i=e[n];(t||i.node_capturing_input==this)&&(i.node_capturing_input=t?this:null)}}},{key:"collapse",value:function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0))}},{key:"pin",value:function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t}},{key:"localToScreen",value:function(t,e,n){return[(t+this.pos[0])*n.scale+n.offset[0],(e+this.pos[1])*n.scale+n.offset[1]]}}]),t}(),S=function(){function t(e){n(this,t),o(this,"isPointInside",O.prototype.isPointInside),o(this,"setDirtyCanvas",O.prototype.setDirtyCanvas),this._ctor(e)}return s(t,[{key:"_ctor",value:function(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})}},{key:"recomputeInsideNodes",value:function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),n=0;n<t.length;++n){var i=t[n];i.getBounding(e),overlapBounding(this._bounding,e)&&this._nodes.push(i)}}},{key:"move",value:function(t,e,n){if(this._pos[0]+=t,this._pos[1]+=e,!n)for(var i=0;i<this._nodes.length;++i){var s=this._nodes[i];s.pos[0]+=t,s.pos[1]+=e}}},{key:"serialize",value:function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}}},{key:"configure",value:function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font}}]),t}(),A=function(){function t(e,i){n(this,t),i=i||{};var s=document.createElement("div");this.root=s,s.className="litegraph litegraph-editor",s.innerHTML="<div class='content'><div class='editor-area'><canvas class='graphcanvas' width='1000' height='500' tabindex=10></canvas></div></div>",this.content=s.querySelector(".content"),this.footer=s.querySelector(".footer");var o=s.querySelector(".graphcanvas"),a=this.graph=new w,r=this.graphcanvas=new LGraphCanvas(o,a);r.background_image="imgs/grid.png",a.onAfterExecute=function(){r.draw(!0)},r.onDropItem=this.onDropItem.bind(this),i.miniwindow&&this.addMiniWindow(300,200);var l=document.getElementById(e);l&&l.appendChild(s),r.resize()}return s(t,[{key:"onDropItem",value:function(t){var e,n=this,i=h(t.dataTransfer.files);try{for(i.s();!(e=i.n()).done;){var s=e.value,o=LGraphCanvas.getFileExtension(s.name),a=new FileReader;"json"===o&&(a.onload=function(t){n.graph.configure(JSON.parse(t.target.result))},a.readAsText(s))}}catch(t){i.e(t)}finally{i.f()}}},{key:"addMiniWindow",value:function(t,e){var n=document.createElement("div");n.className="litegraph miniwindow",n.innerHTML="<canvas class='graphcanvas' width='".concat(t,"' height='").concat(e,"' tabindex=10></canvas>");var i=n.querySelector("canvas"),s=this,o=new LGraphCanvas(i,this.graph);o.show_info=!1,o.background_image="imgs/grid.png",o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1,o.render_shadows=!1,o.max_zoom=.25,this.miniwindow_graphcanvas=o,o.onClear=function(){o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1},o.onRenderBackground=function(t,e){e.strokeStyle="#567";var n=s.graphcanvas.convertOffsetToCanvas([0,0]),i=s.graphcanvas.convertOffsetToCanvas([s.graphcanvas.canvas.width,s.graphcanvas.canvas.height]);n=this.convertCanvasToOffset(n),i=this.convertCanvasToOffset(i),e.lineWidth=1,e.strokeRect(Math.floor(n[0])+.5,Math.floor(n[1])+.5,Math.floor(i[0]-n[0]),Math.floor(i[1]-n[1]))},n.style.position="absolute",n.style.top="4px",n.style.right="4px";var a=document.createElement("div");a.className="corner-button",a.innerHTML="&#10060;",a.addEventListener("click",(function(t){o.setGraph(null),n.parentNode.removeChild(n)})),n.appendChild(a),this.root.querySelector(".content").appendChild(n)}}]),t}();return t.Editor=A,t.LGraph=w,t.LGraphGroup=S,t.LGraphNode=O,t.LLink=N,t.LiteGraph=u,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
//# sourceMappingURL=litegraph.min.js.map
