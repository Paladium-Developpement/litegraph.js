var LiteGraph=function(t){"use strict";function e(t,e){void 0===e&&(e={});var n=e.insertAt;if(t&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===n&&i.firstChild?i.insertBefore(s,i.firstChild):i.appendChild(s),s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t))}}e('/* this CSS contains only the basic CSS needed to run the app and use it */\n\n.lgraphcanvas {\n    /*cursor: crosshair;*/\n    user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n\toutline: none;\n}\n\n.litegraph.litecontextmenu {\n    font-family: Tahoma, sans-serif;\n    position: fixed;\n    top: 100px;\n    left: 100px;\n    min-width: 100px;\n    color: #aaf;\n    padding: 0;\n    box-shadow: 0 0 10px black !important;\n    background-color: #2e2e2e !important;\n\tz-index: 10;\n}\n\n.litegraph.litecontextmenu.dark {\n    background-color: #000 !important;\n}\n\n.litegraph.litecontextmenu .litemenu-title img {\n    margin-top: 2px;\n    margin-left: 2px;\n    margin-right: 4px;\n}\n\n.litegraph.litecontextmenu .litemenu-entry {\n    margin: 2px;\n    padding: 2px;\n}\n\n.litegraph.litecontextmenu .litemenu-entry.submenu {\n    background-color: #2e2e2e !important;\n}\n\n.litegraph.litecontextmenu.dark .litemenu-entry.submenu {\n    background-color: #000 !important;\n}\n\n.litegraph .litemenubar ul {\n    font-family: Tahoma, sans-serif;\n    margin: 0;\n    padding: 0;\n}\n\n.litegraph .litemenubar li {\n    font-size: 14px;\n    color: #999;\n    display: inline-block;\n    min-width: 50px;\n    padding-left: 10px;\n    padding-right: 10px;\n    user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    cursor: pointer;\n}\n\n.litegraph .litemenubar li:hover {\n    background-color: #777;\n    color: #eee;\n}\n\n.litegraph .litegraph .litemenubar-panel {\n    position: absolute;\n    top: 5px;\n    left: 5px;\n    min-width: 100px;\n    background-color: #444;\n    box-shadow: 0 0 3px black;\n    padding: 4px;\n    border-bottom: 2px solid #aaf;\n    z-index: 10;\n}\n\n.litegraph .litemenu-entry,\n.litemenu-title {\n    font-size: 12px;\n    color: #aaa;\n    padding: 0 0 0 4px;\n    margin: 2px;\n    padding-left: 2px;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    user-select: none;\n    cursor: pointer;\n}\n\n.litegraph .litemenu-entry .icon {\n    display: inline-block;\n    width: 12px;\n    height: 12px;\n    margin: 2px;\n    vertical-align: top;\n}\n\n.litegraph .litemenu-entry.checked .icon {\n    background-color: #aaf;\n}\n\n.litegraph .litemenu-entry .more {\n    float: right;\n    padding-right: 5px;\n}\n\n.litegraph .litemenu-entry.disabled {\n    opacity: 0.5;\n    cursor: default;\n}\n\n.litegraph .litemenu-entry.separator {\n    display: block;\n    border-top: 1px solid #333;\n    border-bottom: 1px solid #666;\n    width: 100%;\n    height: 0px;\n    margin: 3px 0 2px 0;\n    background-color: transparent;\n    padding: 0 !important;\n    cursor: default !important;\n}\n\n.litegraph .litemenu-entry.has_submenu {\n    border-right: 2px solid cyan;\n}\n\n.litegraph .litemenu-title {\n    color: #dde;\n    background-color: #111;\n    margin: 0;\n    padding: 2px;\n    cursor: default;\n}\n\n.litegraph .litemenu-entry:hover:not(.disabled):not(.separator) {\n    background-color: #444 !important;\n    color: #eee;\n    transition: all 0.2s;\n}\n\n.litegraph .litemenu-entry .property_name {\n    display: inline-block;\n    text-align: left;\n    min-width: 80px;\n    min-height: 1.2em;\n}\n\n.litegraph .litemenu-entry .property_value {\n    display: inline-block;\n    background-color: rgba(0, 0, 0, 0.5);\n    text-align: right;\n    min-width: 80px;\n    min-height: 1.2em;\n    vertical-align: middle;\n    padding-right: 10px;\n}\n\n.litegraph.litesearchbox {\n    font-family: Tahoma, sans-serif;\n    position: absolute;\n    background-color: rgba(0, 0, 0, 0.5);\n    padding-top: 4px;\n}\n\n.litegraph.litesearchbox input,\n.litegraph.litesearchbox select {\n    margin-top: 3px;\n    min-width: 60px;\n    min-height: 1.5em;\n    background-color: black;\n    border: 0;\n    color: white;\n    padding-left: 10px;\n    margin-right: 5px;\n}\n\n.litegraph.litesearchbox .name {\n    display: inline-block;\n    min-width: 60px;\n    min-height: 1.5em;\n    padding-left: 10px;\n}\n\n.litegraph.litesearchbox .helper {\n    overflow: auto;\n    max-height: 200px;\n    margin-top: 2px;\n}\n\n.litegraph.lite-search-item {\n    font-family: Tahoma, sans-serif;\n    background-color: rgba(0, 0, 0, 0.5);\n    color: white;\n    padding-top: 2px;\n}\n\n.litegraph.lite-search-item:hover,\n.litegraph.lite-search-item.selected {\n    cursor: pointer;\n    background-color: white;\n    color: black;\n}\n\n/* DIALOGs ******/\n\n.litegraph .dialog {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    margin-top: -150px;\n    margin-left: -200px;\n\n    background-color: #2A2A2A;\n\n    min-width: 400px;\n    min-height: 200px;\n\tbox-shadow: 0 0 4px #111;\n    border-radius: 6px;\n}\n\n.litegraph .dialog.settings {\n\tleft: 10px;\n\ttop: 10px;\n\theight: calc( 100% - 20px );\n\tmargin: auto;\n}\n\n.litegraph .dialog .close {\n    float: right;\n\tmargin: 4px;\n\tmargin-right: 10px;\n\tcursor: pointer;\n\tfont-size: 1.4em;\n}\n\n.litegraph .dialog .close:hover {\n\tcolor: white;\n}\n\n.litegraph .dialog .dialog-header {\n\tcolor: #AAA;\n\tborder-bottom: 1px solid #161616;\n}\n\n.litegraph .dialog .dialog-header { height: 40px; }\n.litegraph .dialog .dialog-footer { height: 50px; padding: 10px; border-top: 1px solid #1a1a1a;}\n\n.litegraph .dialog .dialog-header .dialog-title {\n    font: 20px "Arial";\n    margin: 4px;\n    padding: 4px 10px;\n    display: inline-block;\n}\n\n.litegraph .dialog .dialog-content {\n    height: calc(100% - 90px);\n    width: 100%;\n\tmin-height: 100px;\n    display: inline-block;\n\tcolor: #AAA;\n    /*background-color: black;*/\n}\n\n.litegraph .dialog .dialog-content h3 {\n\tmargin: 10px;\n}\n\n.litegraph .dialog .dialog-content .connections {\n\tflex-direction: row;\n}\n\n.litegraph .dialog .dialog-content .connections .connections_side {\n\twidth: calc(50% - 5px);\n\tmin-height: 100px;\n\tbackground-color: black;\n\tdisplay: flex;\n}\n\n.litegraph .dialog .node_type {\n\tfont-size: 1.2em;\n\tdisplay: block;\n\tmargin: 10px;\n}\n\n.litegraph .dialog .node_desc {\n\topacity: 0.5;\n\tdisplay: block;\n\tmargin: 10px;\n}\n\n.litegraph .dialog .separator {\n\tdisplay: block;\n\twidth: calc( 100% - 4px );\n\theight: 1px;\n\tborder-top: 1px solid #000;\n\tborder-bottom: 1px solid #333;\n\tmargin: 10px 2px;\n\tpadding: 0;\n}\n\n.litegraph .dialog .property {\n\tmargin-bottom: 2px;\n\tpadding: 4px;\n}\n\n.litegraph .dialog .property_name {\n\tcolor: #737373;\n    display: inline-block;\n    text-align: left;\n    vertical-align: top;\n    width: 120px;\n\tpadding-left: 4px;\n\toverflow: hidden;\n}\n\n.litegraph .dialog .property_value {\n    display: inline-block;\n    text-align: right;\n\tcolor: #AAA;\n\tbackground-color: #1A1A1A;\n    width: calc( 100% - 122px );\n\tmax-height: 300px;\n    padding: 4px;\n\tpadding-right: 12px;\n\toverflow: hidden;\n\tcursor: pointer;\n\tborder-radius: 3px;\n}\n\n.litegraph .dialog .property_value:hover {\n\tcolor: white;\n}\n\n.litegraph .dialog .property.boolean .property_value {\n\tpadding-right: 30px;\n}\n\n.litegraph .dialog .btn {\n\tborder-radius: 4px;\n    padding: 4px 20px;\n    margin-left: 0px;\n    background-color: #060606;\n    color: #8e8e8e;\n}\n\n.litegraph .dialog .btn:hover {\n    background-color: #111;\n    color: #FFF;\n}\n\n.litegraph .dialog .btn.delete:hover {\n    background-color: #F33;\n    color: black;\n}\n\n.litegraph .subgraph_property {\n\tpadding: 4px;\n}\n\n.litegraph .subgraph_property:hover {\n\tbackground-color: #333;\n}\n\n.litegraph .subgraph_property.extra {\n    margin-top: 8px;\n}\n\n.litegraph .subgraph_property span.name {\n\tfont-size: 1.3em;\n\tpadding-left: 4px;\n}\n\n.litegraph .subgraph_property span.type {\n\topacity: 0.5;\n\tmargin-right: 20px;\n\tpadding-left: 4px;\n}\n\n.litegraph .subgraph_property span.label {\n\tdisplay: inline-block;\n\twidth: 60px;\n\tpadding:  0px 10px;\n}\n\n.litegraph .subgraph_property input {\n\twidth: 140px;\n\tcolor: #999;\n\tbackground-color: #1A1A1A;\n\tborder-radius: 4px;\n\tborder: 0;\n\tmargin-right: 10px;\n\tpadding: 4px;\n\tpadding-left: 10px;\n}\n\n.litegraph .subgraph_property button {\n\tbackground-color: #1c1c1c;\n\tcolor: #aaa;\n\tborder: 0;\n\tborder-radius: 2px;\n\tpadding: 4px 10px;\n\tcursor: pointer;\n}\n\n.litegraph .subgraph_property.extra {\n\tcolor: #ccc;\n}\n\n.litegraph .subgraph_property.extra input {\n\tbackground-color: #111;\n}\n\n.litegraph .bullet_icon {\n\tmargin-left: 10px;\n\tborder-radius: 10px;\n\twidth: 12px;\n\theight: 12px;\n\tbackground-color: #666;\n\tdisplay: inline-block;\n\tmargin-top: 2px;\n\tmargin-right: 4px;\n    transition: background-color 0.1s ease 0s;\n    -moz-transition: background-color 0.1s ease 0s;\n}\n\n.litegraph .bullet_icon:hover {\n\tbackground-color: #698;\n\tcursor: pointer;\n} \n\n/* OLD */\n\n.graphcontextmenu {\n    padding: 4px;\n    min-width: 100px;\n}\n\n.graphcontextmenu-title {\n    color: #dde;\n    background-color: #222;\n    margin: 0;\n    padding: 2px;\n    cursor: default;\n}\n\n.graphmenu-entry {\n    box-sizing: border-box;\n    margin: 2px;\n    padding-left: 20px;\n    user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    transition: all linear 0.3s;\n}\n\n.graphmenu-entry.event,\n.litemenu-entry.event {\n    border-left: 8px solid orange;\n    padding-left: 12px;\n}\n\n.graphmenu-entry.disabled {\n    opacity: 0.3;\n}\n\n.graphmenu-entry.submenu {\n    border-right: 2px solid #eee;\n}\n\n.graphmenu-entry:hover {\n    background-color: #555;\n}\n\n.graphmenu-entry.separator {\n    background-color: #111;\n    border-bottom: 1px solid #666;\n    height: 1px;\n    width: calc(100% - 20px);\n    -moz-width: calc(100% - 20px);\n    -webkit-width: calc(100% - 20px);\n}\n\n.graphmenu-entry .property_name {\n    display: inline-block;\n    text-align: left;\n    min-width: 80px;\n    min-height: 1.2em;\n}\n\n.graphmenu-entry .property_value,\n.litemenu-entry .property_value {\n    display: inline-block;\n    background-color: rgba(0, 0, 0, 0.5);\n    text-align: right;\n    min-width: 80px;\n    min-height: 1.2em;\n    vertical-align: middle;\n    padding-right: 10px;\n}\n\n.graphdialog {\n    position: absolute;\n    top: 10px;\n    left: 10px;\n    /*min-height: 2em;*/\n    background-color: #333;\n    font-size: 1.2em;\n    box-shadow: 0 0 10px black !important;\n\tz-index: 10;\n}\n\n.graphdialog.rounded {\n    border-radius: 12px;\n    padding-right: 2px;\n}\n\n.graphdialog .name {\n    display: inline-block;\n    min-width: 60px;\n    min-height: 1.5em;\n    padding-left: 10px;\n}\n\n.graphdialog input,\n.graphdialog textarea,\n.graphdialog select {\n    margin: 3px;\n    min-width: 60px;\n    min-height: 1.5em;\n    background-color: black;\n    border: 0;\n    color: white;\n    padding-left: 10px;\n    outline: none;\n}\n\n.graphdialog textarea {\n\tmin-height: 150px;\n}\n\n.graphdialog button {\n    margin-top: 3px;\n    vertical-align: top;\n    background-color: #999;\n\tborder: 0;\n}\n\n.graphdialog button.rounded,\n.graphdialog input.rounded {\n    border-radius: 0 12px 12px 0;\n}\n\n.graphdialog .helper {\n    overflow: auto;\n    max-height: 200px;\n}\n\n.graphdialog .help-item {\n    padding-left: 10px;\n}\n\n.graphdialog .help-item:hover,\n.graphdialog .help-item.selected {\n    cursor: pointer;\n    background-color: white;\n    color: black;\n}\n');function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function a(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||h(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(t,e){if(t){if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function c(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=h(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,r=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){r=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(r)throw o}}}}e('.litegraph-editor {\r\n    width: 100%;\r\n    height: 100%;\r\n    margin: 0;\r\n    padding: 0;\r\n\r\n    background-color: #333;\r\n    color: #eee;\r\n    font: 14px Tahoma;\r\n\r\n    position: relative;\r\n\r\n    overflow: hidden;\r\n}\r\n\r\n.litegraph-editor h1 {\r\n    font-family: "Metro Light", Tahoma;\r\n    color: #ddd;\r\n    font-size: 28px;\r\n    padding-left: 10px;\r\n    /*text-shadow: 0 1px 1px #333, 0 -1px 1px #777;*/\r\n    margin: 0;\r\n    font-weight: normal;\r\n}\r\n\r\n.litegraph-editor h1 span {\r\n    font-family: "Arial";\r\n    font-size: 14px;\r\n    font-weight: normal;\r\n    color: #aaa;\r\n}\r\n\r\n.litegraph-editor h2 {\r\n    font-family: "Metro Light";\r\n    padding: 5px;\r\n    margin-left: 10px;\r\n}\r\n\r\n.litegraph-editor * {\r\n    box-sizing: border-box;\r\n    -moz-box-sizing: border-box;\r\n}\r\n\r\n.litegraph-editor .content {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    background-color: #1a1a1a;\r\n}\r\n\r\n.litegraph-editor .header,\r\n.litegraph-editor .footer {\r\n    position: relative;\r\n    height: 40px;\r\n    background-color: #333;\r\n    /*border-radius: 10px 10px 0 0;*/\r\n}\r\n\r\n.litegraph-editor .tools,\r\n.litegraph-editor .tools-left,\r\n.litegraph-editor .tools-right {\r\n    position: absolute;\r\n    top: 2px;\r\n    right: 0px;\r\n    vertical-align: top;\r\n\r\n    margin: 2px 5px 0 0px;\r\n}\r\n\r\n.litegraph-editor .tools-left {\r\n    right: auto;\r\n    left: 4px;\r\n}\r\n\r\n.litegraph-editor .footer {\r\n    height: 40px;\r\n    position: relative;\r\n    /*border-radius: 0 0 10px 10px;*/\r\n}\r\n\r\n.litegraph-editor .miniwindow {\r\n    background-color: #333;\r\n    border: 1px solid #111;\r\n}\r\n\r\n.litegraph-editor .miniwindow .corner-button {\r\n    position: absolute;\r\n    top: 2px;\r\n    right: 2px;\r\n    font-family: "Tahoma";\r\n    font-size: 14px;\r\n    color: #aaa;\r\n    cursor: pointer;\r\n}\r\n\r\n/* BUTTONS **********************/\r\n\r\n.litegraph-editor .btn {\r\n    /*font-family: "Metro Light";*/\r\n    color: #ccc;\r\n    font-size: 20px;\r\n    min-width: 30px;\r\n    /*border-radius: 0.3em;*/\r\n    border: 0 solid #666;\r\n    background-color: #3f3f3f;\r\n    /*box-shadow: 0 0 3px black;*/\r\n    padding: 4px 10px;\r\n    cursor: pointer;\r\n    transition: all 1s;\r\n    -moz-transition: all 1s;\r\n    -webkit-transition: all 0.4s;\r\n}\r\n\r\n.litegraph-editor button:hover {\r\n    background-color: #999;\r\n    color: #fff;\r\n    transition: all 1s;\r\n    -moz-transition: all 1s;\r\n    -webkit-transition: all 0.4s;\r\n}\r\n\r\n.litegraph-editor button:active {\r\n    background-color: white;\r\n}\r\n\r\n.litegraph-editor button.fixed {\r\n    position: absolute;\r\n    top: 5px;\r\n    right: 5px;\r\n    font-size: 1.2em;\r\n}\r\n\r\n.litegraph-editor button img {\r\n    margin: -4px;\r\n    vertical-align: top;\r\n    opacity: 0.8;\r\n    transition: all 1s;\r\n}\r\n\r\n.litegraph-editor button:hover img {\r\n    opacity: 1;\r\n}\r\n\r\n.litegraph-editor .header button {\r\n    height: 32px;\r\n    vertical-align: top;\r\n}\r\n\r\n.litegraph-editor .footer button {\r\n    /*font-size: 16px;*/\r\n}\r\n\r\n.litegraph-editor .toolbar-widget {\r\n    display: inline-block;\r\n}\r\n\r\n.litegraph-editor .editor-area {\r\n    width: 100%;\r\n    height: 100%;\r\n}\r\n\r\n/* METER *********************/\r\n\r\n.litegraph-editor .loadmeter {\r\n    font-family: "Tahoma";\r\n    color: #aaa;\r\n    font-size: 12px;\r\n    border-radius: 2px;\r\n    width: 130px;\r\n    vertical-align: top;\r\n}\r\n\r\n.litegraph-editor .strong {\r\n    vertical-align: top;\r\n    padding: 3px;\r\n    width: 30px;\r\n    display: inline-block;\r\n    line-height: 8px;\r\n}\r\n\r\n.litegraph-editor .cpuload .bgload,\r\n.litegraph-editor .gpuload .bgload {\r\n    display: inline-block;\r\n    width: 90px;\r\n    height: 15px;\r\n    background-image: url("../editor/imgs/load-progress-empty.png");\r\n}\r\n\r\n.litegraph-editor .cpuload .fgload,\r\n.litegraph-editor .gpuload .fgload {\r\n    display: inline-block;\r\n    width: 4px;\r\n    height: 15px;\r\n    max-width: 90px;\r\n    background-image: url("../editor/imgs/load-progress-full.png");\r\n}\r\n\r\n.litegraph-editor textarea.code, .litegraph-editor div.code {\r\n\theight: 100%;\r\n\twidth: 100%;\r\n\tbackground-color: black;\r\n\tpadding: 4px;\r\n\tfont: 16px monospace;\r\n\toverflow: auto;\r\n\tresize: none;\r\n\toutline: none;\r\n}\r\n\r\n.litegraph-editor .codeflask {\r\n\tbackground-color: #2a2a2a;\r\n}\r\n\r\n.litegraph-editor .codeflask textarea {\r\n\topacity: 0;\r\n}\r\n');var d={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!0,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1};function p(){if("undefined"!=typeof performance)return performance.now();if("undefined"!=typeof Date&&void 0!==Date.now)return Date.now;if("undefined"!=typeof process){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}return(new Date).getTime()}function g(t,e){if(null==t)return null;var n=JSON.parse(JSON.stringify(t));if(!e)return n;for(var i in n)e[i]=n[i];return e}function v(t,e){if(!e.prototype)throw new TypeError("Cannot register a simple object, it must be a class with a prototype");e.type=t,d.debug&&console.log("Node registered: ".concat(t));var n=e.name,i=t.lastIndexOf("/");e.category=t.substr(0,i),e.title||(e.title=n);var s=d.registered_node_types[t];if(s)console.log("replacing node type: ".concat(t));else if(Object.hasOwnProperty.call(e.prototype,"shape")||Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=d.BOX_SHAPE;break;case"round":this._shape=d.ROUND_SHAPE;break;case"circle":this._shape=d.CIRCLE_SHAPE;break;case"card":this._shape=d.CARD_SHAPE;break;default:this._shape=t}},get:function(){return this._shape},enumerable:!0,configurable:!0}),e.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(t," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),e.supported_extensions){var o,a=c(e.supported_extensions);try{for(a.s();!(o=a.n()).done;){var r=o.value;r&&r.constructor===String&&(d.node_types_by_file_extension[r.toLowerCase()]=e)}}catch(t){a.e(t)}finally{a.f()}}if(d.registered_node_types[t]=e,e.constructor.name&&(d.Nodes[n]=e),d.onNodeTypeRegistered&&d.onNodeTypeRegistered(t,e),s&&d.onNodeTypeReplaced&&d.onNodeTypeReplaced(t,e,s),e.prototype.onPropertyChange&&console.warn("LiteGraph node class ".concat(t," has onPropertyChange method, it must be called onPropertyChanged with d at the end")),e.supported_extensions){var l,h=c(e.supported_extensions);try{for(h.s();!(l=h.n()).done;){var u=l.value;u&&u.constructor===String&&(d.node_types_by_file_extension[u.toLowerCase()]=e)}}catch(t){h.e(t)}finally{h.f()}}}function f(t,e){var n=[];for(var i in d.registered_node_types){var s=d.registered_node_types[i];s.filter===e&&(""===t?s.category||n.push(s):s.category===t&&n.push(s))}return d.auto_sort_node_types?n.sort():n}function _(t){var e={"":1};for(var n in d.registered_node_types){var i=d.registered_node_types[n];if(i.category&&!i.skip_list){if(i.filter!==t)continue;e[i.category]=1}}var s=[];for(var o in e)s.push(o);return d.auto_sort_node_types?s.sort():s}function y(t){return"".concat(t).replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}function m(t,e){if(!t||!e||t===e||t===d.EVENT&&e===d.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1===t.indexOf(",")&&-1===e.indexOf(","))return t===e;for(var n=t.split(","),i=e.split(","),s=0;s<n.length;++s)for(var o=0;o<i.length;++o)if(n[s]===i[o])return!0;return!1}var b=function(){function t(e,n,i,o,a,r){s(this,t),this.id=e,this.type=n,this.origin_id=i,this.origin_slot=o,this.target_id=a,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}return a(t,[{key:"configure",value:function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)}},{key:"serialize",value:function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}]),t}();function k(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function E(t,e,n,i,s,o){return n<t&&n+s>t&&i<e&&i+o>e}function T(t,e){var n=t[0]+t[2],i=t[1]+t[3],s=e[0]+e[2],o=e[1]+e[3];return!(t[0]>s||t[1]>o||n<e[0]||i<e[1])}function w(t,e,n){return e>t?e:n<t?n:t}var x=function(){function t(e){s(this,t),r(this,"_pos",new Float32Array(10,10)),this.title=e||"Unnamed",this.size=[d.NODE_WIDTH,60],this.graph=null,this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}return a(t,[{key:"pos",get:function(){return this._pos},set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}},{key:"configure",value:function(t){for(var e in this.graph&&this.graph._version++,t)if("properties"!==e)null!=t[e]&&("object"===n(t[e])?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=g(t[e],this[e]):this[e]=t[e]);else for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);if(t.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],a=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange(d.INPUT,s,!0,a,o)}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var l=this.outputs[r];if(l.links)for(var h=0;h<l.links.length;++h){var u=this.graph?this.graph.links[l.links[h]]:null;this.onConnectionsChange(d.OUTPUT,r,!0,u,l)}}}if(this.widgets){var p,v=c(this.widgets);try{for(v.s();!(p=v.n()).done;){var f=p.value;f&&(f.options&&f.options.property&&this.properties[f.options.property]&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property]))))}}catch(t){v.e(t)}finally{v.f()}if(t.widgets_values)for(var _=0;_<t.widgets_values.length;++_)this.widgets[_]&&(this.widgets[_].value=t.widgets_values[_])}this.onConfigure&&this.onConfigure(t)}},{key:"serialize",value:function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:g(this.flags),order:this.order,mode:this.mode};if(this.constructor===t&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var n=0;n<this.outputs.length;n++)delete this.outputs[n]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=g(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(var i=0;i<this.widgets.length;++i)this.widgets[i]?e.widgets_values[i]=this.widgets[i].value:e.widgets_values[i]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e}},{key:"clone",value:function(){var e=t.createNode(this.type);if(!e)return null;var n=t.cloneObject(this.serialize());if(n.inputs)for(var i=0;i<n.inputs.length;++i)n.inputs[i].link=null;if(n.outputs)for(var s=0;s<n.outputs.length;++s)n.outputs[s].links&&(n.outputs[s].links.length=0);return delete n.id,e.configure(n),e}},{key:"toString",value:function(){return JSON.stringify(this.serialize())}},{key:"getTitle",value:function(){return this.title||this.constructor.title}},{key:"setProperty",value:function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var n=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,n)&&(this.properties[t]=n),this.widgets)for(var i=0;i<this.widgets.length;++i){var s=this.widgets[i];if(s&&s.options.property==t){s.value=e;break}}}}},{key:"setOutputData",value:function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n._data=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i],o=this.graph.links[s];o&&(o.data=e)}}}},{key:"setOutputDataType",value:function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n.type=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i];this.graph.links[s].type=e}}}},{key:"getInputData",value:function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)){var n=this.inputs[t].link,i=this.graph.links[n];if(!i)return null;if(i.data&&!e)return i.data;var s=this.graph.getNodeById(i.origin_id);return s?(s.updateOutputData?s.updateOutputData(i.origin_slot):s.onExecute&&s.onExecute(),i.data):i.data}}},{key:"getInputDataType",value:function(t){if(!this.inputs)return null;if(t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,n=this.graph.links[e];if(!n)return null;var i=this.graph.getNodeById(n.origin_id);if(!i)return n.type;var s=i.outputs[n.origin_slot];return s?s.type:null}},{key:"getInputDataByName",value:function(t,e){var n=this.findInputSlot(t);return-1==n?null:this.getInputData(n,e)}},{key:"isInputConnected",value:function(t){return!!this.inputs&&(t<this.inputs.length&&null!=this.inputs[t].link)}},{key:"getInputInfo",value:function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}},{key:"getInputLink",value:function(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null}},{key:"getInputNode",value:function(t){if(!this.inputs)return null;if(t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var n=this.graph.links[e.link];return n?this.graph.getNodeById(n.origin_id):null}},{key:"getInputOrProperty",value:function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,n=this.inputs.length;e<n;++e){var i=this.inputs[e];if(t==i.name&&null!=i.link){var s=this.graph.links[i.link];if(s)return s.data}}return this.properties[t]}},{key:"getOutputData",value:function(t){return this.outputs?t>=this.outputs.length?null:this.outputs[t]._data:null}},{key:"getOutputInfo",value:function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}},{key:"isOutputConnected",value:function(t){return!!this.outputs&&(t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length)}},{key:"isAnyOutputConnected",value:function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1}},{key:"getOutputNodes",value:function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var n=[],i=0;i<e.links.length;i++){var s=e.links[i],o=this.graph.links[s];if(o){var a=this.graph.getNodeById(o.target_id);a&&n.push(a)}}return n}},{key:"trigger",value:function(t,e){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=p());for(var n=0;n<this.outputs.length;++n){var i=this.outputs[n];!i||i.type!==d.EVENT||t&&i.name!=t||this.triggerSlot(n,e)}}}},{key:"triggerSlot",value:function(t,e,n){if(this.outputs){var i=this.outputs[t];if(i){var s=i.links;if(s&&s.length){this.graph&&(this.graph._last_trigger_time=p());for(var o=0;o<s.length;++o){var a=s[o];if(null==n||n==a){var r=this.graph.links[s[o]];if(r){r._last_time=p();var l=this.graph.getNodeById(r.target_id);if(l){var h=l.inputs[r.target_slot];l.mode===d.ON_TRIGGER?l.onExecute&&l.onExecute(e):l.onAction&&l.onAction(h.name,e)}}}}}}}}},{key:"clearTriggeredSlot",value:function(t,e){if(this.outputs){var n=this.outputs[t];if(n){var i=n.links;if(i&&i.length)for(var s=0;s<i.length;++s){var o=i[s];if(null==e||e==o){var a=this.graph.links[i[s]];a&&(a._last_time=0)}}}}}},{key:"setSize",value:function(t){this.size=t,this.onResize&&this.onResize(this.size)}},{key:"addProperty",value:function(t,e,n,i){var s={name:t,type:n,default_value:e};if(i)for(var o in i)s[o]=i[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s}},{key:"addOutput",value:function(t,e,n){var i={name:t,type:e,links:null};if(n)for(var s in n)i[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i}},{key:"addOutputs",value:function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeOutput",value:function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var n=this.outputs[e].links,i=0;i<n.length;++i){var s=this.graph.links[n[i]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)}},{key:"addInput",value:function(t,e,n){var i={name:t,type:e=e||0,link:null};if(n)for(var s in n)i[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),this.setDirtyCanvas(!0,!0),i}},{key:"addInputs",value:function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}},{key:"removeInput",value:function(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),n=t;n<this.inputs.length;++n)if(this.inputs[n]){var i=this.graph.links[this.inputs[n].link];i&&(i.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)}},{key:"addConnection",value:function(t,e,n,i){var s={name:t,type:e,pos:n,direction:i,links:null};return this.connections.push(s),s}},{key:"computeSize",value:function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=t||new Float32Array([0,0]);e=Math.max(e,1);var i=i=d.NODE_TEXT_SIZE,s=g(this.title),o=0,a=0;if(this.inputs)for(var r=0,l=this.inputs.length;r<l;++r){var h=this.inputs[r];o<(u=g(h.label||h.name||""))&&(o=u)}if(this.outputs)for(r=0,l=this.outputs.length;r<l;++r){var u,c=this.outputs[r];a<(u=g(c.label||c.name||""))&&(a=u)}n[0]=Math.max(o+a+10,s),n[0]=Math.max(n[0],d.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*d.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+e*d.NODE_SLOT_HEIGHT;var p=0;if(this.widgets&&this.widgets.length){for(r=0,l=this.widgets.length;r<l;++r)this.widgets[r].computeSize?p+=this.widgets[r].computeSize(n[0])[1]+4:p+=d.NODE_WIDGET_HEIGHT+4;p+=8}function g(t){return t?i*t.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],p):null!=this.widgets_start_y?n[1]=Math.max(n[1],p+this.widgets_start_y):n[1]+=p,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n}},{key:"getPropertyInfo",value:function(t){var e=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}return this.constructor["@".concat(t)]&&(e=this.constructor["@".concat(t)]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=n(this.properties[t])),"combo"==e.widget&&(e.type="enum"),e}},{key:"addWidget",value:function(t,e,n,i,s){this.widgets||(this.widgets=[]),!s&&i&&i.constructor===Object&&(s=i,i=null),s&&s.constructor===String&&(s={property:s}),i&&i.constructor===String&&(s||(s={}),s.property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);var o={type:t.toLowerCase(),name:e,value:n,callback:i,options:s||{}};if(o.options.y&&(o.y=o.options.y),i||o.options.callback||o.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o}},{key:"addCustomWidget",value:function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t}},{key:"getBounding",value:function(t){return(t=t||new Float32Array(4))[0]=this.pos[0]-4,t[1]=this.pos[1]-d.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.size[1]+d.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t}},{key:"isPointInside",value:function(t,e,n,i){n=n||0;var s=this.graph&&this.graph.isLive()?0:d.NODE_TITLE_HEIGHT;if(i&&(s=0),this.flags&&this.flags.collapsed){if(E(t,e,this.pos[0]-n,this.pos[1]-d.NODE_TITLE_HEIGHT-n,(this._collapsed_width||d.NODE_COLLAPSED_WIDTH)+2*n,d.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<t&&this.pos[0]+this.size[0]+4+n>t&&this.pos[1]-s-n<e&&this.pos[1]+this.size[1]+n>e)return!0;return!1}},{key:"getSlotInPosition",value:function(t,e){var n=new Float32Array(2);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i){var o=this.inputs[i];if(this.getConnectionPos(!0,i,n),E(t,e,n[0]-10,n[1]-5,20,10))return{input:o,slot:i,link_pos:n}}if(this.outputs)for(i=0,s=this.outputs.length;i<s;++i){var a=this.outputs[i];if(this.getConnectionPos(!1,i,n),E(t,e,n[0]-10,n[1]-5,20,10))return{output:a,slot:i,link_pos:n}}return null}},{key:"findInputSlot",value:function(t){if(!this.inputs)return-1;for(var e=0,n=this.inputs.length;e<n;++e)if(t==this.inputs[e].name)return e;return-1}},{key:"findOutputSlot",value:function(t){if(!this.outputs)return-1;for(var e=0,n=this.outputs.length;e<n;++e)if(t==this.outputs[e].name)return e;return-1}},{key:"connect",value:function(t,e,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return d.debug&&console.log("Connect: Error, no slot of name ".concat(t)),null}else if(!this.outputs||t>=this.outputs.length)return d.debug&&console.log("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return null;if(n.constructor===String){if(-1==(n=e.findInputSlot(n)))return d.debug&&console.log("Connect: Error, no slot of name ".concat(n)),null}else{if(n===d.EVENT)return null;if(!e.inputs||n>=e.inputs.length)return d.debug&&console.log("Connect: Error, slot number not found"),null}var i=!1;null!=e.inputs[n].link&&(this.graph.beforeChange(),e.disconnectInput(n),i=!0);var s=this.outputs[t];if(e.onConnectInput&&!1===e.onConnectInput(n,s.type,s,this,t))return null;var o=e.inputs[n],a=null;return m(s.type,o.type)?(i||this.graph.beforeChange(),a=new b(++this.graph.last_link_id,o.type,this.id,t,e.id,n),this.graph.links[a.id]=a,null==s.links&&(s.links=[]),s.links.push(a.id),e.inputs[n].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(d.OUTPUT,t,!0,a,s),e.onConnectionsChange&&e.onConnectionsChange(d.INPUT,n,!0,a,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(d.INPUT,e,n,this,t),this.graph.onNodeConnectionChange(d.OUTPUT,this,t,e,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a):(this.setDirtyCanvas(!1,!0),i&&this.graph.connectionChange(this,a),null)}},{key:"disconnectOutput",value:function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return d.debug&&console.log("Connect: Error, no slot of name ".concat(t)),!1}else if(!this.outputs||t>=this.outputs.length)return d.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[t];if(!n||!n.links||0==n.links.length)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var i=0,s=n.links.length;i<s;i++){var o=n.links[i];if((a=this.graph.links[o]).target_id==e.id){n.links.splice(i,1),(r=e.inputs[a.target_slot]).link=null,delete this.graph.links[o],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(d.INPUT,a.target_slot,!1,a,r),this.onConnectionsChange&&this.onConnectionsChange(d.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(d.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(d.OUTPUT,this,t),this.graph.onNodeConnectionChange(d.INPUT,e,a.target_slot));break}}}else{for(i=0,s=n.links.length;i<s;i++){var a;o=n.links[i];if(a=this.graph.links[o]){e=this.graph.getNodeById(a.target_id);var r=null;this.graph&&this.graph._version++,e&&((r=e.inputs[a.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(d.INPUT,a.target_slot,!1,a,r),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(d.INPUT,e,a.target_slot)),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(d.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(d.OUTPUT,this,t),this.graph.onNodeConnectionChange(d.INPUT,e,a.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}},{key:"disconnectInput",value:function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return d.debug&&console.log("Connect: Error, no slot of name ".concat(t)),!1}else if(!this.inputs||t>=this.inputs.length)return d.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var n=this.inputs[t].link;if(null!=n){this.inputs[t].link=null;var i=this.graph.links[n];if(i){var s=this.graph.getNodeById(i.origin_id);if(!s)return!1;var o=s.outputs[i.origin_slot];if(!o||!o.links||0==o.links.length)return!1;for(var a=0,r=o.links.length;a<r;a++)if(o.links[a]==n){o.links.splice(a,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(d.INPUT,t,!1,i,e),s.onConnectionsChange&&s.onConnectionsChange(d.OUTPUT,a,!1,i,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(d.OUTPUT,s,a),this.graph.onNodeConnectionChange(d.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}},{key:"getConnectionPos",value:function(t,e,n){n=n||new Float32Array(2);var i=0;t&&this.inputs&&(i=this.inputs.length),!t&&this.outputs&&(i=this.outputs.length);var s=.5*d.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var o=this._collapsed_width||d.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*o,n[1]=t?this.pos[1]-d.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=t?this.pos[0]:this.pos[0]+o,n[1]=this.pos[1]-.5*d.NODE_TITLE_HEIGHT),n}return t&&-1==e?(n[0]=this.pos[0]+.5*d.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*d.NODE_TITLE_HEIGHT,n):t&&i>e&&this.inputs[e].pos?(n[0]=this.pos[0]+this.inputs[e].pos[0],n[1]=this.pos[1]+this.inputs[e].pos[1],n):!t&&i>e&&this.outputs[e].pos?(n[0]=this.pos[0]+this.outputs[e].pos[0],n[1]=this.pos[1]+this.outputs[e].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(e+.5)*(this.size[0]/i),n[1]=t?this.pos[1]-d.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=t?this.pos[0]+s:this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(e+.7)*d.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)}},{key:"alignToGrid",value:function(){this.pos[0]=d.CANVAS_GRID_SIZE*Math.round(this.pos[0]/d.CANVAS_GRID_SIZE),this.pos[1]=d.CANVAS_GRID_SIZE*Math.round(this.pos[1]/d.CANVAS_GRID_SIZE)}},{key:"trace",value:function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>t.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)}},{key:"setDirtyCanvas",value:function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])}},{key:"loadImage",value:function(t){var e=this,n=new Image;return n.src=d.node_images_path+t,n.ready=!1,n.onload=function(){n.ready=!0,e.setDirtyCanvas(!0)},n}},{key:"captureInput",value:function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,n=0;n<e.length;++n){var i=e[n];(t||i.node_capturing_input==this)&&(i.node_capturing_input=t?this:null)}}},{key:"collapse",value:function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0))}},{key:"pin",value:function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t}},{key:"localToScreen",value:function(t,e,n){return[(t+this.pos[0])*n.scale+n.offset[0],(e+this.pos[1])*n.scale+n.offset[1]]}}],[{key:"createNode",value:function(t,e,n){var i=d.registered_node_types[t];if(!i)return d.debug&&console.log('GraphNode type "'.concat(t,'" not registered.')),null;i.prototype,e=e||i.title||t;var s=null;if(d.catch_exceptions)try{s=new i(e)}catch(t){return console.error(t),null}else s=new i(e);if(s.type=t,!s.title&&e&&(s.title=e),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=d.DEFAULT_POSITION.concat()),s.mode||(s.mode=d.ALWAYS),n)for(var o in n)s[o]=n[o];return s}},{key:"reloadNodes",value:function(t){var e,n=[],s=c(document.getElementsByTagName("script"));try{for(s.s();!(e=s.n()).done;){var o=e.value;n.push(o)}}catch(t){s.e(t)}finally{s.f()}var a=document.getElementsByTagName("head")[0];t=document.location.href+t;for(var r=0,l=n;r<l.length;r++){var h=l[r].src;if(h&&h.substr(0,t.length)===t)try{d.debug&&console.log("Reloading: ".concat(h));var u=document.createElement("script");u.type="text/javascript",u.src=h,a.appendChild(u),a.removeChild(n[i])}catch(t){if(d.throw_errors)throw t;d.debug&&console.log("Error while reloading ".concat(h))}}d.debug&&console.log("Nodes reloaded")}},{key:"addNodeMethod",value:function(e,n){for(var i in t.prototype[e]=n,d.registered_node_types){var s=d.registered_node_types[i];s.prototype[e]&&(s.prototype["_".concat(e)]=s.prototype[e]),s.prototype[e]=n}}},{key:"extendNode",value:function(e){var n,i=c(Object.getOwnPropertyNames(t.prototype));try{for(i.s();!(n=i.n()).done;){var s=n.value;e.prototype[s]||(e.prototype[s]=t.prototype[s])}}catch(t){i.e(t)}finally{i.f()}}}]),t}(),C=function(){function t(e){s(this,t),r(this,"isPointInside",x.prototype.isPointInside),r(this,"setDirtyCanvas",x.prototype.setDirtyCanvas),this._ctor(e)}return a(t,[{key:"_ctor",value:function(t){this.title=t||"Group",this.font_size=24,this.color="#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})}},{key:"recomputeInsideNodes",value:function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),n=0;n<t.length;++n){var i=t[n];i.getBounding(e),T(this._bounding,e)&&this._nodes.push(i)}}},{key:"move",value:function(t,e,n){if(this._pos[0]+=t,this._pos[1]+=e,!n)for(var i=0;i<this._nodes.length;++i){var s=this._nodes[i];s.pos[0]+=t,s.pos[1]+=e}}},{key:"serialize",value:function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}}},{key:"configure",value:function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font}}]),t}(),N=function(){function t(e,n){s(this,t),this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,n||this.bindEvents(e))}return a(t,[{key:"bindEvents",value:function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),t.addEventListener("mousedown",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)}},{key:"computeVisibleArea",value:function(){if(this.element){var t=this.element.width,e=this.element.height,n=-this.offset[0],i=-this.offset[1],s=n+t/this.scale,o=i+e/this.scale;this.visible_area[0]=n,this.visible_area[1]=i,this.visible_area[2]=s-n,this.visible_area[3]=o-i}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0}},{key:"onMouse",value:function(t){if(this.enabled){var e=this.element,n=e.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top;t.canvasx=i,t.canvasy=s,t.dragging=this.dragging;var o=!1;if(this.onmouse&&(o=this.onmouse(t)),"mousedown"===t.type)this.dragging=!0,e.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"===t.type){if(!o){var a=i-this.last_mouse[0],r=s-this.last_mouse[1];this.dragging&&this.mouseDrag(a,r)}}else"mouseup"===t.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback)):"mousewheel"!==t.type&&"wheel"!==t.type&&"DOMMouseScroll"!==t.type||(t.eventType="mousewheel","wheel"===t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.wheelDelta?t.delta=t.wheelDelta/40:t.deltaY?t.delta=-t.deltaY/3:t.delta=0,this.changeDeltaScale(1+.05*t.delta));return this.last_mouse[0]=i,this.last_mouse[1]=s,t.preventDefault(),t.stopPropagation(),!1}}},{key:"toCanvasContext",value:function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}},{key:"convertOffsetToCanvas",value:function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}},{key:"convertCanvasToOffset",value:function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e}},{key:"mouseDrag",value:function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)}},{key:"changeScale",value:function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!==this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){e=e||[.5*n.width,.5*n.height];var i=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(e),o=[s[0]-i[0],s[1]-i[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}}},{key:"changeDeltaScale",value:function(t,e){this.changeScale(this.scale*t,e)}},{key:"reset",value:function(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}]),t}();var O=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,t),this.options=n;var i=this;n.parentMenu&&(n.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),n.parentMenu=null):(this.parentMenu=n.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var o=null;n.event&&(o=n.event.constructor.name),"MouseEvent"!==o&&"CustomEvent"!==o&&"PointerEvent"!==o&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),n.event=null);var a=document.createElement("div");function r(t){var e=parseInt(a.style.top,10);return a.style.top="".concat((e+t.deltaY*n.scroll_speed).toFixed(),"px"),t.preventDefault(),!0}if(a.className="litegraph litecontextmenu litemenubar-panel",n.className&&(a.className+=" ".concat(n.className)),a.style.minWidth=100,a.style.minHeight=100,a.style.pointerEvents="none",setTimeout((function(){a.style.pointerEvents="auto"}),100),a.addEventListener("mouseup",(function(t){return t.preventDefault(),!0}),!0),a.addEventListener("contextmenu",(function(t){return 2!==t.button||t.preventDefault(),!1}),!0),a.addEventListener("mousedown",(function(t){if(2===t.button)return i.close(),t.preventDefault(),!0}),!0),n.scroll_speed||(n.scroll_speed=.1),a.addEventListener("wheel",r,!0),a.addEventListener("mousewheel",r,!0),this.root=a,n.title){var l=document.createElement("div");l.className="litemenu-title",l.innerHTML=n.title,a.appendChild(l)}for(var h=0;h<e.length;h++){var u=e.constructor===Array?e[h]:h;u&&u.constructor!==String&&(u=void 0===u.content?String(u):u.content);var c=e[h];this.addItem(u,c,n)}a.addEventListener("mouseleave",(function(t){i.lock||(a.closing_timer&&clearTimeout(a.closing_timer),a.closing_timer=setTimeout(i.close.bind(i,t),500))})),a.addEventListener("mouseenter",(function(t){a.closing_timer&&clearTimeout(a.closing_timer)}));var d=document;n.event&&(d=n.event.target.ownerDocument),d||(d=document),d.fullscreenElement?d.fullscreenElement.appendChild(a):d.body.appendChild(a);var p=n.left||0,g=n.top||0;if(n.event){if(p=n.event.clientX-10,g=n.event.clientY-10,n.title&&(g-=20),n.parentMenu){var v=n.parentMenu.root.getBoundingClientRect();p=v.left+v.width}var f=document.body.getBoundingClientRect(),_=a.getBoundingClientRect();0===f.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),f.width&&p>f.width-_.width-10&&(p=f.width-_.width-10),f.height&&g>f.height-_.height-10&&(g=f.height-_.height-10)}a.style.left="".concat(p,"px"),a.style.top="".concat(g,"px"),n.scale&&(a.style.transform="scale(".concat(n.scale,")"))}return a(t,[{key:"addItem",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this,s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;function a(t){var e=this.value;e&&e.has_submenu&&r.call(this,t)}function r(t){var e=this.value,s=!0;(i.current_submenu&&i.current_submenu.close(t),n.callback)&&(!0===n.callback.call(this,e,n,t,i,n.node)&&(s=!1));if(e){if(e.callback&&!n.ignore_item_callbacks&&!0!==e.disabled)!0===e.callback.call(this,e,n,t,i,n.extra)&&(s=!1);if(e.submenu){if(!e.submenu.options)throw new Error("ContextMenu submenu needs options");new i.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:i,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:n.autoopen}),s=!1}}s&&!i.lock&&i.close()}return null===e?s.classList.add("separator"):(s.innerHTML=e&&e.title?e.title:t,s.value=e,e&&(e.disabled&&(o=!0,s.classList.add("disabled")),(e.submenu||e.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof e?(s.dataset.value=t,s.onclick_callback=e):s.dataset.value=e,e.className&&(s.className+=" ".concat(e.className))),this.root.appendChild(s),o||s.addEventListener("click",r),n.autoopen&&s.addEventListener("mouseenter",a),s}},{key:"close",value:function(e,n){this.root.parentNode&&this.root.remove(),this.parentMenu&&!n&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!t.isCursorOverElement(e,this.parentMenu.root)&&t.trigger(this.parentMenu.root,"mouseleave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}},{key:"getTopMenu",value:function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}},{key:"getFirstEvent",value:function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}}],[{key:"trigger",value:function(t,e,n){var i=document.createEvent("CustomEvent");return i.initCustomEvent(e,!0,!0,n),t.dispatchEvent?t.dispatchEvent(i):t.__events&&t.__events.dispatchEvent(i),i}},{key:"closeAllContextMenus",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window,e=t.document.querySelectorAll(".litecontextmenu");if(e.length){var n,i=[],s=c(e);try{for(s.s();!(n=s.n()).done;){var o=n.value;i.push(o)}}catch(t){s.e(t)}finally{s.f()}for(var a=0,r=i;a<r.length;a++){var l=r[a];l.close?l.close():l.parentNode&&l.remove()}}}},{key:"isCursorOverElement",value:function(t,e){var n=t.clientX,i=t.clientY,s=e.getBoundingClientRect();return!!s&&(i>s.top&&i<s.top+s.height&&n>s.left&&n<s.left+s.width)}}]),t}(),S=new Float32Array(4),A=new Float32Array(2),I=new Float32Array(4),D=new Float32Array(4),L=new Float32Array(4),P=new Float32Array(2),M=new Float32Array(2),R=function(){function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};s(this,t),r(this,"showSearchBox",(function(e){var n=this,i=this,s=t.active_canvas,o=s.canvas,a=o.ownerDocument||document,r=document.createElement("div");r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",r.close=function(){n.search_box=null,a.body.focus(),a.body.style.overflow="",setTimeout((function(){n.canvas.focus()}),20),r.parentNode&&r.remove()};var l=null;this.ds.scale>1&&(r.style.transform="scale(".concat(this.ds.scale,")")),r.addEventListener("mouseenter",(function(){l&&(clearTimeout(l),l=null)})),r.addEventListener("mouseleave",(function(){l=setTimeout((function(){return r.close()}),500)})),this.search_box&&this.search_box.close(),this.search_box=r;var h=r.querySelector(".helper"),u=null,p=null,g=null,v=r.querySelector("input");v&&(v.addEventListener("blur",(function(){return v.focus()})),v.addEventListener("keydown",(function(t){if(38===t.keyCode)b(!1);else if(40===t.keyCode)b(!0);else if(27===t.keyCode)r.close();else{if(13!==t.keyCode)return p&&clearInterval(p),void(p=setTimeout(k,10));g?m(g.innerHTML):u?m(u):r.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0}))),a.fullscreenElement?a.fullscreenElement.appendChild(r):(a.body.appendChild(r),a.body.style.overflow="hidden");var f=o.getBoundingClientRect(),_=(e?e.clientX:f.left+.5*f.width)-80,y=(e?e.clientY:f.top+.5*f.height)-20;function m(t){if(t)if(i.onSearchBoxSelection)i.onSearchBoxSelection(t,e,s);else{var n=d.searchbox_extras[t.toLowerCase()];n&&(t=n.type),s.graph.beforeChange();var o=x.createNode(t);if(o&&(o.pos=s.convertEventToCanvasOffset(e),s.graph.add(o)),n&&n.data){if(n.data.properties)for(var a in n.data.properties)o.addProperty(a,n.data.properties[a]);if(n.data.inputs)for(var l in o.inputs=[],n.data.inputs)o.addOutput(n.data.inputs[l][0],n.data.inputs[l][1]);if(n.data.outputs)for(var h in o.outputs=[],n.data.outputs)o.addOutput(n.data.outputs[h][0],n.data.outputs[h][1]);n.data.title&&(o.title=n.data.title),n.data.json&&o.configure(n.data.json),s.graph.afterChange()}}r.close()}function b(t){var e=g;g&&g.classList.remove("selected"),g?(g=t?g.nextSibling:g.previousSibling)||(g=e):g=t?h.childNodes[0]:h.childNodes[h.childNodes.length],g&&(g.classList.add("selected"),g.scrollIntoView({block:"end",behavior:"smooth"}))}function k(){p=null;var e=v.value;if(u=null,h.innerHTML="",e)if(i.onSearchBox){var n=i.onSearchBox(h,e,s);if(n){var o,a=c(n);try{for(a.s();!(o=a.n()).done;){k(o.value)}}catch(t){a.e(t)}finally{a.f()}}}else{var r=0;e=e.toLowerCase();var l=s.filter||s.graph.filter;for(var g in d.searchbox_extras){var f=d.searchbox_extras[g];if(-1!==f.desc.toLowerCase().indexOf(e)){var _=d.registered_node_types[f.type];if((!_||_.filter===l)&&(k(f.desc,"searchbox_extra"),-1!==t.search_limit&&r++>t.search_limit))break}}var y,b=c(Object.keys(d.registered_node_types).filter((function(t){var n=d.registered_node_types[t];return(!l||n.filter===l)&&-1!==t.toLowerCase().indexOf(e)})));try{for(b.s();!(y=b.n()).done;){if(k(y.value),-1!==t.search_limit&&r++>t.search_limit)break}}catch(t){b.e(t)}finally{b.f()}}function k(t,e){var n=document.createElement("div");u||(u=t),n.innerText=t,n.dataset.type=escape(t),n.className="litegraph lite-search-item",e&&(n.className+=" ".concat(e)),n.addEventListener("click",(function(){m(unescape(n.dataset.type))})),h.appendChild(n)}}return r.style.left="".concat(_,"px"),r.style.top="".concat(y,"px"),e.layerY>f.height-200&&(h.style.maxHeight="".concat(f.height-e.layerY-20,"px")),v.focus(),r})),r(this,"showShowNodePanel",(function(t){window.SELECTED_NODE=t;var e=document.querySelector("#node-panel");e&&e.close();var n=this.getCanvasWindow();(e=this.createPanel(t.title||"",{closable:!0,window:n})).id="node-panel",e.node=t,e.classList.add("settings");var i=this;!function(){for(var n in e.content.innerHTML="",e.addHTML('<span class="node_type">'.concat(t.type,'</span><span class="node_desc">').concat(t.constructor.desc||"",'</span><span class="separator"></span>')),e.addHTML("<h3>Properties</h3>"),t.properties){var s=t.properties[n],o=t.getPropertyInfo(n);t.onAddPropertyToPanel&&t.onAddPropertyToPanel(n,e)||e.addWidget(o.widget||o.type,n,s,o,(function(e,n){i.graph.beforeChange(t),t.setProperty(e,n),i.graph.afterChange(),i.dirty_canvas=!0}))}e.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(e),e.addButton("Delete",(function(){t.block_delete||(t.graph.remove(t),e.close())})).classList.add("delete")}(),this.canvas.parentNode.appendChild(e)})),this.background_image=t.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new N,this.zoom_modify_alpha=!0,this.title_text_font="".concat(d.NODE_TEXT_SIZE,"px Arial"),this.inner_text_font="normal ".concat(d.NODE_SUBTEXT_SIZE,"px Arial"),this.node_title_color=d.NODE_TITLE_COLOR,this.default_link_color=d.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=d.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],n&&n.attachCanvas(this),this.setCanvas(e),this.clear(),i.skip_render||this.startRendering(),this.autoresize=i.autoresize}return a(t,[{key:"clear",value:function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()}},{key:"setGraph",value:function(t,e){this.graph!==t&&(e||this.clear(),t||!this.graph?(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))}},{key:"getTopGraph",value:function(){return this._graph_stack.length?this._graph_stack[0]:this.graph}},{key:"openSubgraph",value:function(t){if(!t)throw new Error("graph cannot be null");if(this.graph===t)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}},{key:"closeSubgraph",value:function(){if(this._graph_stack&&0!==this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t]))}}},{key:"getCurrentGraph",value:function(){return this.graph}},{key:"setCanvas",value:function(t,e){var n;if((null===(n=t)||void 0===n?void 0:n.constructor)===String&&!(t=document.getElementById(t)))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null===t.getContext){if("canvas"!==t.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a ".concat(t.localName));throw new Error("This browser doesn't support Canvas")}this.ctx=t.getContext("2d"),null==this.ctx&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e||this.bindEvents()}}},{key:"_doNothing",value:function(t){return t.preventDefault(),!1}},{key:"_doReturnTrue",value:function(t){return t.preventDefault(),!0}},{key:"bindEvents",value:function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),t.addEventListener("mousedown",this._mousedown_callback,!0),t.addEventListener("mousemove",this._mousemove_callback),t.addEventListener("mousewheel",this._mousewheel_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback),t.addEventListener("touchstart",this.touchHandler,!0),t.addEventListener("touchmove",this.touchHandler,!0),t.addEventListener("touchend",this.touchHandler,!0),t.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}}},{key:"unbindEvents",value:function(){if(this._events_binded){var t=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")}},{key:"enableWebGL",value:function(){if(!GL)throw new Error("litegl.js must be included to use a WebGL canvas");if(!enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.ctx=enableWebGLCanvas(this.canvas),this.gl=this.ctx,this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}},{key:"setDirty",value:function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)}},{key:"getCanvasWindow",value:function(){return this.canvas?this.canvas.ownerDocument.defaultView:window}},{key:"startRendering",value:function(){this.is_rendering||(this.is_rendering=!0,this.renderFrame())}},{key:"renderFrame",value:function(){var t=this;this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame((function(){return t.renderFrame()}))}},{key:"stopRendering",value:function(){this.is_rendering=!1}},{key:"blockClick",value:function(){this.block_click=!0,this.last_mouseclick=0}},{key:"processMouseDown",value:function(e){var n=this;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var i=this.getCanvasWindow();t.active_canvas=this,this.canvas.removeEventListener("mousemove",this._mousemove_callback),i.document.addEventListener("mousemove",this._mousemove_callback,!0),i.document.addEventListener("mouseup",this._mouseup_callback,!0);var s=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),o=!1,a=p()-this.last_mouseclick<300;if(this.mouse[0]=e.localX,this.mouse[1]=e.localY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.canvas.focus(),O.closeAllContextMenus(i),!this.onMouse||!this.onMouse(e)){if(1===e.which){e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,o=!0);var r=!1;if(s&&this.allow_interaction&&!o&&!this.read_only){if(this.live_mode||s.flags.pinned||this.bringToFront(s),!this.connecting_node&&!s.flags.collapsed&&!this.live_mode)if(!o&&s.resizable&&E(e.canvasX,e.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,1010))this.graph.beforeChange(),this.resizing_node=s,this.canvas.style.cursor="se-resize",o=!0;else{if(s.outputs)for(var l=0,h=s.outputs.length;l<h;l++){var u=s.outputs[l],g=s.getConnectionPos(!1,l);if(E(e.canvasX,e.canvasY,g[0]-15,g[1]-10,30,20)){this.connecting_node=s,this.connecting_output=u,this.connecting_pos=s.getConnectionPos(!1,l),this.connecting_slot=l,e.shiftKey&&s.disconnectOutput(l),a?s.onOutputDblClick&&s.onOutputDblClick(l,e):s.onOutputClick&&s.onOutputClick(l,e),o=!0;break}}if(s.inputs)for(var v=0,f=s.inputs.length;v<f;v++){var _=s.inputs[v],y=s.getConnectionPos(!0,v);if(E(e.canvasX,e.canvasY,y[0]-15,y[1]-10,30,20)&&(a?s.onInputDblClick&&s.onInputDblClick(v,e):s.onInputClick&&s.onInputClick(v,e),_.link)){var m=this.graph.links[_.link];s.disconnectInput(v),(this.allow_reconnect_links||e.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[m.origin_id],this.connecting_slot=m.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,o=!0}}}if(!o){var b=!1,T=[e.canvasX-s.pos[0],e.canvasY-s.pos[1]],w=this.processNodeWidgets(s,this.graph_mouse,e);w&&(b=!0,this.node_widget=[s,w]),a&&this.selected_nodes[s.id]&&(s.onDblClick&&s.onDblClick(e,T,this),this.processNodeDblClicked(s),b=!0),s.onMouseDown&&s.onMouseDown(e,T,this)?b=!0:(s.subgraph&&!s.skip_subgraph_button&&!s.flags.collapsed&&T[0]>s.size[0]-d.NODE_TITLE_HEIGHT&&T[1]<0&&setTimeout((function(){n.openSubgraph(s.subgraph)}),10),this.live_mode&&(r=!0,b=!0)),b||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=s),this.selected_nodes[s.id]||this.processNodeSelected(s,e)),this.dirty_canvas=!0}}else{if(!this.read_only){var x,C=c(this.visible_links);try{for(C.s();!(x=C.n()).done;){var N=x.value,S=N._pos;if(!(!S||e.canvasX<S[0]-4||e.canvasX>S[0]+4||e.canvasY<S[1]-4||e.canvasY>S[1]+4)){this.showLinkMenu(N,e),this.over_link_center=null;break}}}catch(t){C.e(t)}finally{C.f()}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)e.ctrlKey&&(this.dragging_rectangle=null),k([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();a&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(e),r=!0}!o&&r&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2===e.which||3===e.which&&(this.read_only||this.processContextMenu(s,e));return this.last_mouse[0]=e.localX,this.last_mouse[1]=e.localY,this.last_mouseclick=p(),this.last_mouse_dragging=!0,this.graph.change(),(!i.document.activeElement||"input"!==i.document.activeElement.nodeName.toLowerCase()&&"textarea"!==i.document.activeElement.nodeName.toLowerCase())&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},{key:"processMouseMove",value:function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){t.active_canvas=this,this.adjustMouseEvent(e);var n=[e.localX,e.localY];this.mouse[0]=n[0],this.mouse[1]=n[1];var i=[n[0]-this.last_mouse[0],n[1]-this.last_mouse[1]];if(this.last_mouse=n,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;if(e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var s=i[0]/this.ds.scale,o=i[1]/this.ds.scale;this.selected_group.move(s,o,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);var a,r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes),l=c(this.graph._nodes);try{for(l.s();!(a=l.n()).done;){var h=a.value;h.mouseOver&&r!==h&&(h.mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0)}}catch(t){l.e(t)}finally{l.f()}if(r){if(r.redraw_on_mouse&&(this.dirty_canvas=!0),r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(e)),r.onMouseMove&&r.onMouseMove(e,[e.canvasX-r.pos[0],e.canvasY-r.pos[1]],this),this.connecting_node){var u=this._highlight_input||[0,0];if(this.isOverNodeBox(r,e.canvasX,e.canvasY));else{var d=this.isOverNodeInput(r,e.canvasX,e.canvasY,u);if(-1!==d&&r.inputs[d]){var p=r.inputs[d].type;m(this.connecting_output.type,p)&&(this._highlight_input=u)}else this._highlight_input=null}}this.canvas&&(E(e.canvasX,e.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var g,v=null,f=c(this.visible_links);try{for(f.s();!(g=f.n()).done;){var _=g.value,y=_._pos;if(!(!y||e.canvasX<y[0]-4||e.canvasX>y[0]+4||e.canvasY<y[1]-4||e.canvasY>y[1]+4)){v=_;break}}}catch(t){f.e(t)}finally{f.f()}v!==this.over_link_center&&(this.over_link_center=v,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!==r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var b=0,k=Object.keys(this.selected_nodes);b<k.length;b++){var T=k[b],w=this.selected_nodes[T];w.pos[0]+=i[0]/this.ds.scale,w.pos[1]+=i[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var x=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],C=this.resizing_node.computeSize();x[0]=Math.max(C[0],x[0]),x[1]=Math.max(C[1],x[1]),this.resizing_node.setSize(x),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}}},{key:"processMouseUp",value:function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var n=this.getCanvasWindow().document;t.active_canvas=this,n.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),n.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(e);var i=p();if(e.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1===e.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var s=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(s,o,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var a=this.graph._nodes,r=new Float32Array(4);this.deselectAllNodes();var l=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),u=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-l:this.dragging_rectangle[0],g=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];this.dragging_rectangle[0]=u,this.dragging_rectangle[1]=g,this.dragging_rectangle[2]=l,this.dragging_rectangle[3]=h;var v,f=[],_=c(a);try{for(_.s();!(v=_.n()).done;){var y=v.value;y.getBounding(r),T(this.dragging_rectangle,r)&&f.push(y)}}catch(t){_.e(t)}finally{_.f()}f.length&&this.selectNodes(f)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var b=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(b)if(this.connecting_output.type===d.EVENT&&this.isOverNodeBox(b,e.canvasX,e.canvasY))this.connecting_node.connect(this.connecting_slot,b,d.EVENT);else{var k=this.isOverNodeInput(b,e.canvasX,e.canvasY);if(-1!==k)this.connecting_node.connect(this.connecting_slot,b,k);else{var w=b.getInputInfo(0);this.connecting_output.type===d.EVENT?this.connecting_node.connect(this.connecting_slot,b,d.EVENT):w&&!w.link&&m(w.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,b,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var x=this.node_dragged;x&&e.click_time<300&&E(e.canvasX,e.canvasY,x.pos[0],x.pos[1]-d.NODE_TITLE_HEIGHT,d.NODE_TITLE_HEIGHT,d.NODE_TITLE_HEIGHT)&&x.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{!this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else(2===e.which||3===e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}}},{key:"processMouseWheel",value:function(t){var e;if(this.graph&&this.allow_dragcanvas){var n=null!==(e=t.wheelDeltaY)&&void 0!==e?e:-60*t.detail;this.adjustMouseEvent(t);var i=this.ds.scale;return n>0?i*=1.1:n<0&&(i*=1/1.1),this.ds.changeScale(i,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}}},{key:"isOverNodeBox",value:function(t,e,n){var i=d.NODE_TITLE_HEIGHT;return!!E(e,n,t.pos[0]+2,t.pos[1]+2-i,i-4,i-4)}},{key:"isOverNodeInput",value:function(t,e,n,i){if(t.inputs)for(var s=0,o=t.inputs.length;s<o;++s){var a=t.getConnectionPos(!0,s);if(t.horizontal?E(e,n,a[0]-5,a[1]-10,10,20):E(e,n,a[0]-10,a[1]-5,40,10))return i&&(i[0]=a[0],i[1]=a[1]),s}return-1}},{key:"processKey",value:function(t){if(this.graph){var e=!1;if("input"!==t.target.localName){if("keydown"===t.type){if(32===t.keyCode&&(this.dragging_canvas=!0,e=!0),65===t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),"KeyC"!==t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),"KeyV"!==t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.pasteFromClipboard(),46!==t.keyCode&&8!==t.keyCode||"input"===t.target.localName||"textarea"===t.target.localName||(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}}},{key:"pasteFromClipboard",value:function(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();var e,n=JSON.parse(t),i=[],s=c(n.nodes);try{for(s.s();!(e=s.n()).done;){var o=e.value,a=x.createNode(o.type);a&&(a.configure(o),a.pos[0]+=5,a.pos[1]+=5,this.graph.add(a),i.push(a))}}catch(t){s.e(t)}finally{s.f()}var r,l=c(n.links);try{for(l.s();!(r=l.n()).done;){var h=r.value,u=i[h[0]],d=i[h[2]];u&&d?u.connect(h[1],d,h[3]):console.warn("Warning, nodes missing on pasting")}}catch(t){l.e(t)}finally{l.f()}this.selectNodes(i),this.graph.afterChange()}}},{key:"copyToClipboard",value:function(){var t={nodes:[],links:[]},e=0,n=[];for(var i in this.selected_nodes){var s=this.selected_nodes[i];s.relative_id=e,n.push(s),e+=1}for(var o=0,a=n;o<a.length;o++){var r=a[o],l=r.clone();if(l){if(t.nodes.push(l.serialize()),r.inputs&&r.inputs.length)for(var h=0;h<r.inputs.length;++h){var u=r.inputs[h];if(u&&null!=u.link){var c=this.graph.links[u.link];if(c){var d=this.graph.getNodeById(c.origin_id);d&&this.selected_nodes[d.id]&&t.links.push([d._relative_id,c.origin_slot,r._relative_id,c.target_slot])}}}}else console.warn("node type not found: ".concat(r.type))}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))}},{key:"processDrop",value:function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=[t.canvasX,t.canvasY],n=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(!n){var i=null;return this.onDropItem&&(i=this.onDropItem(t)),void(i||this.checkDropItem(t))}if(n.onDropFile||n.onDropData){var s=t.dataTransfer.files;if(s&&s.length){var o,a=c(s);try{var r=function(){var t=o.value,e=t.name;if(n.onDropFile&&n.onDropFile(t),n.onDropData){var i=new FileReader;i.onload=function(i){var s=i.target.result;n.onDropData(s,e,t)};var s=t.type.split("/")[0];"text"===s||""===s?i.readAsText(t):"image"===s?i.readAsDataURL(t):i.readAsArrayBuffer(t)}};for(a.s();!(o=a.n()).done;)r()}catch(t){a.e(t)}finally{a.f()}}}return!(!n.onDropItem||!n.onDropItem(t))||!!this.onDropItem&&this.onDropItem(t)}},{key:"checkDropItem",value:function(t){if(t.dataTransfer.files.length){var e=t.dataTransfer.files[0],n=function(t){var e=t.indexOf("?");-1!==e&&(t=t.substr(0,e));var n=t.lastIndexOf(".");return-1===n?"":t.substr(n+1).toLowerCase()}(e.name).toLowerCase(),i=d.node_types_by_file_extension[n];if(i){this.graph.beforeChange();var s=x.createNode(i.type);s.pos=[t.canvasX,t.canvasY],this.graph.add(s),s.onDropFile&&s.onDropFile(e),this.graph.afterChange()}}}},{key:"processNodeDblClicked",value:function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)}},{key:"processNodeSelected",value:function(t,e){this.selectNode(t,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(t)}},{key:"selectNode",value:function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)}},{key:"selectNodes",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.graph._nodes,e=arguments.length>1?arguments[1]:void 0;e||this.deselectAllNodes();var n,i=c(t);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(!s.is_selected){if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,this.selected_nodes[s.id]=s,s.inputs){var o,a=c(s.inputs);try{for(a.s();!(o=a.n()).done;){var r=o.value;this.highlighted_links[r.link]=!0}}catch(t){a.e(t)}finally{a.f()}}if(s.outputs){var l,h=c(s.outputs);try{for(h.s();!(l=h.n()).done;){var u=l.value;if(u.links){var d,p=c(u.links);try{for(p.s();!(d=p.n()).done;){var g=d.value;this.highlighted_links[g]=!0}}catch(t){p.e(t)}finally{p.f()}}}}catch(t){h.e(t)}finally{h.f()}}}}}catch(t){i.e(t)}finally{i.f()}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},{key:"deselectNode",value:function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs){var e,n=c(t.inputs);try{for(n.s();!(e=n.n()).done;){var i=e.value;delete this.highlighted_links[i.link]}}catch(t){n.e(t)}finally{n.f()}}if(t.outputs){var s,o=c(t.outputs);try{for(o.s();!(s=o.n()).done;){var a=s.value;if(a.links){var r,l=c(a.links);try{for(l.s();!(r=l.n()).done;){var h=r.value;delete this.highlighted_links[h]}}catch(t){l.e(t)}finally{l.f()}}}}catch(t){o.e(t)}finally{o.f()}}}}},{key:"deselectAllNodes",value:function(){if(this.graph){var t,e=c(this.graph._nodes);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.is_selected&&(n.onDeselected&&n.onDeselected(),n.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(n))}}catch(t){e.e(t)}finally{e.f()}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}}},{key:"deleteSelectedNodes",value:function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e=this.selected_nodes[t];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&m(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var n=e.graph.links[e.inputs[0].link],i=e.graph.links[e.outputs[0].links[0]],s=e.getInputNode(0),o=e.getOutputNodes(0)[0];s&&o&&s.connect(n.origin_slot,o,i.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}},{key:"centerOnNode",value:function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}},{key:"adjustMouseEvent",value:function(t){if(this.canvas){var e=this.canvas.getBoundingClientRect();t.localX=t.clientX-e.left,t.localY=t.clientY-e.top}else t.localX=t.clientX,t.localY=t.clientY;t.deltaX=t.localX-this.last_mouse_position[0],t.deltaY=t.localY-this.last_mouse_position[1],this.last_mouse_position[0]=t.localX,this.last_mouse_position[1]=t.localY,t.canvasX=t.localX/this.ds.scale-this.ds.offset[0],t.canvasY=t.localY/this.ds.scale-this.ds.offset[1]}},{key:"setZoom",value:function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}},{key:"convertOffsetToCanvas",value:function(t){return this.ds.convertOffsetToCanvas(t)}},{key:"convertCanvasToOffset",value:function(t,e){return this.ds.convertCanvasToOffset(t,e)}},{key:"convertEventToCanvasOffset",value:function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])}},{key:"bringToFront",value:function(t){var e=this.graph._nodes.indexOf(t);-1!==e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))}},{key:"sendToBack",value:function(t){var e=this.graph._nodes.indexOf(t);-1!==e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))}},{key:"computeVisibleNodes",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=e;t=this.graph._nodes,n.length=0;var i,s=c(t);try{for(s.s();!(i=s.n()).done;){var o=i.value;(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(T(this.visible_area,o.getBounding(S))&&n.push(o))}}catch(t){s.e(t)}finally{s.f()}return n}},{key:"draw",value:function(t,e){if(this.canvas&&0!==this.canvas.width&&0!==this.canvas.height){var n=p();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}}},{key:"drawFrontCanvas",value:function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){t.start2D&&t.start2D();var e=this.canvas;if(t.restore(),t.setTransform(1,0,0,1,0,0),this.dirty_area&&(t.save(),t.beginPath(),t.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),t.clip()),this.clear_background&&t.clearRect(0,0,e.width,e.height),this.bgcanvas===this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t),this.graph){t.save(),this.ds.toCanvasContext(t);var n,i=c(this.computeVisibleNodes(null,this.visible_nodes));try{for(i.s();!(n=i.n()).done;){var s=n.value;t.save(),t.translate(s.pos[0],s.pos[1]),this.drawNode(s,t),1,t.restore()}}catch(t){i.e(t)}finally{i.f()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&!this.live_mode&&this.drawConnections(t),this.connecting_pos){t.lineWidth=this.connections_width;var o=null;switch(this.connecting_output.type){case d.EVENT:o=d.EVENT_LINK_COLOR;break;default:o=d.CONNECTING_LINK_COLOR}this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,this.connecting_output.dir||(this.connecting_node.horizontal?d.DOWN:d.RIGHT),d.CENTER),t.beginPath(),this.connecting_output.type===d.EVENT||this.connecting_output.shape===d.BOX_SHAPE?t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),this.dirty_area&&t.restore(),t.finish2D&&t.finish2D()}}},{key:"drawSubgraphPanel",value:function(t){var e=this.graph,n=e._subgraph_node;if(n){var i=n.inputs?n.inputs.length:0,s=300,o=Math.floor(1.6*d.NODE_SLOT_HEIGHT);if(t.fillStyle="#111",t.globalAlpha=.8,t.beginPath(),t.roundRect(10,10,s,(i+1)*o+50,8),t.fill(),t.globalAlpha=1,t.fillStyle="#888",t.font="14px Arial",t.textAlign="left",t.fillText("Graph Inputs",20,34),this.drawButton(280,20,20,20,"X","#151515"))this.closeSubgraph();else{var a=50;if(t.font="20px Arial",n.inputs){var r,l=c(n.inputs);try{for(l.s();!(r=l.n()).done;){var h=r.value;if(!h.not_subgraph_input){if(this.drawButton(20,a+2,280,o-2)){var u=n.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=createNode(u);p?(e.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",h.name),p.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",u)}t.fillStyle="#9C9",t.beginPath(),t.arc(284,a+.5*o,5,0,2*Math.PI),t.fill(),t.fillStyle="#AAA",t.fillText(h.name,50,a+.75*o);var g=t.measureText(h.name);t.fillStyle="#777",t.fillText(h.type,50+g.width+10,a+.75*o),a+=o}}}catch(t){l.e(t)}finally{l.f()}}this.drawButton(20,a+2,280,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(n)}}else console.warn("subgraph without subnode")}},{key:"drawButton",value:function(t,e,n,i,s){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:d.NODE_DEFAULT_COLOR,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"#555",r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:d.NODE_TEXT_COLOR,l=this.ctx,h=this.mouse,u=E(h[0],h[1],t,e,n,i),c=(h=this.last_click_position)&&E(h[0],h[1],t,e,n,i);return l.fillStyle=u?a:o,c&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(t,e,n,i,4),l.fill(),s&&s.constructor===String&&(l.fillStyle=r,l.textAlign="center",l.font="".concat(.65*i|0,"px Arial"),l.fillText(s,t+.5*n,e+.75*i),l.textAlign="left"),c&&this.blockClick(),c&&!this.block_click}},{key:"isAreaClicked",value:function(t,e,n,i,s){var o=this.last_click_position,a=o&&E(o[0],o[1],t,e,n,i);return a&&s&&this.blockClick(),a&&!this.block_click}},{key:"renderInfo",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.canvas.height-80;t.save(),t.translate(e,n),t.font="10px Arial",t.fillStyle="#888",this.graph?(t.fillText("T: ".concat(this.graph.globaltime.toFixed(2),"s"),5,13),t.fillText("I: ".concat(this.graph.iteration),5,26),t.fillText("N: ".concat(this.graph._nodes.length," [").concat(this.visible_nodes.length,"]"),5,39),t.fillText("V: ".concat(this.graph._version),5,52),t.fillText("FPS:".concat(this.fps.toFixed(2)),5,65)):t.fillText("No graph selected",5,13),t.restore()}},{key:"drawBackCanvas",value:function(){var t=this,e=this.bgcanvas;e.width===this.canvas.width&&e.height===this.canvas.height||(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var n=this.bgctx;if(n.start&&n.start(),this.clear_background&&n.clearRect(0,0,e.width,e.height),this._graph_stack&&this._graph_stack.length){n.save();var i=this.graph._subgraph_node;n.strokeStyle=i.bgcolor,n.lineWidth=10,n.strokeRect(1,1,e.width-2,e.height-2),n.lineWidth=1,n.font="40px Arial",n.textAlign="center",n.fillStyle=i.bgcolor||"#AAA";var s,o="",a=c(this._graph_stack);try{for(a.s();!(s=a.n()).done;){var r=s.value;o+="".concat(r._subgraph_node.getTitle()," >> ")}}catch(t){a.e(t)}finally{a.f()}n.fillText(o+i.getTitle(),.5*e.width,40),n.restore()}var l=!1;if(this.onRenderBackground&&(l=this.onRenderBackground(e,n)),n.restore(),n.setTransform(1,0,0,1,0,0),this.visible_links.length=0,this.graph){if(n.save(),this.ds.toCanvasContext(n),this.background_image&&this.ds.scale>.5&&!l){n.globalAlpha=this.zoom_modify_alpha?(1-.5/this.ds.scale)*this.editor_alpha:this.editor_alpha,n.imageSmoothingEnabled=!1,n.mozImageSmoothingEnabled=!1,n.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.id===this.background_image||(this._bg_img=new Image,this._bg_img.id=this.background_image,this._bg_img.src=this.background_image,this._bg_img.onload=function(){return t.draw(!0,!0)});var h=null;null==this._pattern&&this._bg_img.width>0?(h=n.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=h):h=this._pattern,h&&(n.fillStyle=h,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),n.fillStyle="transparent"),n.globalAlpha=1,n.imageSmoothingEnabled=!0,n.mozImageSmoothingEnabled=!0,n.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,n),this.onDrawBackground&&this.onDrawBackground(n,this.visible_area),this.render_canvas_border&&(n.strokeStyle="#235",n.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(n.shadowColor="#000",n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=6):n.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(n),n.shadowColor="rgba(0,0,0,0)",n.restore()}n.finish&&n.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}},{key:"drawNode",value:function(t,e){this.current_node=t;var n=t.color||t.constructor.color||d.NODE_DEFAULT_COLOR,i=t.bgcolor||t.constructor.bgcolor||d.NODE_DEFAULT_BGCOLOR;t.mouseOver;var s=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else if(e.globalAlpha=this.editor_alpha,this.render_shadows&&!s?(e.shadowColor=d.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var o=t._shape||d.BOX_SHAPE,a=A;A.set(t.size);var r=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var l=t.getTitle?t.getTitle():t.title;l&&(t._collapsed_width=Math.min(t.size[0],e.measureText(l).width+2*d.NODE_TITLE_HEIGHT),a[0]=t._collapsed_width,a[1]=0)}t.clip_area&&(e.save(),e.beginPath(),o===d.BOX_SHAPE?e.rect(0,0,a[0],a[1]):o===d.ROUND_SHAPE?e.roundRect(0,0,a[0],a[1],10):o===d.CIRCLE_SHAPE&&e.arc(.5*a[0],.5*a[1],.5*a[0],0,2*Math.PI),e.clip()),t.has_errors&&(i="red"),this.drawNodeShape(t,e,a,n,i,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=r?"center":"left",e.font=this.inner_text_font;var h=!s,u=this.connecting_output;e.lineWidth=1;var p=0,g=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var v,f=null,_=null;if(t.inputs){var y,b=c(t.inputs);try{for(b.s();!(y=b.n()).done;){var k=y.value;if(null!=k.link){f=k,v=k;break}}}catch(t){b.e(t)}finally{b.f()}}if(t.outputs){var E,T=c(t.outputs);try{for(T.s();!(E=T.n()).done;){var w=E.value;w.links&&w.links.length&&(_=w,v=w)}}catch(t){T.e(t)}finally{T.f()}}if(f){var x=0,C=-.5*d.NODE_TITLE_HEIGHT;r&&(x=.5*t._collapsed_width,C=-d.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),v.type===d.EVENT||v.shape===d.BOX_SHAPE?e.rect(x-7+.5,C-4,14,8):v.shape===d.ARROW_SHAPE?(e.moveTo(x+8,C),e.lineTo(x+-4,C-4),e.lineTo(x+-4,C+4),e.closePath()):e.arc(x,C,4,0,2*Math.PI),e.fill()}if(_){var N=t._collapsed_width,O=-.5*d.NODE_TITLE_HEIGHT;r&&(N=.5*t._collapsed_width,O=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),v.type===d.EVENT||v.shape===d.BOX_SHAPE?e.rect(N-7+.5,O-4,14,8):slot.shape===d.ARROW_SHAPE?(e.moveTo(N+6,O),e.lineTo(N-6,O-4),e.lineTo(N-6,O+4),e.closePath()):e.arc(N,O,4,0,2*Math.PI),e.fill()}}}else{if(t.inputs)for(var S=0;S<t.inputs.length;S++){var I=t.inputs[S];e.globalAlpha=this.editor_alpha,this.connecting_node&&!m(I.type,u.type)&&(e.globalAlpha=.4*this.editor_alpha),e.fillStyle=I.link?I.color_on||this.default_connection_color.input_on:I.color_off||this.default_connection_color.input_off;var D=t.getConnectionPos(!0,S,g);if(D[0]-=t.pos[0],D[1]-=t.pos[1],p<D[1]+.5*d.NODE_SLOT_HEIGHT&&(p=D[1]+.5*d.NODE_SLOT_HEIGHT),e.beginPath(),I.type===d.EVENT||I.shape===d.BOX_SHAPE?r?e.rect(D[0]-5+.5,D[1]-8+.5,10,14):e.rect(D[0]-6+.5,D[1]-5+.5,14,10):I.shape===d.ARROW_SHAPE?(e.moveTo(D[0]+8,D[1]+.5),e.lineTo(D[0]-4,D[1]+6+.5),e.lineTo(D[0]-4,D[1]-6+.5),e.closePath()):s?e.rect(D[0]-4,D[1]-4,8,8):e.arc(D[0],D[1],4,0,2*Math.PI),e.fill(),h){var L=I.label?I.label:I.name;L&&(e.fillStyle=d.NODE_TEXT_COLOR,r||I.dir===d.UP?e.fillText(L,D[0],D[1]-10):e.fillText(L,D[0]+10,D[1]+5))}}if(this.connecting_node&&(e.globalAlpha=.4*this.editor_alpha),e.textAlign=r?"center":"right",e.strokeStyle="black",t.outputs)for(var P=0;P<t.outputs.length;P++){var M=t.outputs[P],R=t.getConnectionPos(!1,P,g);if(R[0]-=t.pos[0],R[1]-=t.pos[1],p<R[1]+.5*d.NODE_SLOT_HEIGHT&&(p=R[1]+.5*d.NODE_SLOT_HEIGHT),e.fillStyle=M.links&&M.links.length?M.color_on||this.default_connection_color.output_on:M.color_off||this.default_connection_color.output_off,e.beginPath(),M.type===d.EVENT||M.shape===d.BOX_SHAPE?r?e.rect(R[0]-5+.5,R[1]-8+.5,10,14):e.rect(R[0]-6+.5,R[1]-5+.5,14,10):M.shape===d.ARROW_SHAPE?(e.moveTo(R[0]+8,R[1]+.5),e.lineTo(R[0]-4,R[1]+6+.5),e.lineTo(R[0]-4,R[1]-6+.5),e.closePath()):s?e.rect(R[0]-4,R[1]-4,8,8):e.arc(R[0],R[1],4,0,2*Math.PI),e.fill(),s||e.stroke(),h){var H=null!=M.label?M.label:M.name;H&&(e.fillStyle=d.NODE_TEXT_COLOR,r||M.dir===d.DOWN?e.fillText(H,R[0],R[1]-8):e.fillText(H,R[0]-10,R[1]+5))}}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var z=p;(r||t.widgets_up)&&(z=2),t.widgets_start_y&&(z=t.widgets_start_y),this.drawNodeWidgets(t,z,e,this.node_widget&&this.node_widget[0]===t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}}},{key:"drawLinkTooltip",value:function(t,e){var n=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(n[0],n[1],3,0,2*Math.PI),t.fill(),!(null==e.data||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,e,this))){var i,s=e.data;if(i=s.constructor===Number?s.toFixed(2):s.constructor===String?'"'.concat(s,'"'):s.constructor===Boolean?String(s):s.toToolTip?s.toToolTip():"[".concat(s.constructor.name,"]")){i=i.substr(0,30),t.font="14px Courier New";var o=t.measureText(i).width+20;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-.5*o,n[1]-15-24,o,24,3,3),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(i,n[0],n[1]-15-24*.3)}}}},{key:"drawNodeShape",value:function(e,n,i,s,o,a,r){n.strokeStyle=s,n.fillStyle=o;var l=d.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,u=e._shape||e.constructor.shape||d.ROUND_SHAPE,c=e.constructor.title_mode,p=!0;c===d.TRANSPARENT_TITLE?p=!1:c===d.AUTOHIDE_TITLE&&r&&(p=!0);var g=I;g[0]=0,g[1]=p?-l:0,g[2]=i[0]+1,g[3]=p?i[1]+l:i[1];var v=n.globalAlpha;if(n.beginPath(),u===d.BOX_SHAPE||h?n.fillRect(g[0],g[1],g[2],g[3]):u===d.ROUND_SHAPE||u===d.CARD_SHAPE?n.roundRect(g[0],g[1],g[2],g[3],this.round_radius,u===d.CARD_SHAPE?0:this.round_radius):u===d.CIRCLE_SHAPE&&n.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),n.fill(),e.flags.collapsed||(n.shadowColor="transparent",n.fillStyle="rgba(0,0,0,0.2)",n.fillRect(0,-1,g[2],2)),n.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(n,this,this.canvas,this.graph_mouse),p||c===d.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(n,l,i,this.ds.scale,s);else if(c!==d.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var f=e.constructor.title_color||s;if(e.flags.collapsed&&(n.shadowColor=d.DEFAULT_SHADOW_COLOR),this.use_gradients){var _=t.gradients[f];_||(_=n.createLinearGradient(0,0,400,0),t.gradients[f]=_,_.addColorStop(0,f),_.addColorStop(1,"#000")),n.fillStyle=_}else n.fillStyle=f;n.beginPath(),u===d.BOX_SHAPE||h?n.rect(0,-l,i[0]+1,l):u!==d.ROUND_SHAPE&&u!==d.CARD_SHAPE||n.roundRect(0,-l,i[0]+1,l,this.round_radius,e.flags.collapsed?this.round_radius:0),n.fill(),n.shadowColor="transparent"}var y=10;if(e.onDrawTitleBox?e.onDrawTitleBox(n,l,i,this.ds.scale):[d.ROUND_SHAPE,d.CIRCLE_SHAPE,d.CARD_SHAPE].includes(u)?(h&&(n.fillStyle="black",n.beginPath(),n.arc(.5*l,-.5*l,6,0,2*Math.PI),n.fill()),n.fillStyle=e.boxcolor||d.NODE_DEFAULT_BOXCOLOR,h?n.fillRect(.5*l-5,-.5*l-5,y,y):(n.beginPath(),n.arc(.5*l,-.5*l,5,0,2*Math.PI),n.fill())):(h&&(n.fillStyle="black",n.fillRect(.5*(l-y)-1,-.5*(l+y)-1,12,12)),n.fillStyle=e.boxcolor||d.NODE_DEFAULT_BOXCOLOR,n.fillRect(.5*(l-y),-.5*(l+y),y,y)),n.globalAlpha=v,e.onDrawTitleText&&e.onDrawTitleText(n,l,i,this.ds.scale,this.title_text_font,a),!h){n.font=this.title_text_font;var m=String(e.getTitle());m&&(n.fillStyle=a?d.NODE_SELECTED_TITLE_COLOR:e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(n.textAlign="left",n.measureText(m),n.fillText(m.substr(0,20),l,d.NODE_TITLE_TEXT_Y-l),n.textAlign="left"):(n.textAlign="left",n.fillText(m,l,d.NODE_TITLE_TEXT_Y-l)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var b=d.NODE_TITLE_HEIGHT,k=e.size[0]-b,T=E(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],k+2,2-b,b-4,b-4);n.fillStyle=T?"#888":"#555",u===d.BOX_SHAPE||h?n.fillRect(k+2,2-b,b-4,b-4):(n.beginPath(),n.roundRect(k+2,2-b,b-4,b-4,4),n.fill()),n.fillStyle="#333",n.beginPath(),n.moveTo(k+.2*b,.6*-b),n.lineTo(k+.8*b,.6*-b),n.lineTo(k+.5*b,.3*-b),n.fill()}e.onDrawTitle&&e.onDrawTitle(n)}a&&(e.onBounding&&e.onBounding(g),c===d.TRANSPARENT_TITLE&&(g[1]-=l,g[3]+=l),n.lineWidth=1,n.globalAlpha=.8,n.beginPath(),u===d.BOX_SHAPE?n.rect(-6+g[0],-6+g[1],12+g[2],12+g[3]):u===d.ROUND_SHAPE||u===d.CARD_SHAPE&&e.flags.collapsed?n.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius):u===d.CARD_SHAPE?n.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius,2):u===d.CIRCLE_SHAPE&&n.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),n.strokeStyle=d.NODE_BOX_OUTLINE_COLOR,n.stroke(),n.strokeStyle=s,n.globalAlpha=1)}},{key:"drawConnections",value:function(t){var e=p(),n=this.visible_area;D[0]=n[0]-20,D[1]=n[1]-20,D[2]=n[2]+40,D[3]=n[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;var i,s=c(this.graph._nodes);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.inputs&&o.inputs.length)for(var a=0;a<o.inputs.length;++a){var r=o.inputs[a];if(r&&null!=r.link){var l=r.link,h=this.graph.links[l];if(h){var u=this.graph.getNodeById(h.origin_id);if(u){var g=h.origin_slot,v=null;v=-1===g?[u.pos[0]+10,u.pos[1]+10]:u.getConnectionPos(!1,g,P);var f=o.getConnectionPos(!0,a,M);if(L[0]=v[0],L[1]=v[1],L[2]=f[0]-v[0],L[3]=f[1]-v[1],L[2]<0&&(L[0]+=L[2],L[2]=Math.abs(L[2])),L[3]<0&&(L[1]+=L[3],L[3]=Math.abs(L[3])),T(L,D)){var _=u.outputs[g],y=o.inputs[a];if(_&&y){var m=_.dir||(u.horizontal?d.DOWN:d.RIGHT),b=y.dir||(o.horizontal?d.UP:d.LEFT);if(this.renderLink(t,v,f,h,!1,0,null,m,b),h&&h._last_time&&e-h._last_time<1e3){var k=2-.002*(e-h._last_time),E=t.globalAlpha;t.globalAlpha=E*k,this.renderLink(t,v,f,h,!0,k,"white",m,b),t.globalAlpha=E}}}}}}}}}catch(t){s.e(t)}finally{s.f()}t.globalAlpha=1}},{key:"renderLink",value:function(e,n,i,s,o,a,r,l,h,u){s&&this.visible_links.push(s),!r&&s&&(r=s.color||t.link_type_colors[s.type]),r||(r=this.default_link_color),null!=s&&this.highlighted_links[s.id]&&(r="#FFF"),l=l||d.RIGHT,h=h||d.LEFT;var c=k(n,i);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",(u=u||1)>1&&(e.lineWidth=.5),e.beginPath();for(var g=0;g<u;g+=1){var v=5*(g-.5*(u-1));if(this.links_render_mode===d.SPLINE_LINK){e.moveTo(n[0],n[1]+v);var f=0,_=0,y=0,m=0;switch(l){case d.LEFT:f=-.25*c;break;case d.RIGHT:f=.25*c;break;case d.UP:_=-.25*c;break;case d.DOWN:_=.25*c}switch(h){case d.LEFT:y=-.25*c;break;case d.RIGHT:y=.25*c;break;case d.UP:m=-.25*c;break;case d.DOWN:m=.25*c}e.bezierCurveTo(n[0]+f,n[1]+_+v,i[0]+y,i[1]+m+v,i[0],i[1]+v)}else if(this.links_render_mode===d.LINEAR_LINK){e.moveTo(n[0],n[1]+v);var b=0,E=0,T=0,w=0;switch(l){case d.LEFT:b=-1;break;case d.RIGHT:b=1;break;case d.UP:E=-1;break;case d.DOWN:E=1}switch(h){case d.LEFT:T=-1;break;case d.RIGHT:T=1;break;case d.UP:w=-1;break;case d.DOWN:w=1}e.lineTo(n[0]+15*b,n[1]+15*E+v),e.lineTo(i[0]+15*T,i[1]+15*w+v),e.lineTo(i[0],i[1]+v)}else{if(this.links_render_mode!==d.STRAIGHT_LINK)return;e.moveTo(n[0],n[1]);var x=n[0],C=n[1],N=i[0],O=i[1];l===d.RIGHT?x+=10:C+=10,h===d.LEFT?N-=10:O-=10,e.lineTo(x,C),e.lineTo(.5*(x+N),C),e.lineTo(.5*(x+N),O),e.lineTo(N,O),e.lineTo(i[0],i[1])}}this.render_connections_border&&this.ds.scale>.6&&!o&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=r,e.strokeStyle=r,e.stroke();var S=this.computeConnectionPoint(n,i,.5,l,h);if(s&&s._pos&&(s._pos[0]=S[0],s._pos[1]=S[1]),this.ds.scale>=.6&&this.highquality_render&&h!==d.CENTER){if(this.render_connection_arrows){var A=this.computeConnectionPoint(n,i,.25,l,h),I=this.computeConnectionPoint(n,i,.26,l,h),D=this.computeConnectionPoint(n,i,.75,l,h),L=this.computeConnectionPoint(n,i,.76,l,h),P=0,M=0;this.render_curved_connections?(P=-Math.atan2(I[0]-A[0],I[1]-A[1]),M=-Math.atan2(L[0]-D[0],L[1]-D[1])):M=P=i[1]>n[1]?0:Math.PI,e.save(),e.translate(A[0],A[1]),e.rotate(P),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(D[0],D[1]),e.rotate(M),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(S[0],S[1],5,0,2*Math.PI),e.fill()}if(a){e.fillStyle=r;for(var R=0;R<5;++R){var H=(.001*p()+.2*R)%1,z=this.computeConnectionPoint(n,i,H,l,h);e.beginPath(),e.arc(z[0],z[1],5,0,2*Math.PI),e.fill()}}}},{key:"computeConnectionPoint",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.RIGHT,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.LEFT,o=k(t,e),a=t,r=[t[0],t[1]],l=[e[0],e[1]],h=e;switch(i){case d.LEFT:r[0]+=-.25*o;break;case d.RIGHT:r[0]+=.25*o;break;case d.UP:r[1]+=-.25*o;break;case d.DOWN:r[1]+=.25*o}switch(s){case d.LEFT:l[0]+=-.25*o;break;case d.RIGHT:l[0]+=.25*o;break;case d.UP:l[1]+=-.25*o;break;case d.DOWN:l[1]+=.25*o}var u=(1-n)*(1-n)*(1-n),c=(1-n)*(1-n)*3*n,p=3*(1-n)*(n*n),g=n*n*n,v=u*a[0]+c*r[0]+p*l[0]+g*h[0],f=u*a[1]+c*r[1]+p*l[1]+g*h[1];return[v,f]}},{key:"drawExecutionOrder",value:function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;var e,n=c(this.visible_nodes);try{for(n.s();!(e=n.n()).done;){var i=e.value;t.fillStyle="black",t.fillRect(i.pos[0]-d.NODE_TITLE_HEIGHT,i.pos[1]-d.NODE_TITLE_HEIGHT,d.NODE_TITLE_HEIGHT,d.NODE_TITLE_HEIGHT),0===i.order&&t.strokeRect(i.pos[0]-d.NODE_TITLE_HEIGHT+.5,i.pos[1]-d.NODE_TITLE_HEIGHT+.5,d.NODE_TITLE_HEIGHT,d.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(i.order,i.pos[0]+-.5*d.NODE_TITLE_HEIGHT,i.pos[1]-6)}}catch(t){n.e(t)}finally{n.f()}t.globalAlpha=1}},{key:"drawNodeWidgets",value:function(t,e,n,i){if(!t.widgets||!t.widgets.length)return 0;var s=t.size[0],o=t.widgets;e+=2;var a=d.NODE_WIDGET_HEIGHT,r=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;var l,h=d.WIDGET_OUTLINE_COLOR,u=d.WIDGET_BGCOLOR,p=d.WIDGET_TEXT_COLOR,g=d.WIDGET_SECONDARY_TEXT_COLOR,v=15,f=c(o);try{for(f.s();!(l=f.n()).done;){var _=l.value,y=e;_.y&&(y=_.y),_.last_y=y,n.strokeStyle=h,n.fillStyle="#222",n.textAlign="left",_.disabled&&(n.globalAlpha*=.5);var m=_.width||s;switch(_.type){case"button":_.clicked&&(n.fillStyle="#AAA",_.clicked=!1,this.dirty_canvas=!0),n.fillRect(v,y,m-30,a),r&&!_.disabled&&n.strokeRect(v,y,m-30,a),r&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.name,.5*m,y+.7*a));break;case"toggle":n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),r?n.roundRect(v,e,m-30,a,.5*a):n.rect(v,e,m-30,a),n.fill(),r&&!_.disabled&&n.stroke(),n.fillStyle=_.value?"#89A":"#333",n.beginPath(),n.arc(m-30,y+.5*a,.36*a,0,2*Math.PI),n.fill(),r&&(n.fillStyle=g,_.name&&n.fillText(_.name,30,y+.7*a),n.fillStyle=_.value?p:g,n.textAlign="right",n.fillText(_.value?_.options.on||"true":_.options.off||"false",m-40,y+.7*a));break;case"slider":n.fillStyle=u,n.fillRect(v,y,m-30,a);var b=_.options.max-_.options.min,k=(_.value-_.options.min)/b;if(n.fillStyle=i===_?"#89A":"#678",n.fillRect(v,y,k*(m-30),a),r&&!_.disabled&&n.strokeRect(v,y,m-30,a),_.marker){var E=(_.marker-_.options.min)/b;n.fillStyle="#AA9",n.fillRect(v+E*(m-30),y,2,a)}r&&(n.textAlign="center",n.fillStyle=p,n.fillText("".concat(_.name,"  ").concat(Number(_.value).toFixed(3)),.5*m,y+.7*a));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),r?n.roundRect(v,e,m-30,a,.5*a):n.rect(v,e,m-30,a),n.fill(),r)if(_.disabled||n.stroke(),n.fillStyle=p,_.disabled||(n.beginPath(),n.moveTo(31,e+5),n.lineTo(21,e+.5*a),n.lineTo(31,e+a-5),n.fill(),n.beginPath(),n.moveTo(m-v-16,e+5),n.lineTo(m-v-6,e+.5*a),n.lineTo(m-v-16,e+a-5),n.fill()),n.fillStyle=g,n.fillText(_.name,35,y+.7*a),n.fillStyle=p,n.textAlign="right","number"===_.type)n.fillText(Number(_.value).toFixed(_.options.precision?_.options.precision:3),m-30-20,y+.7*a);else{var T=_.value;if(_.options.values){var w=_.options.values;w.constructor===Function&&(w=w()),w&&w.constructor!==Array&&(T=w[_.value])}n.fillText(T,m-30-20,y+.7*a)}break;case"string":case"text":n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),r?n.roundRect(v,e,m-30,a,.5*a):n.rect(v,e,m-30,a),n.fill(),r&&(_.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(v,e,m-30,a),n.clip(),n.fillStyle=g,_.name&&n.fillText(_.name,30,y+.7*a),n.fillStyle=p,n.textAlign="right",n.fillText(String(_.value).substr(0,30),m-30,y+.7*a),n.restore());break;default:_.draw&&_.draw(n,t,m,y,a)}e+=(_.computeSize?_.computeSize(m)[1]:a)+4,n.globalAlpha=this.editor_alpha}}catch(t){f.e(t)}finally{f.f()}n.restore(),n.textAlign="left"}},{key:"processNodeWidgets",value:function(t,e,i,s){var o=this;if(!t.widgets||!t.widgets.length)return null;var a,r=e[0]-t.pos[0],l=e[1]-t.pos[1],h=t.size[0],u=this.getCanvasWindow(),p=c(t.widgets);try{var g=function(){var n=a.value;if(!n||n.disabled)return"continue";var c=n.computeSize?n.computeSize(h)[1]:d.NODE_WIDGET_HEIGHT,p=n.width||h;if(n!==s&&(r<6||r>p-12||l<n.last_y||l>n.last_y+c))return"continue";var g=n.value;switch(n.type){case"button":if("mousemove"===i.type)break;n.callback&&setTimeout((function(){return n.callback(n,o,t,e,i)}),20),n.clicked=!0,o.dirty_canvas=!0;break;case"slider":n.options.max,n.options.min;var v=w((r-15)/(p-30),0,1);n.value=n.options.min+(n.options.max-n.options.min)*v,n.callback&&setTimeout((function(){return _(n,n.value)}),20),o.dirty_canvas=!0;break;case"number":case"combo":var y=n.value;if("mousemove"===i.type&&"number"===n.type)n.value+=.1*i.deltaX*(n.options.step||1),n.options.min&&n.value<n.options.min&&(n.value=n.options.min),n.options.max&&n.value>n.options.max&&(n.value=n.options.max);else if("mousedown"===i.type){var m=n.options.values;m&&m.constructor===Function&&(m=n.options.values(n,t));var b=[];"number"!==n.type&&(b=m.constructor===Array?m:Object.keys(m));var k=r<40?-1:r>p-40?1:0;if("number"===n.type)n.value+=.1*k*(n.options.step||1),null!=n.options.min&&n.value<n.options.min&&(n.value=n.options.min),null!=n.options.max&&n.value>n.options.max&&(n.value=n.options.max);else if(k){var E=-1;o.last_mouseclick=0,(E=m.constructor===Object?b.indexOf(String(n.value))+k:b.indexOf(n.value)+k)>=b.length&&(E=b.length-1),E<0&&(E=0),m.constructor===Array?n.value=m[E]:n.value=E}else{var T=m!==b?Object.values(m):m;new O(T,{scale:Math.max(1,o.ds.scale),event:i,className:"dark",callback:function(t,e,n){return m!=b&&(t=T.indexOf(t)),this.value=t,_(this,t),f.dirty_canvas=!0,!1}.bind(n)},u)}}else if("mouseup"===i.type&&"number"===n.type){var x=r<40?-1:r>p-40?1:0;i.click_time<200&&0==x&&o.prompt("Value",n.value,(function(t){n.value=Number(t),_(n,n.value)}),i)}y!==n.value&&setTimeout((function(){_(o,o.value)}),20),o.dirty_canvas=!0;break;case"toggle":"mousedown"===i.type&&(n.value=!n.value,setTimeout((function(){_(n,n.value)}),20));break;case"string":case"text":"mousedown"===i.type&&o.prompt("Value",n.value,(function(t){n.value=t,_(n,t)}),i,!!n.options&&n.options.multiline);break;default:n.mouse&&(o.dirty_canvas=n.mouse(i,[r,l],t))}return g!==n.value&&(t.onWidgetChanged&&t.onWidgetChanged(n.name,n.value,g,n),t.graph._version++),{v:n}};for(p.s();!(a=p.n()).done;){var v=g();if("continue"!==v&&"object"===n(v))return v.v}}catch(t){p.e(t)}finally{p.f()}var f=this;function _(n,s){n.value=s,n.options&&n.options.property&&t.properties[n.options.property]&&t.setProperty(n.options.property,s),n.callback&&n.callback(n.value,f,t,e,i)}return null}},{key:"drawGroups",value:function(t,e){if(this.graph){var n=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;var i,s=c(n);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(T(this.visible_area,o._bounding)){e.fillStyle=o.color||"#335",e.strokeStyle=o.color||"#335";var a=o._pos,r=o._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(a[0]+.5,a[1]+.5,r[0],r[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(a[0]+r[0],a[1]+r[1]),e.lineTo(a[0]+r[0]-10,a[1]+r[1]),e.lineTo(a[0]+r[0],a[1]+r[1]-10),e.fill();var l=o.font_size||d.DEFAULT_GROUP_FONT_SIZE;e.font="".concat(l,"px Arial"),e.fillText(o.title,a[0]+4,a[1]+l)}}}catch(t){s.e(t)}finally{s.f()}e.restore()}}},{key:"adjustNodesSize",value:function(){var t,e=c(this.graph._nodes);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.size=n.computeSize()}}catch(t){e.e(t)}finally{e.f()}this.setDirty(!0,!0)}},{key:"resize",value:function(t,e){if(!t&&!e){var n=this.canvas.parentNode;t=n.offsetWidth,e=n.offsetHeight}this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}},{key:"switchLiveMode",value:function(t){var e=this;if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){e.editor_alpha*=n,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,n<1&&e.editor_alpha<.01&&(clearInterval(i),n<1&&(e.live_mode=!0)),n>1&&e.editor_alpha>.99&&(clearInterval(i),e.editor_alpha=1)}),1)}},{key:"onNodeSelectionChange",value:function(t){}},{key:"touchHandler",value:function(t){var e=t.changedTouches[0],n="";switch(t.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=this.getCanvasWindow(),s=i.document.createEvent("MouseEvent");s.initMouseEvent(n,!0,!0,i,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(s),t.preventDefault()}},{key:"showLinkMenu",value:function(e,n){var i=this,s=new O(["Add Node",null,"Delete"],{event:n,title:null!=e.data?e.data.constructor.name:null,callback:function(n,o,a){switch(n){case"Add Node":t.onMenuAdd(null,null,a,s,(function(t){console.log("node autoconnect");var n=i.graph.getNodeById(e.origin_id),s=i.graph.getNodeById(e.target_id);t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&n.outputs[e.origin_slot].type===t.inputs[0].type&&t.outputs[0].type===s.inputs[0].type&&(n.connect(e.origin_slot,t,0),t.connect(0,s,e.target_slot),t.pos[0]-=.5*t.size[0])}));break;case"Delete":i.graph.removeLink(e.id)}}});return!1}},{key:"prompt",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1?arguments[1]:void 0,s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,r=!1,l=document.createElement("div");l.className="graphdialog rounded",l.innerHTML=a?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",l.close=function(){e.prompt_box=null,l.parentNode&&l.remove()},this.ds.scale>1&&(l.style.transform="scale(".concat(this.ds.scale,")")),l.addEventListener("mouseleave",(function(t){r||l.close()})),this.prompt_box&&this.prompt_box.close(),this.prompt_box=l;var h=l.querySelector(".name");h.innerText=n;var u=l.querySelector(".value");u.value=i;var c=u;c.addEventListener("keydown",(function(t){if(r=!0,27===t.keyCode)l.close();else{if(13!==t.keyCode||"textarea"===t.target.localName)return;s&&s(c.value),l.close()}t.preventDefault(),t.stopPropagation()}));var d=l.querySelector("button");d.addEventListener("click",(function(){s&&s(c.value),e.setDirty(!0),l.close()}));var p=t.active_canvas,g=p.canvas,v=g.getBoundingClientRect(),f=-20,_=-20;return v&&(f-=v.left,_-=v.top),o?(l.style.left="".concat(o.clientX+f,"px"),l.style.top="".concat(o.clientY+_,"px")):(l.style.left="".concat(.5*g.width+f,"px"),l.style.top="".concat(.5*g.height+_,"px")),g.parentNode.appendChild(l),setTimeout((function(){return c.focus()}),10),l}},{key:"showEditPropertyValue",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(t&&void 0!==t.properties[e]){var i=t.getPropertyInfo(e),s=i.type,o="";if(["sring","number","array","object"].includes(s))o="<input autofocus type='text' class='value'/>";else if(["enum","combo"].includes(s)&&i.values){for(var a in o="<select autofocus type='text' class='value'>",i.values){var r=a;i.values.constructor===Array&&(r=i.values[a]),o+='<option value="'.concat(r,'" ').concat(r==t.properties[e]?"selected":"",">").concat(i.values[a],"</option>")}o+="</select>"}else{if("boolean"!==s)return void console.warn("unknown type: ".concat(s));o='<input autofocus type="checkbox" class="value" '.concat(t.properties[e]?"checked":"","/>")}var l=this.createDialog('<span class="name">'.concat(i.label?i.label:e,"</span>").concat(o,"<button>OK</button>"),n);if(["enum","combo"].includes(s)&&i.values){var h=l.querySelector("select");h.addEventListener("change",(function(t){g(t.target.value)}))}else if("boolean"===s){var u=l.querySelector("input");u&&u.addEventListener("click",(function(){return g(!!u.checked)}))}else{var c=l.querySelector("input");if(c){c.addEventListener("blur",(function(){c.focus()}));var d=t.properties[e]?t.properties[e]:"";"string"!==s&&(d=JSON.stringify(d)),c.value=d,c.addEventListener("keydown",(function(t){13==t.keyCode&&(g(c.value),t.preventDefault(),t.stopPropagation())}))}}var p=l.querySelector("button");return p.addEventListener("click",(function(){return g(input.value)})),l}function g(o){i&&i.values&&i.values.constructor===Object&&i.values[o]&&(o=i.values[o]),"number"==typeof t.properties[e]&&(o=Number(o)),["array","object"].includes(s)&&(o=JSON.parse(o)),t.properties[e]=o,t.graph&&t.graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,o),n.onclose&&n.onclose(),l.close(),t.setDirtyCanvas(!0,!0)}}},{key:"createDialog",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=document.createElement("div");n.className="graphdialog",n.innerHTML=t;var i=this.canvas.getBoundingClientRect(),s=-20,o=-20;return i&&(s-=i.left,o-=i.top),e.position?(s+=e.position[0],o+=e.position[1]):e.event?(s+=e.event.clientX,o+=e.event.clientY):(s+=.5*this.canvas.width,o+=.5*this.canvas.height),n.style.left="".concat(s,"px"),n.style.top="".concat(o,"px"),this.canvas.parentNode.appendChild(n),n.close=function(){n.parentNode&&n.remove()},n}},{key:"createPanel",value:function(e){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=i.window||window,o=document.createElement("div");if(o.className="litegraph dialog",o.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div class='dialog-footer'></div>",o.header=o.querySelector(".dialog-header"),i.width&&(o.style.width=i.width+(i.width.constructor===Number?"px":"")),i.height&&(o.style.height=i.height+(i.height.constructor===Number?"px":"")),i.closable){var a=document.createElement("span");a.innerHTML="&#10005;",a.classList.add("close"),a.addEventListener("click",(function(){return o.close()})),o.header.appendChild(a)}return o.title_element=o.querySelector(".dialog-title"),o.title_element.innerText=e,o.content=o.querySelector(".dialog-content"),o.footer=o.querySelector(".dialog-footer"),o.close=function(){return o.remove()},o.clear=function(){return o.content.innerHTML=""},o.addHTML=function(t,e,n){var i=document.createElement("div");return e&&(i.className=e),i.innerHTML=t,n?o.footer.appendChild(i):o.content.appendChild(i),i},o.addButton=function(t,e,n){var i=document.createElement("button");return i.innerText=t,i.options=n,i.classList.add("btn"),i.addEventListener("click",e),o.footer.appendChild(i),i},o.addSeparator=function(){var t=document.createElement("div");t.className="separator",o.content.appendChild(t)},o.addWidget=function(e,i,a){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},l=arguments.length>4?arguments[4]:void 0;e=e.toLowerCase(),a=String(a);var h="number"===e?new Number(a).toFixed(3):a.toString(),u=document.createElement("div");u.className="property",u.innerHTML="<span class='property_name'></span><span class='property_value'></span>",u.querySelector(".property_name").innerText=i;var c=u.querySelector(".property_value");function d(t,e){console.log("change",t,e),r.callback&&r.callback(t,e),l&&l(t,e)}return c.innerText=h,u.dataset.property=i,u.dataset.type=r.type||e,u.options=r,u.value=h,"boolean"===e?(u.classList.add("boolean"),a&&u.classList.add("bool-on"),u.addEventListener("click",(function(){var t=u.dataset.property;n.value=!u.value,n.classList.toggle("bool-on"),n.querySelector(".property_value").innerText=u.value?"true":"false",d(t,u.value)}))):["string","number"].includes(e)?(c.setAttribute("contenteditable",!0),c.addEventListener("keydown",(function(t){"Enter"===t.code&&(t.preventDefault(),c.blur())})),c.addEventListener("blur",(function(){var t=c.innerText,e=c.parentNode.dataset.property;"number"===c.parentNode.dataset.type&&(t=Number(t)),d(e,t)}))):["enum","combo"].includes(e)&&(h=t.getPropertyPrintableValue(a,r.values)),c.innerText=h,c.addEventListener("click",(function(t){var e=r.values||[],i=c.parentNode.dataset.property;new O(e,{event:t,className:"dark",callback:function(t,e,s){return n.innerText=t,d(i,t),!1}},s)})),o.content.appendChild(u),u},o}},{key:"showSubgraphPropertiesDialog",value:function(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function s(){if(n.clear(),t.inputs){var e,o=c(t.inputs);try{var a=function(){var o=e.value;if(o.not_subgraph_input)return"continue";var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=o.name,a.dataset.slot=i,a.querySelector(".name").innerText=o.name,a.querySelector(".type").innerText=o.type,a.querySelector("button").addEventListener("click",(function(){t.removeInput(Number(a.parentNode.dataset.slot)),s()}))};for(o.s();!(e=o.n()).done;)a()}catch(t){o.e(t)}finally{o.f()}}}n.node=t,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'/><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(e){var n=this.parentNode,i=n.querySelector(".name").value,o=n.querySelector(".type").value;i&&-1===t.findInputSlot(i)&&(t.addInput(i,o),n.querySelector(".name").value="",n.querySelector(".type").value="",s())})),s(),this.canvas.parentNode.appendChild(n),n}},{key:"checkPanels",value:function(){if(this.canvas){var t,e=c(this.canvas.parentNode.querySelectorAll(".litegraph.dialog"));try{for(e.s();!(t=e.n()).done;){var n=t.value;n.node&&(n.node.graph&&n.graph===this.graph||n.close())}}catch(t){e.e(t)}finally{e.f()}}}},{key:"getCanvasMenuOptions",value:function(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:t.onMenuAdd},{content:"Add Group",callback:t.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var n=this.getExtraMenuOptions(this,e);n&&(e=e.concat(n))}return e}},{key:"getNodeMenuOptions",value:function(e){var n=null;if(n=e.getMenuOptions?e.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:t.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:t.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:t.onShowMenuNodeProperties},null,{content:"Title",callback:t.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:t.onMenuNodeMode},{content:"Resize",callback:function(){if(e.resizable)return t.onResizeNode}},{content:"Collapse",callback:t.onMenuNodeCollapse},{content:"Pin",callback:t.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:t.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:t.onMenuNodeShapes},null],e.onGetInputs){var i=e.onGetInputs();i&&i.length&&(n[0].disabled=!1)}if(e.onGetOutputs){var s=e.onGetOutputs();s&&s.length&&(n[1].disabled=!1)}if(e.getExtraMenuOptions){var o=e.getExtraMenuOptions(this,n);o&&(o.push(null),n=o.concat(n))}return e.clonable&&n.push({content:"Clone",callback:t.onMenuNodeClone}),n.push(null,{content:"Remove",disabled:!(!1!==e.removable&&!e.block_delete),callback:t.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(n,e),n}},{key:"getGroupMenuOptions",value:function(){return[{content:"Title",callback:t.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:t.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:t.onShowPropertyEditor},null,{content:"Remove",callback:t.onMenuNodeRemove}]}},{key:"processContextMenu",value:function(e,n){var i=this,s=t.active_canvas.getCanvasWindow(),o=null,a={event:n,callback:function(t,n,s){if(!t)return;if("Remove Slot"===t.content){var o=t.slot;o.input?e.removeInput(o.slot):o.output&&e.removeOutput(o.slot)}else if("Disconnect Links"===t.content){var a=t.slot;a.output?e.disconnectOutput(a.slot):a.input&&e.disconnectInput(a.slot)}else if("Rename Slot"===t.content){var r=t.slot,l=r.input?e.getInputInfo(r.slot):e.getOutputInfo(r.slot),h=i.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",n),u=h.querySelector("input");u&&l&&(u.value=l.label||""),h.querySelector("button").addEventListener("click",(function(){u.value&&(l&&(l.label=u.value),i.setDirty(!0)),h.close()}))}},extra:e};e&&(a.title=e.type);var r=null;if(e&&(r=e.getSlotInPosition(n.canvasX,n.canvasY),t.active_node=e),r){if(o=[],e.getSlotMenuOptions)o=e.getSlotMenuOptions(r);else{r&&r.output&&r.output.links&&r.output.links.length&&o.push({content:"Disconnect Links",slot:r});var l=r.input||r.output;o.push(l.locked?"Cannot remove":{content:"Remove Slot",slot:r}),o.push(l.nameLocked?"Cannot rename":{content:"Rename Slot",slot:r})}a.title=(r.input?r.input.type:r.output.type)||"*",r.input&&r.input.type===d.ACTION&&(a.title="Action"),r.output&&r.output.type===d.EVENT&&(a.title="Event")}else if(e)o=this.getNodeMenuOptions(e);else{o=this.getCanvasMenuOptions();var h=this.graph.getGroupOnPos(n.canvasX,n.canvasY);h&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:h,options:this.getGroupMenuOptions(h)}})}o&&new O(o,a,s)}}],[{key:"onGroupAdd",value:function(e,n,i){var s=t.active_canvas,o=new C;o.pos=s.convertEventToCanvasOffset(i),s.graph.add(o)}},{key:"onMenuAdd",value:function(e,n,i,s,o){var a=t.active_canvas,r=a.getCanvasWindow(),l=a.graph;if(l)return function t(e,n){var s=_(a.filter||l.filter).filter((function(t){return t.startsWith(e)})),h=[];s.forEach((function(n){if(n){var i=new RegExp("^(".concat(e,")")),s=n.replace(i,"").split("/")[0],o="".concat(""===e?s:e+s,"/"),a=s;-1!=a.indexOf("::")&&(a=a.split("::")[1]),-1===h.findIndex((function(t){return t.value===o}))&&h.push({value:o,content:a,has_submenu:!0,callback:function(e,n,i,s){t(e.value,s)}})}})),f(e.slice(0,-1),a.filter||l.filter).forEach((function(t){if(!t.skip_list){var e={value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,n,i){var s=i.getFirstEvent();a.graph.beforeChange();var r=x.createNode(t.value);r&&(r.pos=a.convertEventToCanvasOffset(s),a.graph.add(r)),o&&o(r),a.graph.afterChange()}};h.push(e)}})),new O(h,{event:i,parentMenu:n},r)}("",s),!1}},{key:"onMenuCollapseAll",value:function(){}},{key:"onMenuNodeEdit",value:function(){}},{key:"showMenuNodeOptionalInputs",value:function(e,n,i,s,o){if(o){var a=this,r=t.active_canvas.getCanvasWindow(),l=o.optional_inputs;o.onGetInputs&&(l=o.onGetInputs());var h=[];if(l){var u,p=c(l);try{for(p.s();!(u=p.n()).done;){var g=u.value;if(g){var v=g[0];g[2]&&g[2].label&&(v=g[2].label);var f={content:v,value:g};g[1]===d.ACTION&&(f.className="event"),h.push(f)}else h.push(null)}}catch(t){p.e(t)}finally{p.f()}}if(this.onMenuNodeInputs&&(h=this.onMenuNodeInputs(h)),h.length)return new O(h,{event:i,callback:function(t,e,n){if(!o)return;t.callback&&t.callback.call(a,o,t,e,n);t.value&&(o.graph.beforeChange(),o.addInput(t.value[0],t.value[1],t.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange())},parentMenu:s,node:o},r),!1;console.log("no input entries")}}},{key:"showMenuNodeOptionalOutputs",value:function(e,n,i,s,o){if(o){var a=this,r=t.active_canvas.getCanvasWindow(),l=o.optional_outputs;o.onGetOutputs&&(l=o.onGetOutputs());var h=[];if(l){var u,p=c(l);try{for(p.s();!(u=p.n()).done;){var g=u.value;if(g){if(!o.flags||!o.flags.skip_repeated_outputs||-1===o.findOutputSlot(g[0])){var v=g[0];g[2]&&g[2].label&&(v=g[2].label);var f={content:v,value:g};g[1]===d.EVENT&&(f.className="event"),h.push(f)}}else h.push(null)}}catch(t){p.e(t)}finally{p.f()}}if(this.onMenuNodeOutputs&&(h=this.onMenuNodeOutputs(h)),h.length)return new O(h,{event:i,callback:function t(e,n,i){if(!o)return;e.callback&&e.callback.call(a,o,e,n,i);if(!e.value)return;var r=e.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var l=[];for(var h in r)l.push({content:h,value:r[h]});return new O(l,{event:n,callback:t,parentMenu:s,node:o}),!1}o.graph.beforeChange(),o.addOutput(e.value[0],e.value[1],e.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange()},parentMenu:s,node:o},r),!1}}},{key:"onShowMenuNodeProperties",value:function(e,i,s,o,a){if(a&&a.properties){var r=t.active_canvas,l=r.getCanvasWindow(),h=[];for(var u in a.properties){var c=a.properties[u]?a.properties[u]:" ";"object"===n(c)&&(c=JSON.stringify(c));var d=a.getPropertyInfo(u);"enum"!=d.type&&"combo"!=d.type||(c=t.getPropertyPrintableValue(c,d.values)),c=t.decodeHTML(c),h.push({content:'<span class="property_name">'.concat(d.label?d.label:u,"</span>")+'<span class="property_value">'.concat(c,"</span>"),value:u})}if(h.length)return new O(h,{event:s,callback:function(t){if(!a)return;var e=this.getBoundingClientRect();r.showEditPropertyValue(a,t.value,{position:[e.left,e.top]})},parentMenu:o,allow_html:!0,node:a},l),!1}}},{key:"decodeHTML",value:function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML}},{key:"onResizeNode",value:function(t,e,n,i,s){s&&(s.size=s.computeSize(),s.onResize&&s.onResize(s.size),s.setDirtyCanvas(!0,!0))}},{key:"onShowPropertyEditor",value:function(e,n,i,s,o){var a=e.property||"title",r=o[a],l=document.createElement("div");l.className="graphdialog",l.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",l.querySelector(".name").innerText=a;var h=l.querySelector(".value");h&&(h.value=r,h.addEventListener("blur",(function(t){h.focus()})),h.addEventListener("keydown",(function(t){13!==t.keyCode&&"textarea"!==t.target.localName||(g(h.value),t.preventDefault(),t.stopPropagation())})));var u=t.active_canvas.canvas,c=u.getBoundingClientRect(),d=-20,p=-20;function g(t){"Number"===e.type?t=Number(t):"Boolean"===e.type&&(t=Boolean(t)),o[a]=t,l.parentNode&&l.remove(),o.setDirtyCanvas(!0,!0)}c&&(d-=c.left,p-=c.top),i?(l.style.left="".concat(i.clientX+d,"px"),l.style.top="".concat(i.clientY+p,"px")):(l.style.left="".concat(.5*u.width+d,"px"),l.style.top="".concat(.5*u.height+p,"px")),l.querySelector("button").addEventListener("click",(function(){return g(h.value)})),u.parentNode.appendChild(l)}},{key:"getPropertyPrintableValue",value:function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var n="";for(var i in e)if(e[i]===t){n=i;break}return"".concat(String(t)," (").concat(n,")")}}},{key:"onMenuNodeCollapse",value:function(t,e,n,i,s){s.graph.beforeChange(s),s.collapse(),s.graph.afterChange(s)}},{key:"onMenuNodePin",value:function(t,e,n,i,s){s.pin()}},{key:"onMenuNodeColors",value:function(e,n,i,s,o){if(!o)throw new Error("no node for color");var a=[];for(var r in a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),t.node_colors){var l=t.node_colors[r];a.push({value:r,content:'<span style="display: block; color: #999; padding-left: 4px; border-left: 8px solid '.concat(l.color,"; background-color:").concat(l.bgcolor,'">').concat(r,"</span>")})}return new O(a,{event:i,callback:function(e){if(o){var n=e.value?t.node_colors[e.value]:null;n?"LGraphGroup"===o.constructor.name?o.color=n.groupcolor:(o.color=n.color,o.bgcolor=n.bgcolor):(delete o.color,delete o.bgcolor),o.setDirtyCanvas(!0,!0)}},parentMenu:s,node:o}),!1}},{key:"onMenuNodeShapes",value:function(t,e,n,i,s){if(!s)throw new Error("no node passed");return new O(d.VALID_SHAPES,{event:n,callback:function(t){s&&(s.graph.beforeChange(s),s.shape=t,s.graph.afterChange(s),s.setDirtyCanvas(!0))}},{parentMenu:i,node:s}),!1}},{key:"onMenuNodeRemove",value:function(t,e,n,i,s){if(!s)throw new Error("no node passed");if(!1!==s.removable){var o=s.graph;o.beforeChange(),o.remove(s),o.afterChange(),s.setDirtyCanvas(!0,!0)}}},{key:"onMenuNodeToSubgraph",value:function(e,n,i,s,o){var a=o.graph,r=t.active_canvas;if(r){var l=Object.values(r.selected_nodes||{});l.length||(l=[o]);var h=x.createNode("graph/subgraph");h.pos=o.pos.concat(),a.add(h),h.buildFromNodes(l),r.deselectAllNodes(),o.setDirtyCanvas(!0,!0)}}},{key:"onMenuNodeClone",value:function(t,e,n,i,s){if(!1!==s.clonable){var o=s.clone();o&&(o.pos=[s.pos[0]+5,s.pos[1]+5],s.graph.beforeChange(),s.graph.add(o),s.graph.afterChange(),s.setDirtyCanvas(!0,!0))}}}]),t}();r(R,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),r(R,"link_type_colors",{"-1":d.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),r(R,"gradients",{}),r(R,"search_limit",-1),r(R,"onMenuNodeMode",(function(t,e,n,i,s){return new O(["Always","On Event","On Trigger","Never"],{event:n,callback:function(t){if(s)switch(t){case"On Event":s.mode=d.ON_EVENT;break;case"On Trigger":s.mode=d.ON_TRIGGER;break;case"Never":s.mode=d.NEVER;break;case"Always":default:s.mode=d.ALWAYS}},parentMenu:i,node:s}),!1})),r(R,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});var H=function(){function t(e){s(this,t),r(this,"STATUS_STOPPED",1),r(this,"STATUS_RUNNING",2),r(this,"supportedTypes",["number","string","boolean"]),d.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}return a(t,[{key:"getSupportedTypes",value:function(){return this.supportedTypes||t.supportedTypes}},{key:"clear",value:function(){if(this.stop(),this.status=this.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes){var t,e=c(this._nodes);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.onRemoved&&n.onRemoved()}}catch(t){e.e(t)}finally{e.f()}}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}},{key:"attachCanvas",value:function(t){if(t.constructor!==R)throw new Error("attachCanvas expects a LGraphCanvas instance");t.graph&&t.graph!==this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}},{key:"detachCanvas",value:function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!==e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}}},{key:"start",value:function(e){if(this.status!==t.STATUS_RUNNING){this.status=t.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=p(),this.last_update_time=this.starttime;var n=this;if(0===(e=e||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function t(){-1===n.execution_timer_id&&(window.requestAnimationFrame(t),n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep())}()}else this.execution_timer_id=setInterval((function(){n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep()}),e)}}},{key:"stop",value:function(){this.status!==t.STATUS_STOPPED&&(this.status=t.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id&&(-1!==this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}},{key:"runStep",value:function(t,e,n){t=t||1;var i=p();this.globaltime=.001*(i-this.starttime);var s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(n=n||s.length,e){for(var o=0;o<t;o++){for(var a=0;a<n;a++){var r=s[a];r.mode===d.ALWAYS&&r.onExecute&&r.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var l=0;l<t;l++){for(var h=0;h<n;++h){var u=s[h];u.mode===d.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,d.throw_errors)throw t;d.debug&&console.log("Error during execution: ".concat(t)),this.stop()}var c=p(),g=c-i;0===g&&(g=1),this.execution_time=.001*g,this.globaltime+=.001*g,this.iteration+=1,this.elapsed_time=.001*(c-this.last_update_time),this.last_update_time=c}}},{key:"updateExecutionOrder",value:function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];var t,e=c(this._nodes_in_order);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.onExecute&&this._nodes_executable.push(n)}}catch(t){e.e(t)}finally{e.f()}}},{key:"computeExecutionOrder",value:function(t,e){var n,i=[],s=[],o={},a={},r={},l=c(this._nodes);try{for(l.s();!(n=l.n()).done;){var h=n.value;if(!t||h.onExecute){o[h.id]=h;var u=0;if(h.inputs)for(var p=0,g=h.inputs.length;p<g;p++)h.inputs[p]&&null!=h.inputs[p].link&&(u+=1);0===u?(s.push(h),e&&(h._level=1)):(e&&(h._level=0),r[h.id]=u)}}}catch(t){l.e(t)}finally{l.f()}for(;0!==s.length;){var v=s.shift();if(i.push(v),delete o[v.id],v.outputs){var f,_=c(v.outputs);try{for(_.s();!(f=_.n()).done;){var y=f.value;if(null!=y&&null!=y.links&&0!==y.links.length){var m,b=c(y.links);try{for(b.s();!(m=b.n()).done;){var k=m.value,E=this.links[k];if(E&&!a[E.id]){var T=this.getNodeById(E.target_id);null!=T?(e&&(!T._level||T._level<=v._level)&&(T._level=v._level+1),a[E.id]=!0,r[T.id]-=1,0===r[T.id]&&s.push(T)):a[E.id]=!0}}}catch(t){b.e(t)}finally{b.f()}}}}catch(t){_.e(t)}finally{_.f()}}}for(var w in o)i.push(o[w]);i.length!==this._nodes.length&&d.debug&&console.warn("something went wrong, nodes missing");for(var x=i.length,C=0;C<x;C++)i[C].order=C;i=i.sort((function(t,e){var n=t.constructor.priority||t.priority||0,i=e.constructor.priority||e.priority||0;return n===i?t.order-e.order:n-i}));for(var N=0;N<x;++N)i[N].order=N;return i}},{key:"getAncestors",value:function(t){for(var e=[],n=[t],i={};n.length;){var s=n.shift();if(s.inputs){i[s.id]||s===t||(i[s.id]=!0,e.push(s));for(var o=0;o<s.inputs.length;++o){var a=s.getInputNode(o);a&&-1===e.indexOf(a)&&n.push(a)}}}return e.sort((function(t,e){return t.order-e.order})),e}},{key:"arrange",value:function(t){t=t||100;var e,n=[],i=c(this.computeExecutionOrder(!1,!0));try{for(i.s();!(e=i.n()).done;){var s=e.value,o=s._level||1;n[o]||(n[o]=[]),n[o].push(s)}}catch(t){i.e(t)}finally{i.f()}for(var a=t,r=0,l=n;r<l.length;r++){var h=l[r];if(h){var u,p=100,g=t+d.NODE_TITLE_HEIGHT,v=c(h);try{for(v.s();!(u=v.n()).done;){var f=u.value;f.pos[0]=a,f.pos[1]=g,f.size[0]>p&&(p=f.size[0]),g+=f.size[1]+t+d.NODE_TITLE_HEIGHT}}catch(t){v.e(t)}finally{v.f()}a+=p+t}}this.setDirtyCanvas(!0,!0)}},{key:"getTime",value:function(){return this.globaltime}},{key:"getFixedTime",value:function(){return this.fixedtime}},{key:"getElapsedTime",value:function(){return this.elapsed_time}},{key:"sendEventToAllNodes",value:function(t,e,n){n=n||d.ALWAYS;var i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(var s=0,o=i.length;s<o;++s){var a=i[s];"Subgraph"!==a.constructor.name||"onExecute"===t?a[t]&&a.mode===n&&(void 0===e?a[t]():e&&e.constructor===Array?a[t].apply(a,l(e)):a[t](e)):a.mode===n&&a.sendEventToAllNodes(t,e,n)}}},{key:"sendActionToCanvas",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.list_of_graphcanvas){var n,i=c(this.list_of_graphcanvas);try{for(i.s();!(n=i.n()).done;){var s=n.value;s[t]&&s[t].apply(s,l(e))}}catch(t){i.e(t)}finally{i.f()}}}},{key:"add",value:function(t,e){if(t){if(t.constructor===C)return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,void this._version++;if(-1!==t.id&&this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=d.MAX_NUMBER_OF_NODES)throw new Error("LiteGraph: max number of nodes in a graph reached");return t.id&&-1!==t.id?this.last_node_id<t.id&&(this.last_node_id=t.id):t.id=++this.last_node_id,t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}}},{key:"remove",value:function(t){if("LGraphGroup"===t.constructor.name){var e=this._groups.indexOf(t);return-1!==e&&this._groups.splice(e,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var n=0;n<t.inputs.length;n++){null!=t.inputs[n].link&&t.disconnectInput(n)}if(t.outputs)for(var i=0;i<t.outputs.length;i++){var s=t.outputs[i];null!=s.links&&s.links.length&&t.disconnectOutput(i)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas){var o,a=c(this.list_of_graphcanvas);try{for(a.s();!(o=a.n()).done;){var r=o.value;r.selected_nodes[t.id]&&delete r.selected_nodes[t.id],r.node_dragged===t&&(r.node_dragged=null)}}catch(t){a.e(t)}finally{a.f()}}this._nodes.includes(t)&&(this._nodes=this._nodes.filter((function(e){return e!==t}))),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}}},{key:"getNodeById",value:function(t){return null==t?null:this._nodes_by_id[t]}},{key:"findNodesByClass",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.length=0;var n,i=c(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.constructor===t&&e.push(s)}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"findNodesByType",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t=t.toLowerCase(),(e=e||[]).length=0;var n,i=c(this._nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.type.toLowerCase()===t&&e.push(s)}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"findNodeByTitle",value:function(t){var e,n=c(this._nodes);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(i.title===t)return i}}catch(t){n.e(t)}finally{n.f()}return null}},{key:"findNodesByTitle",value:function(t){var e,n=[],i=c(this._nodes);try{for(i.s();!(e=i.n()).done;){var s=e.value;s.title===t&&n.push(s)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"getNodeOnPos",value:function(t,e){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodes,s=arguments.length>3?arguments[3]:void 0,o=c(i);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(a.isPointInside(t,e,s))return a}}catch(t){o.e(t)}finally{o.f()}return null}},{key:"getGroupOnPos",value:function(t,e){var n,i=c(this._groups);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.isPointInside(t,e,2,!0))return s}}catch(t){i.e(t)}finally{i.f()}return null}},{key:"checkNodeTypes",value:function(){var t,e=c(this._nodes);try{for(e.s();!(t=e.n()).done;){var n=t.value,i=d.registered_node_types[n.type];if(n.constructor!==i){console.log("node being replaced by newer version: ".concat(n.type));var s=x.createNode(n.type);n=s,s.configure(n.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,n.inputs&&(s.inputs=n.inputs.concat()),n.outputs&&(s.outputs=n.outputs.concat())}}}catch(t){e.e(t)}finally{e.f()}this.updateExecutionOrder()}},{key:"onAction",value:function(t,e){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);var n,i=c(this._input_nodes);try{for(i.s();!(n=i.n()).done;){var s=n.value;if(s.properties.name===t){s.onAction(t,e);break}}}catch(t){i.e(t)}finally{i.f()}}},{key:"trigger",value:function(t,e){this.onTrigger&&this.onTrigger(t,e)}},{key:"addInput",value:function(t,e,n){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())}},{key:"setInputData",value:function(t,e){var n=this.inputs[t];n&&(n.value=e)}},{key:"getInputData",value:function(t){var e=this.inputs[t];return e?e.value:null}},{key:"renameInput",value:function(t,e){if(e!==t){if(!this.inputs[t])return!1;if(this.inputs[e])return console.error("there is already one input with that newName"),!1;this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}}},{key:"changeInputType",value:function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()===String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))}},{key:"removeInput",value:function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"addOutput",value:function(t,e,n){this.outputs[t]={name:t,type:e,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},{key:"setOutputData",value:function(t,e){var n=this.outputs[t];n&&(n.value=e)}},{key:"getOutputData",value:function(t){var e=this.outputs[t];return e?e.value:null}},{key:"renameOutput",value:function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that newName"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))}},{key:"changeOutputType",value:function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()===String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))}},{key:"removeOutput",value:function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)}},{key:"triggerInput",value:function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].onTrigger(e)}},{key:"setCallback",value:function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].setTrigger(e)}},{key:"beforeChange",value:function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)}},{key:"afterChange",value:function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)}},{key:"connectionChange",value:function(t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")}},{key:"isLive",value:function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){if(this.list_of_graphcanvas[t].live_mode)return!0}return!1}},{key:"clearTriggeredSlots",value:function(){for(var t in this.links){var e=this.links[t];e&&(e._last_time&&(e._last_time=0))}}},{key:"change",value:function(){d.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)}},{key:"setDirtyCanvas",value:function(t,e){this.sendActionToCanvas("setDirty",[t,e])}},{key:"removeLink",value:function(t){var e=this.links[t];if(e){var n=this.getNodeById(e.target_id);n&&n.disconnectInput(e.target_slot)}}},{key:"serialize",value:function(){var t,e=[],n=c(this._nodes);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.push(i.serialize())}}catch(t){n.e(t)}finally{n.f()}var s=[];for(var o in this.links){var a=this.links[o];if(!a.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var r=new b;for(var l in a)r[l]=a[l];this.links[o]=r,a=r}s.push(a.serialize())}var h,u=[],p=c(this._groups);try{for(p.s();!(h=p.n()).done;){var g=h.value;u.push(g.serialize())}}catch(t){p.e(t)}finally{p.f()}var v={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:s,groups:u,config:this.config,extra:this.extra,version:d.VERSION};return this.onSerialize&&this.onSerialize(v),v}},{key:"configure",value:function(t,e){if(t){e||this.clear();var n=t.nodes;if(t.links&&t.links.constructor===Array){var i,s=[],o=c(t.links);try{for(o.s();!(i=o.n()).done;){var a=i.value;if(a){var r=new b;r.configure(a),s[r.id]=r}else console.warn("serialized graph link data contains errors, skipping.")}}catch(t){o.e(t)}finally{o.f()}t.links=s}for(var l in t)"nodes"!==l&&"groups"!==l&&(this[l]=t[l]);var h=!1;if(this._nodes=[],n){var u,p=c(n);try{for(p.s();!(u=p.n()).done;){var g=u.value,v=x.createNode(g.type,g.title);v||(d.debug&&console.log("Node not found or has errors: ".concat(g.type)),(v=new x).last_serialization=g,v.has_errors=!0,h=!0),v.id=g.id,this.add(v,!0)}}catch(t){p.e(t)}finally{p.f()}var f,_=c(n);try{for(_.s();!(f=_.n()).done;){var y=f.value,m=this.getNodeById(y.id);m&&m.configure(y)}}catch(t){_.e(t)}finally{_.f()}}if(this._groups.length=0,t.groups){var k,E=c(t.groups);try{for(E.s();!(k=E.n()).done;){var T=k.value,w=new C;w.configure(T),this.add(w)}}catch(t){E.e(t)}finally{E.f()}}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),h}}},{key:"load",value:function(t,e){var n=this;if(t.constructor===File||t.constructor===Blob){var i=new FileReader;return i.addEventListener("load",(function(t){var i=JSON.parse(t.target.result);n.configure(i),e&&e()})),void i.readAsText(t)}var s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.onload((function(){if(200===s.status){var t=JSON.parse(s.response);n.configure(t),e&&e()}else console.error("Error loading graph:",s.status,s.response)})),s.onerror((function(t){console.error("Error loading graph:",t)}))}},{key:"onNodeTrace",value:function(t,e,n){}}]),t}();r(H,"supportedTypes",["number","string","boolean"]);var z=function(){function t(e){s(this,t),this.points=e,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}return a(t,[{key:"sampleCurve",value:function(t,e){if(e){for(var n=0;n<e.length-1;++n){var i=e[n],s=e[n+1];if(!(s[0]<t)){var o=s[0]-i[0];if(Math.abs(o)<1e-5)return i[1];var a=(t-i[0])/o;return i[1]*(1-a)+s[1]*a}}return 0}}},{key:"draw",value:function(t,e,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#666",o=arguments.length>5?arguments[5]:void 0,a=this.points;if(a){this.size=e;var r=e[0]-2*this.margin,l=e[1]-2*this.margin;t.save(),t.translate(this.margin,this.margin),i&&(t.fillStyle="#111",t.fillRect(0,0,r,l),t.fillStyle="#222",t.fillRect(.5*r,0,1,l),t.strokeStyle="#333",t.strokeRect(0,0,r,l)),t.strokeStyle=s,o&&(t.globalAlpha=.5),t.beginPath();var h,u=c(a);try{for(u.s();!(h=u.n()).done;){var d=h.value;t.lineTo(d[0]*r,(1-d[1])*l)}}catch(t){u.e(t)}finally{u.f()}if(t.stroke(),t.globalAlpha=1,!o)for(var p=0;p<a.length;++p){var g=a[p];this.selected===p?t.fillStyle="#FFF":this.nearest===p?t.fillStyle="#DDD":t.fillStyle="#AAA",t.beginPath(),t.arc(g[0]*r,(1-g[1])*l,2,0,2*Math.PI),t.fill()}t.restore()}}},{key:"onMouseDown",value:function(t,e){var n=this.points;if(n&&!(t[1]<0)){var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=t[0]-this.margin,a=t[1]-this.margin,r=[o,a],l=30/e.ds.scale;if(this.selected=this.getCloserPoint(r,l),-1===this.selected){var h=[o/i,1-a/s];n.push(h),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(h),this.must_update=!0}return-1!==this.selected||void 0}}},{key:"onMouseMove",value:function(t,e){var n=this.points;if(n){var i=this.selected;if(!(i<0)){var s=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),a=[t[0]-this.margin,t[1]-this.margin],r=30/e.ds.scale;this._nearest=this.getCloserPoint(a,r);var l=n[i];if(l){var h=0===i||i===n.length-1;if(!h&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10))return n.splice(i,1),void(this.selected=-1);l[0]=h?0===i?0:1:w(s,0,1),l[1]=1-w(o,0,1),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(l),this.must_update=!0}}}}},{key:"onMouseUp",value:function(){return this.selected=-1,!1}},{key:"getCloserPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=this.points;if(!n)return-1;for(var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=n.length,a=[0,0],r=1e6,l=-1,h=0;h<o;++h){var u=n[h];a[0]=u[0]*i,a[1]=(1-u[1])*s,a[0],t[0];var c=vec2.distance(t,a);c>r||c>e||(l=h,r=c)}return l}}]),t}(),G=function(){function t(e,n){s(this,t),n=n||{};var i=document.createElement("div");this.root=i,i.className="litegraph litegraph-editor",i.innerHTML="<div class='content'><div class='editor-area'><canvas class='graphcanvas' width='1000' height='500' tabindex=10></canvas></div></div>",this.content=i.querySelector(".content"),this.footer=i.querySelector(".footer");var o=i.querySelector(".graphcanvas"),a=this.graph=new H,r=this.graphcanvas=new R(o,a);r.background_image="imgs/grid.png",a.onAfterExecute=function(){r.draw(!0)},r.onDropItem=this.onDropItem.bind(this),n.miniwindow&&this.addMiniWindow(300,200);var l=document.getElementById(e);l&&l.appendChild(i),r.resize()}return a(t,[{key:"onDropItem",value:function(t){var e,n=this,i=c(t.dataTransfer.files);try{for(i.s();!(e=i.n()).done;){var s=e.value,o=R.getFileExtension(s.name),a=new FileReader;"json"===o&&(a.onload=function(t){n.graph.configure(JSON.parse(t.target.result))},a.readAsText(s))}}catch(t){i.e(t)}finally{i.f()}}},{key:"addMiniWindow",value:function(t,e){var n=document.createElement("div");n.className="litegraph miniwindow",n.innerHTML="<canvas class='graphcanvas' width='".concat(t,"' height='").concat(e,"' tabindex=10></canvas>");var i=n.querySelector("canvas"),s=this,o=new R(i,this.graph);o.show_info=!1,o.background_image="imgs/grid.png",o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1,o.render_shadows=!1,o.max_zoom=.25,this.miniwindow_graphcanvas=o,o.onClear=function(){o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1},o.onRenderBackground=function(t,e){e.strokeStyle="#567";var n=s.graphcanvas.convertOffsetToCanvas([0,0]),i=s.graphcanvas.convertOffsetToCanvas([s.graphcanvas.canvas.width,s.graphcanvas.canvas.height]);n=this.convertCanvasToOffset(n),i=this.convertCanvasToOffset(i),e.lineWidth=1,e.strokeRect(Math.floor(n[0])+.5,Math.floor(n[1])+.5,Math.floor(i[0]-n[0]),Math.floor(i[1]-n[1]))},n.style.position="absolute",n.style.top="4px",n.style.right="4px";var a=document.createElement("div");a.className="corner-button",a.innerHTML="&#10060;",a.addEventListener("click",(function(t){o.setGraph(null),n.remove()})),n.appendChild(a),this.root.querySelector(".content").appendChild(n)}}]),t}();return"undefined"!=typeof CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.roundRect=function(t,e,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:5,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:s;this.moveTo(t+s,e),this.lineTo(t+n-s,e),this.quadraticCurveTo(t+n,e,t+n,e+s),this.lineTo(t+n,e+i-o),this.quadraticCurveTo(t+n,e+i,t+n-o,e+i),this.lineTo(t+o,e+i),this.quadraticCurveTo(t,e+i,t,e+i-o),this.lineTo(t,e+s),this.quadraticCurveTo(t,e,t+s,e)}),t.ContextMenu=O,t.CurveEditor=z,t.DragAndScale=N,t.Editor=G,t.LGraph=H,t.LGraphCanvas=R,t.LGraphGroup=C,t.LGraphNode=x,t.LLink=b,t.clamp=w,t.clearRegisteredTypes=function(){d.registered_node_types={},d.node_types_by_file_extension={},d.Nodes={},d.searchbox_extras={}},t.defaultConfig=d,t.distance=k,t.getNodeType=function(t){return d.registered_node_types[t]},t.getNodeTypesCategories=_,t.getNodeTypesInCategory=f,t.getParameterNames=y,t.isInsideRectangle=E,t.isValidConnection=m,t.overlapBounding=T,t.registerNodeType=v,t.registerSearchboxExtra=function(t,e,n){d.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:n}},t.unregisterNodeType=function(t){var e=t.constructor===String?d.registered_node_types[t]:t;if(!e)throw new Error("node type not found: ".concat(t));delete d.registered_node_types[e.type],e.constructor.name&&delete d.Nodes[e.constructor.name]},t.wrapFunctionAsNode=function(t,e,n,i,s){for(var o=Array(e.length),a=y(e),r=0;r<a.length;++r)"this.addInput('".concat(a[r],"',").concat(n&&n[r]?"'".concat(n[r],"'"):"0",");\n");"this.addOutput('out',".concat(i?"'".concat(i,"'"):0,");\n"),s&&"this.properties = ".concat(JSON.stringify(s),";\n");var l=Function("code");l.title=t.split("/").pop(),l.desc="Generated from ".concat(e.name),l.prototype.onExecute=function(){for(var t=0;t<o.length;++t)o[t]=this.getInputData(t);var n=e.apply(this,o);this.setOutputData(0,n)},v(t,l)},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
//# sourceMappingURL=litegraph.min.js.map
